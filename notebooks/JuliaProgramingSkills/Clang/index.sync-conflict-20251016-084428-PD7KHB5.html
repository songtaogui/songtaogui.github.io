
<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="google-site-verification" content="sKCEBeALSs13uui0cWMviq9hlm0rPByKQKNHnOdq-d0" />
    <meta name="baidu-site-verification" content="code-MBwKQgVpns" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Songtao Gui">

    
    <meta name="description" content="Clang.jl: wrapper for libclang
">
    

    
    
    <meta name="keywords" content="Clang">
    <title>Clang</title>
    

    <link rel="icon" href="/assets/favicon.svg">

    <!-- Dark mode -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>
    <script>
        function addDarkmodeWidget()
        {
            const options = {
                top: 'unset',
                bottom: 'unset', /* default: '32px' */
                right: 'unset', /* default: '32px' */
                left: '50px', /* default: 'unset' */
                time: '.0s', /* default: '0.3s' */
                mixColor: '#fff', /* default: '#fff' */
                backgroundColor: '#fff', /* default: '#fff' */
                buttonColorDark: '#100f2c', /* default: '#100f2c' */
                buttonColorLight: '#fff', /* default: '#fff' */
                saveInCookies: true, /* default: true, */
                label: '🌓', /* default: '' */
                autoMatchOsTheme: true /* default: true */
            };
            new Darkmode(options).showWidget();
        };
        window.addEventListener('DOMContentLoaded', addDarkmodeWidget);
    </script> -->
    
<link rel=preconnect href="https://fonts.gstatic.com" crossorigin=anonymous>
<link rel=stylesheet href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
    crossorigin=anonymous>
<link rel=stylesheet href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css"
    crossorigin=anonymous>
<link rel=stylesheet href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css" crossorigin=anonymous>
<link rel=stylesheet
    href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap"
    crossorigin=anonymous>
<!-- locally served -->
<link rel="stylesheet" href="/css/pure.css">
<link rel=stylesheet href="/libs/academic/academic.min.css">
<link rel="stylesheet" href="/css/layout.css">
<link rel="stylesheet" href="/css/extra.css">
<link rel=stylesheet href="/css/codeset.css">
<link rel=stylesheet href="/css/admonition.css">
<link rel=stylesheet href="/css/cv.css">
<link rel=stylesheet href="/css/search-box.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.css">
<link rel=stylesheet href="/css/vega.css">
<!-- <link rel=stylesheet href="/css/font-awesome.css"> -->

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!-- nutshell + highlight + katex + plotly -->


    <link rel=stylesheet href="/libs/highlight/styles/atom-one-light.min.css"> 




 
<!-- end for isnotdef revealslide -->


<!-- end for isdef revealslide -->
    <!-- Vega -->
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.0/dist/svg.min.js"></script>
    <style media="screen">
        /* Add space between Vega-Embed links  */
        .vega-actions a {
            margin-right: 5px;
        }
    </style>
    <!-- end Vega -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js"
        integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin=anonymous async></script>
</head>

<body id=top data-spy="scroll" data-offset="70" data-target=#navbar-main>
    <!-- Swiftype -->
    <script type="text/javascript">
        (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
        (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
        e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
        })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
        
        _st('install','J57vdqtTa8oYL-ikpKNG','2.0.0');
    </script>
    
     <!-- control the navbar of my blog -->
<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main>
    <div class=container>
        <!-- Main name -->
        <div class="d-none d-lg-inline-flex">
            <a class=navbar-brand href="/"><span class="cv-contact">
                <img class="cv-img" src="/assets/personal/namesign.svg">
            </span></a>
        </div>
        <!-- Button for narrow mode -->
        <button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar
            aria-expanded=false aria-label="Toggle navigation">
            <span><i class="fas fa-bars"></i></span>
        </button>
        <!-- Main name for mobile mode -->
        <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
            <a class=navbar-brand href="/"><span class="cv-contact">
                <img class="cv-img" src="/assets/personal/namesign.svg">
            </span></a>
        </div>
        <!-- Menu items -->
        <div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content>
            <ul class="navbar-nav d-md-inline-flex">
                <li class=nav-item><a class=nav-link href="/posts/"><span>Posts</span></a></li>
                <li class=nav-item><a class=nav-link href="/courses/"><span>Courses</span></a></li>
                <li class=nav-item><a class=nav-link href="/notebooks/"><span>Notebooks</span></a></li>
                <li class=nav-item><a class=nav-link href="/cv/"><span>CurriculumVitae</span></a></li>
                <li class=nav-item><a class=nav-link href="/tag/"><span>Tags</span></a></li>
            </ul>
        </div>
        <!-- <div class="nav-linksmall d-none d-lg-inline-flex inputBox">
                <input type="text" class="st-default-search-input" placeholder="Input then press ENTER" value="" required>
                <div class="search"></div>
            <script>
                var searchForm = document.getElementById('searchForm');
                searchForm.onsubmit = function () {
                    var url = this.action;
                    var q = this.children['q'].value;
                    var q = 'site:songtaogui.github.io+' + q
                    // var site = this.children['site'].value;
                    var url = url + '?q=' + q;
                    window.open(url,'__blank');
                    return false;
                };
            </script>
        </div> -->
        <!-- 基于bing site搜索: -->
        <div class="nav-linksmall d-none d-lg-inline-flex inputBox">
            <form action="https://bing.com/search" id="searchForm">
                <input type="text" name="q" value="" placeholder="Input then press ENTER" value="" required>
                <div class="search"></div>
            </form>
            <script>
                var searchForm = document.getElementById('searchForm');
                searchForm.onsubmit = function () {
                    var url = this.action;
                    var q = this.children['q'].value;
                    var q = 'site:songtaogui.github.io+' + q
                    // var site = this.children['site'].value;
                    var url = url + '?q=' + q;
                    window.open(url,'__blank');
                    return false;
                };
            </script>
        </div>
        <!-- <div class="nav-icon d-none d-lg-inline-flex"> -->
        <div class="nav-icon">
            <a class=nav-linksmall href="/giants" target="_blank"><span><img class="nav-img"
                src="/assets/img/giant.svg"></span></a>
            <a class=nav-linksmall href="/achievements/" target="_blank"><span><img class="nav-img"
                        src="/assets/img/achievement.svg"></span></a>
            <a class=nav-linksmall href="/feed.xml" target="_blank"><span><img class="nav-img"
                        src="/assets/img/rss.svg"></span></a>
            <a class=nav-linksmall href="/musics" target="_blank"><span><img class="nav-img"
                        src="/assets/img/music.svg"></span></a>
        </div>

    </div>
</nav> 

    <span class="js-widget-page d-none"></span>

    
    <article class=article>
        <div class="article-container pt-3">
             <h1>Clang</h1> 
        </div>
        
        <div class="article-container">
            <!-- 关闭article-style, 不然跟nutshell不兼容 -->
            <!-- <div class="gst-style"> -->
            <div class="layout-main">
                <!-- <div class="article-style"> -->
                
                
                <div class="franklin-content">
<div class="tags"><a href="/tag/" id="tag-icon"><svg width="20" height="20" viewBox="0 0 512 512"><defs><style>.cls-1{fill:#141f38}</style></defs><path class="cls-1" d="M215.8 512a76.1 76.1 0 0 1-54.17-22.44L22.44 350.37a76.59 76.59 0 0 1 0-108.32L242 22.44A76.11 76.11 0 0 1 296.2 0h139.2A76.69 76.69 0 0 1 512 76.6v139.19A76.08 76.08 0 0 1 489.56 270L270 489.56A76.09 76.09 0 0 1 215.8 512zm80.4-486.4a50.69 50.69 0 0 0-36.06 14.94l-219.6 219.6a51 51 0 0 0 0 72.13l139.19 139.19a51 51 0 0 0 72.13 0l219.6-219.61a50.67 50.67 0 0 0 14.94-36.06V76.6a51.06 51.06 0 0 0-51-51zm126.44 102.08A38.32 38.32 0 1 1 461 89.36a38.37 38.37 0 0 1-38.36 38.32zm0-51a12.72 12.72 0 1 0 12.72 12.72 12.73 12.73 0 0 0-12.72-12.76z"/><path class="cls-1" d="M217.56 422.4a44.61 44.61 0 0 1-31.76-13.16l-83-83a45 45 0 0 1 0-63.52L211.49 154a44.91 44.91 0 0 1 63.51 0l83 83a45 45 0 0 1 0 63.52L249.31 409.24a44.59 44.59 0 0 1-31.75 13.16zm-96.7-141.61a19.34 19.34 0 0 0 0 27.32l83 83a19.77 19.77 0 0 0 27.31 0l108.77-108.7a19.34 19.34 0 0 0 0-27.32l-83-83a19.77 19.77 0 0 0-27.31 0l-108.77 108.7z"/><path class="cls-1" d="M294.4 281.6a12.75 12.75 0 0 1-9-3.75l-51.2-51.2a12.8 12.8 0 0 1 18.1-18.1l51.2 51.2a12.8 12.8 0 0 1-9.05 21.85zM256 320a12.75 12.75 0 0 1-9.05-3.75l-51.2-51.2a12.8 12.8 0 0 1 18.1-18.1l51.2 51.2A12.8 12.8 0 0 1 256 320zM217.6 358.4a12.75 12.75 0 0 1-9-3.75l-51.2-51.2a12.8 12.8 0 1 1 18.1-18.1l51.2 51.2a12.8 12.8 0 0 1-9.05 21.85z"/></svg></a><a href="/tag/clang/">clang</a>, <a href="/tag/coding/">coding</a>, <a href="/tag/doc/">doc</a>, <a href="/tag/wrapper/">wrapper</a>&nbsp;&nbsp;&nbsp;&nbsp;<a id="tag-icon"><svg width="20" height="20" class="icon" viewBox="0 0 1024 1024" version="1.1" p-id="3825" width="64" height="64"><path d="M512 416a96 96 0 1 0 0 192 96 96 0 0 0 0-192z m511.952 102.064c-0.016-0.448-0.064-0.864-0.096-1.296a8.16 8.16 0 0 0-0.08-0.656c0-0.32-0.064-0.624-0.128-0.928-0.032-0.368-0.064-0.736-0.128-1.088-0.032-0.048-0.032-0.096-0.032-0.144a39.488 39.488 0 0 0-10.704-21.536c-32.672-39.616-71.536-74.88-111.04-107.072-85.088-69.392-182.432-127.424-289.856-150.8-62.112-13.504-124.576-14.064-187.008-2.64-56.784 10.384-111.504 32-162.72 58.784-80.176 41.92-153.392 99.696-217.184 164.48-11.808 11.984-23.552 24.224-34.288 37.248-14.288 17.328-14.288 37.872 0 55.216 32.672 39.616 71.52 74.848 111.04 107.056 85.12 69.392 182.448 127.408 289.888 150.784 62.096 13.504 124.608 14.096 187.008 2.656 56.768-10.4 111.488-32 162.736-58.768 80.176-41.936 153.376-99.696 217.184-164.48 11.792-12 23.536-24.224 34.288-37.248 5.712-5.872 9.456-13.44 10.704-21.568l0.032-0.128a12.592 12.592 0 0 0 0.128-1.088c0.064-0.304 0.096-0.624 0.128-0.928l0.08-0.656 0.096-1.28c0.032-0.656 0.048-1.296 0.048-1.952l-0.096-1.968zM512 704c-106.032 0-192-85.952-192-192s85.952-192 192-192 192 85.968 192 192c0 106.048-85.968 192-192 192z" p-id="3826"></path></svg></a><span id="busuanzi_value_page_pv"></span></div>
<div class="franklin-toc"><ol><li><a href="#快速开始">快速开始</a></li><li><a href="#生成器教程">生成器教程</a><ol><li><a href="#封装jll">封装JLL</a></li><li><a href="#创建默认生成器">创建默认生成器</a></li><li><a href="#跳过特定符号">跳过特定符号</a></li><li><a href="#输出前重写表达式">输出前重写表达式</a></li><li><a href="#多平台配置">多平台配置</a></li><li><a href="#类型对应">类型对应</a></li></ol></li><li><a href="#libclang教程">LibClang教程</a><ol><li><a href="#输出结构中的字段">输出结构中的字段</a></li><li><a href="#函数参数和类型">函数参数和类型</a></li></ol></li></ol></div>
<p>Clang.jl可以从C的头文件集合自动创建C代码库的julia包装器, 支持以下类型:</p>
<pre><code class="language-julia"># C      &#61;&gt; Julia
function &#61;&gt; ccal
struct   &#61;&gt; struct
enum     &#61;&gt; Enum, CEnum
union    &#61;&gt; struct
typedef  &#61;&gt; typealias of intrinsic type
# macro  &#40;limited support&#41;
# bitfiled &#40;experimental support&#41;</code></pre>
<h2 id="快速开始"><a href="#快速开始" class="header-anchor">快速开始</a></h2>
<p>以下示例根据输入的C语言头文件<code>include/clang-c/*.h</code>封装成<code>LibClang.jl</code>:</p>
<ol>
<li><p>编写配置文件<code>generator.toml</code></p>
</li>
</ol>
<pre><code class="language-toml">&#91;general&#93;
library_name &#61; &quot;libclang&quot;
output_file_path &#61; &quot;./LibClang.jl&quot;
module_name &#61; &quot;LibClang&quot;
jll_pkg_name &#61; &quot;Clang_jll&quot;
export_symbol_prefixes &#61; &#91;&quot;CX&quot;, &quot;clang_&quot;&#93;</code></pre>
<ol start="2">
<li><p>加载配置文件, 生成封装器</p>
</li>
</ol>
<pre><code class="language-julia">using Clang.Generators
using Clang.LibClang.Clang_jill

cd&#40;@__DIR__&#41;

include_dir &#61; normpath&#40;Clang_jll.artifact_dir, &quot;include&quot;&#41;
clang_dir &#61; joinpath&#40;include_dir, &quot;clang-c&quot;&#41;

options &#61; load_options&#40;joinpath&#40;@__DIR__, &quot;generator.toml&quot;&#41;&#41;
args &#61; get_default_args&#40;&#41;
push&#33;&#40;args, &quot;-I&#36;include_dir&quot;&#41;

headers &#61; &#91;joinpath&#40;clang_dir, header&#41; for header in readdir&#40;clang_dir&#41; if endwith&#40;header, &quot;.h&quot;&#41;&#93;
# headers &#61; detect_headers&#40;clang_dir, args&#41;

ctx &#61; create_context&#40;headers, args, options&#41;

build&#33;&#40;ctx&#41;</code></pre>
<h2 id="生成器教程"><a href="#生成器教程" class="header-anchor">生成器教程</a></h2>
<h3 id="封装jll"><a href="#封装jll" class="header-anchor">封装JLL</a></h3>
<p><code>Clang.jl</code>的最常用场景是将Julia接口导出到由JLL包管理的C库, JLL包提供了一个共享库, 可以使用<code>ccall</code>语法进行调用。 包装JLL包的一般流程:</p>
<ol>
<li><p>定位C头文件</p>
</li>
<li><p>查找编译器标记</p>
</li>
<li><p>使用生成器创建一个<code>.toml</code>文件</p>
</li>
<li><p>用上述三个信息进行构建</p>
</li>
<li><p>测试</p>
</li>
</ol>
<h3 id="创建默认生成器"><a href="#创建默认生成器" class="header-anchor">创建默认生成器</a></h3>
<code>Generator &#61; Headers &#43; Compiler flags &#43; Generator options</code>
<p>Generator option toml 文件的示例和说明:</p>
<fieldset class="code code-plain"><legend class="code-legend code-legend-plain">plain</legend></p>
<pre><code class="language-plaintext">&#91;general&#93;
# it could also be an expression as long as &#96;Meta.parse&#96; can parse this string successfully.
# basically, it should be the &#96;expression&#96; in the following code:
# ccall&#40;&#40;function_name, expression&#41;, returntype, &#40;argtype1, ...&#41;, argvalue1, ...&#41;
library_name &#61; &quot;libclang&quot;

# this entry allows you to specify different library names for different headers.
# in the following example:
# library_names &#61; &#123;&quot;config.h&quot; &#61; &quot;libclang_config&quot;, &quot;libclang_p.*.h&quot; &#61; &quot;libclang_patch&quot;&#125;
# those functions in the &#96;config.h&#96; will be generated as:
# ccall&#40;&#40;function_name, libclang_config&#41;, returntype, &#40;argtype1, ...&#41;, argvalue1, ...&#41;
library_names &#61; &#123;&#125;

# output file path relative to the working directory
output_file_path &#61; &quot;LibClang.jl&quot;

# if these are set, common file &#40;types and constants&#41; and API file &#40;functions&#41; will be separated
# this is for compatibility, so prologue and epilogue are not supported.
# output_api_file_path &#61; &quot;api.jl&quot;
# output_common_file_path &#61; &quot;common.jl&quot;

# if this entry is not empty, the generator will print the code below to the &#96;output_file_path&#96;.
# module module_name
#
# end # module
module_name &#61; &quot;LibClang&quot;

# if this entry is not empty, the generator will print the code below to the &#96;output_file_path&#96;.
# using jll_pkg_name
# export jll_pkg_name
jll_pkg_name &#61; &quot;Clang_jll&quot;

# for packages that have extra JLL package dependencies
jll_pkg_extra &#61; &#91;&#93;

# identifiers that starts with the string listed in this entry will be exported.
export_symbol_prefixes &#61; &#91;&quot;CX&quot;, &quot;clang_&quot;&#93;

# the code in the following file will be copy-pasted to &#96;output_file_path&#96; before the generated code.
# this is often used for applying custom patches, e.g. adding missing definitions.
prologue_file_path &#61; &quot;./prologue.jl&quot;

# the code in the following file will be copy-pasted to &#96;output_file_path&#96; after the generated code.
# this is often used for applying custom patches.
epilogue_file_path &#61; &quot;&quot;

# node with an id in the &#96;output_ignorelist&#96; will be ignored in the printing passes.
# this is very useful for custom editing.
output_ignorelist &#61; &#91;
    &quot;CINDEX_EXPORTS&quot;,
    &quot;CINDEX_VERSION&quot;,
    &quot;CINDEX_VERSION_STRING&quot;,
    &quot;CINDEX_LINKAGE&quot;,
    &quot;CINDEX_DEPRECATED&quot;,
    &quot;LLVM_CLANG_C_STRICT_PROTOTYPES_BEGIN&quot;,
    &quot;LLVM_CLANG_C_STRICT_PROTOTYPES_END&quot;,
    &quot;LLVM_CLANG_C_EXTERN_C_BEGIN&quot;,
    &quot;LLVM_CLANG_C_EXTERN_C_END&quot;
&#93;

# Julia&#39;s &#96;@enum&#96; do not allow duplicated values, so by default, C enums are translated to
# CEnum.jl&#39;s &#96;@cenum&#96;.
# if this entry is true, &#96;@enum&#96; is used and those duplicated enum constants are just commented.
use_julia_native_enum_type &#61; false

# use &#96;@cenum&#96; but do not print &#96;using CEnum&#96;.
# this is useful in the case of using &#96;CEnum&#96; directly in the source tree instead of using &#96;CEnum&#96; as a dependency
print_using_CEnum &#61; true

# Print enums directly as integers without @&#40;c&#41;enum wrapper
# Override above two options
print_enum_as_integer &#61; false

# use deterministic symbol instead of &#96;gensym&#96;-generated &#96;var&quot;##XXX&quot;&#96;
use_deterministic_symbol &#61; true

# by default, only those declarations in the local header file are processed.
# those declarations in the system headers will be treated specially and will be generated if necessary.
# if you&#39;d like to generate all of the symbols in the system headers, please set this option to false.
is_local_header_only &#61; true

# if this option is set to true, C code with a style of
# &#96;&#96;&#96;c
# typedef struct &#123;
#     int x;
# &#125; my_struct;
# &#96;&#96;&#96;
# will be generated as:
# &#96;&#96;&#96;julia
# struct my_struct
#     x::Cint
# end
# &#96;&#96;&#96;
# instead of
# &#96;&#96;&#96;julia
# struct var&quot;##Ctag#NUM&quot;
#     x::Cint
# end
# const my_struct &#61; var&quot;##Ctag#NUM&quot;
# &#96;&#96;&#96;
smart_de_anonymize &#61; true

# if set to true, static functions will be ignored
skip_static_functions &#61; false

# EXPERIMENTAL
# if this option is set to true, those structs that are not necessary to be an
# immutable struct will be generated as a mutable struct.
# this option is default to false, do read the paragraph below before using this feature.
auto_mutability &#61; false

# add inner constructor &#96;Foo&#40;&#41; &#61; new&#40;&#41;&#96;
auto_mutability_with_new &#61; true

# if you feel like certain structs should not be generated as mutable struct, please add them in the following list.
# for example, if a C function accepts a &#96;Vector&#96; of some type as its argument like:
#     void foo&#40;mutable_type *list, int n&#41;;
# when calling this function via &#96;ccall&#96;, passing a &#96;Vector&#123;mutable_type&#125;&#40;undef, n&#41;&#96; to the first
# argument will trigger a crash, the reason is mutable structs are not stored inline within a &#96;Vector&#96;,
# one should use &#96;Ref&#123;NTuple&#123;n,mutable_type&#125;&#125;&#40;&#41;&#96; instead.
# this is not convenient and that&#39;s where the &#96;auto_mutability_ignorelist&#96; comes in.
auto_mutability_ignorelist &#61; &#91;&#93;

# opposite to &#96;auto_mutability_ignorelist&#96; and has a higher priority
auto_mutability_includelist &#61; &#91;&#93;

# if set to &quot;raw&quot;, extract and dump raw c comment;
# if set to &quot;doxygen&quot;, parse and format doxygen comment.
# note: by default, Clang only parses doxygen comment, pass &#96;-fparse-all-comments&#96; to Clang in order to parse non-doxygen comments.
extract_c_comment_style &#61; &quot;doxygen&quot;

# Pass a function to explicitly generate documentation. It will be called like
# &#96;callback_documentation&#40;node::ExprNode&#41;&#96; if &#96;extract_c_comment_style&#96; is not
# set, or if it is set and no docs were found automatically.
#
# Do *not* set this in the TOML file, it should be set in the generator script
# to a function that takes in an ExprNode and returns a String&#91;&#93; &#40;string
# vector&#41;.
# callback_documentation &#61; &quot;&quot;

# if set to true, single line comment will be printed as &quot;&quot;&quot;comment&quot;&quot;&quot; instead of &quot;&quot;&quot;\ncomment\n&quot;&quot;&quot;
fold_single_line_comment &#61; false

# if set to &quot;outofline&quot;, documentation of struct fields will be collected at the &quot;Fields&quot; section of the struct
# if set to &quot;inline&quot;, documentation of struct fields will go right above struct definition
struct_field_comment_style &#61; &quot;outofline&quot;

# if set to &quot;outofline&quot;, documentation of enumerators will be collected at the &quot;Enumerators&quot; section of the enum
enumerator_comment_style &#61; &quot;outofline&quot;

# if set to true, C function prototype will be included in documentation
show_c_function_prototype &#61; false

&#91;codegen&#93;
# map C&#39;s bool to Julia&#39;s Bool instead of &#96;Cuchar&#96; a.k.a &#96;UInt8&#96;.
use_julia_bool &#61; true

# set this to true if the C routine always expects a NUL-terminated string.
# TODO: support filtering
always_NUL_terminated_string &#61; true

# generate strictly typed function
is_function_strictly_typed &#61; false

# if true, opaque pointers in function arguments will be translated to &#96;Ptr&#123;Cvoid&#125;&#96;.
opaque_func_arg_as_PtrCvoid &#61; false

# if true, opaque types are translated to &#96;mutable struct&#96; instead of &#96;Cvoid&#96;.
opaque_as_mutable_struct &#61; true

# if true, use Julia 1.5&#39;s new &#96;@ccall&#96; macro
use_ccall_macro &#61; true

# if true, variadic functions are wrapped with &#96;@ccall&#96; macro. Otherwise variadic functions are ignored.
wrap_variadic_function &#61; false

# generate getproperty/setproperty&#33; methods for the types in the following list
field_access_method_list &#61; &#91;&#93;

# the generator will prefix the function argument names in the following list with a &quot;_&quot; to
# prevent the generated symbols from conflicting with the symbols defined and exported in Base.
function_argument_conflict_symbols &#61; &#91;&#93;

# emit constructors for all custom-layout structs like bitfield in the list,
# or set to &#96;true&#96; to do so for all such structs
add_record_constructors &#61; &#91;&#93;

&#91;codegen.macro&#93;
# it‘s highly recommended to set this entry to &quot;basic&quot;.
# if you&#39;d like to skip all of the macros, please set this entry to &quot;disable&quot;.
# if you&#39;d like to translate function-like macros to Julia, please set this entry to &quot;aggressive&quot;.
macro_mode &#61; &quot;basic&quot;

# function-like macros in the following list will always be translated.
functionlike_macro_includelist &#61; &#91;
    &quot;CINDEX_VERSION_ENCODE&quot;,
&#93;

# if true, the generator prints the following message as comments.
# &quot;# Skipping MacroDefinition: ...&quot;
add_comment_for_skipped_macro &#61; true

# if true, ignore any macros that is suffixed with &quot;_H&quot; or in the &#96;ignore_header_guards_with_suffixes&#96; list
ignore_header_guards &#61; true
ignore_header_guards_with_suffixes &#61; &#91;&#93;

# if true, ignore those pure definition macros in the C code
ignore_pure_definition &#61; true</code></pre>
<p><div class="code-lag">plain</div></fieldset>
<h3 id="跳过特定符号"><a href="#跳过特定符号" class="header-anchor">跳过特定符号</a></h3>
<p>C头文件中可能有一些符号不能正确地被<code>Clang.jl</code>处理, 此时可以选择跳过这些内容, 并可以在后续用<code>prologue_file_path</code>指定<code>prologue</code>进行回填:</p>
<ul>
<li><p>在<code>output_ignorelist</code>中添加symbol, 从而跳过它的封装;</p>
</li>
<li><p>如果symbol位于系统头文件, 导致Clang.jl在输出前报错, 需要在生成前添加<code>@add_def symbol_name</code>从而禁止封装, 并在Clang.jl的github中post issue;</p>
</li>
</ul>
<h3 id="输出前重写表达式"><a href="#输出前重写表达式" class="header-anchor">输出前重写表达式</a></h3>
<p>Clang.jl封装实际上分为封装过程和输出过程两部分, 因此封装的表达式在输出到文件之前, 是可以被修改的, 只需要分开执行两部分步骤:</p>
<pre><code class="language-julia"># 只封装 不输出
build&#33;&#40;ctx, BULDSTAGE_NO_PRINTING&#41;

# 自定义重写规则
function rewrite&#33;&#40;e::Expr&#41; end
function rewrite&#33;&#40;daag::ExprDAG&#41;
    for node in get_nodes&#40;dag&#41;
        for expr in get_exprs&#40;node&#41;
            rewrite&#33;&#40;expr&#41;
        end
    end
end

rewrite&#33;&#40;ctx,dag&#41;

# 输出
build&#33;&#40;ctx, BUILDSTAGE_PRINTING_ONLY&#41;</code></pre>
<h3 id="多平台配置"><a href="#多平台配置" class="header-anchor">多平台配置</a></h3>
<ul>
<li><p>当一些数据类型可能与系统相关时, 可以跳过, 然后手动重新添加;</p>
</li>
<li><p>如果差异太大无法手动修复, 可以为每个平台生成封装, 如<a href="https://github.com/Gnimuc/LibClang.jl/blob/v0.61.0/gen/generator.jl" target="_blank" rel="noopener noreferrer"> LibClang.jl</a>中所示</p>
</li>
</ul>
<h3 id="类型对应"><a href="#类型对应" class="header-anchor">类型对应</a></h3>
<table><tr><th align="left">C type</th><th align="left">ccall signature</th><th align="left">Julia type</th></tr><tr><td align="left">Int/Float</td><td align="left">the same</td><td align="left">the sam</td></tr><tr><td align="left">Struct T</td><td align="left">在julia中构造一个同样结构的T</td><td align="left">T</td></tr><tr><td align="left">Pointer&#40;T*&#41;</td><td align="left">Ref&#123;T&#125;/Ptr&#123;T&#125;</td><td align="left">Ref&#123;T&#125;/Ptr&#123;T&#125;/array</td></tr><tr><td align="left">Strin&#40;char*&#41;</td><td align="left">Cstring/Ptr&#123;Cchar&#125;</td><td align="left">String</td></tr></table>
<ul>
<li><p><code>Ref</code>在Julia中是抽象类型, 不能直接传递给C</p>
</li>
<li><p>如果要将Julia的字符串或数组传递给C, 需要将类型注释为<code>Ptr&#123;T&#125;</code>, 否则传递的是类型信息而不是buffer中的内容结构, 有两种方法能实现:</p>
<ol>
<li><p>用<code>@ccall</code>: <code>@ccal printf&#40;&quot;&#37;s\n&quot;; &quot;hello&quot;::Cstring&#41;::Cint</code></p>
</li>
<li><p>重载<code>to_c_type</code>从而将Julia类型映射到对应的call signature类型: 将<code>to_c_type&#40;::Type&#123;String&#125;&#41; &#61; Cstring</code>添加到prologue信息中, 之后所有的<code>String</code>都将被注释为<code>Cstring</code>:</p>
</li>
</ol>
</li>
</ul>
<div class="indent-block" style="margin-left: 4em !important"></p>
<pre><code class="language-julia">to_c_type&#40;::Type&#123;&lt;:AbstractString&gt;&#125;&#41; &#61; Cstring # 或者 Ptr&#123;Cchar&#125;
to_c_type&#40;t::Type&#123;&lt;:Union&#123;AbstractArray, Ref&#125;&#125;&#41; &#61; Ptr&#123;eltype&#40;t&#41;&#125;</code></pre>
<p></div>
<h2 id="libclang教程"><a href="#libclang教程" class="header-anchor">LibClang教程</a></h2>
<p>Clang是基于LLVM框架的开源编译器, 是现代化的C, C&#43;&#43;和Objective-C编译器, Clang和LLVM是用C&#43;&#43;写的, 但是Clang项目维护了一个名为<code>libclang</code>的C接口, 提供对AST和类型表示的访问。</p>
<p>Clang.jl封装了<code>libclang</code>, 并提供了一个<code>C&#61;&gt;Julia</code>的封装生成器</p>
<p>下面通过一个示例头文件的封装来说明:</p>
<pre><code class="language-C">//example.h
struct ExStruct &#123;
    int    kind;
    char*  name;
    float* data;
&#125;;

void* ExFunction &#40;int kind, char* name, float* data&#41;&#123;
    struct ExStruct st;
    st.kind &#61; kind;
    st.name &#61; name;
    st.data &#61; data;
&#125;</code></pre>
<h3 id="输出结构中的字段"><a href="#输出结构中的字段" class="header-anchor">输出结构中的字段</a></h3>
<p>用Clang.jl解析上述结构只需要几行代码: </p>
<pre><code class="language-julia">using Clang
trans_unit &#61; Clang.parse_header&#40;Index&#40;&#41;, &quot;example.h&quot;&#41;
root_cursor &#61; Clang.getTranslationUnitCursor&#40;trans_unit&#41;
struct_cursor &#61; search&#40;root_cursor, &quot;ExStruct&quot;&#41; |&gt; only

# test
for c in children&#40;struct_cursor&#41;
    println&#40;&quot;Cursor:&quot;, c, 
            &quot;\n Kind: &quot;, kind&#40;c&#41;, 
            &quot;\n Name: &quot;, name&#40;c&#41;, 
            &quot;\n Type: &quot;, Clang.getCursorType&#40;c&#41;&#41;
end</code></pre>
<p><code>trans_unit</code>存储了一个<code>TranslationUnit</code>类型的libclang AST接口, 用指针节点的DAG表示, 包含三个基本信息:</p>
<ul>
<li><p>Kind: 指针节点的用途</p>
</li>
<li><p>Type: 指针指向的对象类型</p>
</li>
<li><p>Children: 子节点列表</p>
</li>
</ul>
<p><code>root_cursor</code>是<code>TranslationUnit</code>的根指针。 Clang.jl中, <code>CLCursor</code>定义了指针的抽象类型, 所有指针都由其派生, 在底层实现时, 每个指针<code>CXCursor</code>和类型都是<code>enum</code>&#40;可枚举的&#41;数值, 用来自动将指针与Julia类型进行映射。因此, 可以针对CLCursor或CLType变量编写多重派发的方法。</p>
<pre><code class="language-julia">dump&#40;root_cursor&#41;
dump&#40;Clang.LibClang.CXCursorKind&#41; # 指针类型被翻译成Cenum

# 访问指针子节点的两种方法:
# chrildren&#40;&#41;: 返回子节点迭代器
children&#40;struct_cursor&#41;

# search&#40;&#41;: 返回一个子节点列表, 大部分情况应该只输出一个子节点, 所以可以配合only&#40;&#41;函数做校验
search&#40;root_cursor, &quot;ExStruct&quot;&#41;</code></pre>
<p>每个<code>CLFieldDecl</code>指针都有一个关联的<code>CLType</code>对象, 可以用<code>type&#40;&#41;</code>函数查询。</p>
<h3 id="函数参数和类型"><a href="#函数参数和类型" class="header-anchor">函数参数和类型</a></h3>
<p>要找到上述<code>example.h</code>中的<code>ExFunction</code>函数指针, 检索<code>CXCursor_FunctionDecl</code>指针类型的节点:</p>
<pre><code class="language-julia">using Clang.LibClang
fdecl &#61; search&#40;root_cursor, CXCursor_FunctionDecl&#41; |&gt; only

fdecl_children &#61; &#91; c for c in children&#40;fdecl&#41;&#93;</code></pre>
<div class="aadmon aadmon-hack"> 有关libclang提供的所有<code>CLCursor</code>和<code>CLType</code>的信息, 参阅<a href="http://clang.llvm.org/doxygen/group__CINDEX.html" target="_blank" rel="noopener noreferrer"> libclang文档</a></div>


</div>
<!-- article style -->


 <!-- add comments to page -->
<hr>
<script src="https://utteranc.es/client.js"
    repo="songtaogui/blog_comments"
    issue-term="pathname"
    theme="github-light"
    crossorigin="anonymous"
    async>
</script>

<hr> 

<div class="container">
    
    <footer class="site-footer">
        <p class="powered-by">
          <script type="text/javascript" src="//rf.revolvermaps.com/0/0/4.js?i=5jnkqismgmy&amp;m=5&amp;h=128&amp;c=baff00&amp;r=0" async="async"></script><br>
            Total visits: <span id="busuanzi_value_site_pv"></span>.<br>
            Built with <a href="https://franklinjl.org" target="_blank" rel="noopener">Franklin.jl</a> and <a
                href="https://julialang.org" target="_blank" rel="noopener">Julia</a>.<br>
            Texts are licensed under <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>.<br>
            Codes are licensed under the <a href="https://mit-license.org/">MIT License</a>.<br>
            <strong>&copy; Songtao Gui</strong>. Last modified: January 02, 2024.
          </p>
    </footer>
    
</div>
</div><!-- control the foot of the page, dynamic load related scripts based on variables in md head -->





</div>

<!--article container -->
</article>


<!-- CONTENT ENDS HERE -->

 <!-- seperate highlight.js so that I can control it with 'hascode=true' in the md file -->
<script src="/libs/highlight/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();hljs.configure({tabReplace: '    '});</script>
 

<script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js
    integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js
    integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js
    integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script>
<script src="/libs/academic/academic.min.js"></script>
<script src="/libs/pure/ui.js"></script>

</body>

 <!-- add back to top button to the end of the page -->
<a class="js-back-to-top back-to-top-button" href="#">
    <img src="/assets/img/up.svg" style="width: 100px;">
</a>
<!-- <button class="js-back-to-top back-to-top-button" title="BackToTop">︽</button> -->
<script src="https://cdn.staticfile.org/jquery/2.2.4/jquery.min.js"></script>
<script>
    $(function () {
        var $win = $(window);
        var $backToTop = $('.js-back-to-top');
        // show the button when the user scrolls past 100 pixels
        $win.scroll(function () {
            if ($win.scrollTop() > 100) {
                $backToTop.show();
            } else {
                $backToTop.hide();
            }
        });
        // when the user clicks on the button, scroll to the top of the document
        $backToTop.click(function () {
            $('html, body').animate({
                scrollTop: 0
            }, 200);
        });
    });
</script>
<style>
    /* back to top button */
    .back-to-top-button {
        display: none;
        position: fixed;
        width: 50px;
        bottom: 3%;
        right: 3%;
        z-index: 99;
        font-size: 15px;
        border: 0px solid #696969;
        background-color: #fff;
        color: #222222;
        outline: none;
        cursor: pointer;
        padding: 7px;
        border-radius: 40px;
    }

    .back-to-top-button:hover {
        background-color: #c0dbf5;
        color: #fff;
    }
</style> 


</html>



