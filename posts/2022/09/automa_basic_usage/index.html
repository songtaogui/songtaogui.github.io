
<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="google-site-verification" content="sKCEBeALSs13uui0cWMviq9hlm0rPByKQKNHnOdq-d0" />
    <meta name="baidu-site-verification" content="code-MBwKQgVpns" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Songtao Gui">

    
    <meta name="description" content="Learn how to write parser using automa!
">
    

    
    
    <meta name="keywords" content="Automa.jl basic usage">
    <title>Automa.jl basic usage</title>
    

    <link rel="icon" href="/assets/favicon.svg">

    
<link rel=preconnect href="https://fonts.gstatic.com" crossorigin=anonymous>
<link rel=stylesheet href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
    crossorigin=anonymous>
<link rel=stylesheet href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css"
    crossorigin=anonymous>
<link rel=stylesheet href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css" crossorigin=anonymous>
<link rel=stylesheet
    href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap"
    crossorigin=anonymous>
<!-- locally served -->
<link rel="stylesheet" href="/css/pure.css">
<link rel=stylesheet href="/libs/academic/academic.min.css">
<link rel="stylesheet" href="/css/layout.css">
<link rel="stylesheet" href="/css/extra.css">
<link rel=stylesheet href="/css/codeset.css">
<link rel=stylesheet href="/css/admonition.css">
<link rel=stylesheet href="/css/cv.css">
<link rel=stylesheet href="/css/search-box.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.css">
<!-- <link rel=stylesheet href="/css/font-awesome.css"> -->

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!-- nutshell + highlight + katex + plotly -->
<script src="/libs/nutshell/nutshell.js"></script>
<link rel=stylesheet href="/libs/highlight/styles/atom-one-light.min.css">






    <!-- Vega -->
    <script src="https://cdn.jsdelivr.net/npm/vega@5.22.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.5.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.21.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.0/dist/svg.min.js"></script>
    <style media="screen">
        /* Add space between Vega-Embed links  */
        .vega-actions a {
          margin-right: 5px;
        }
    </style>
    <!-- end Vega -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js"
        integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin=anonymous async></script>
</head>

<body id=top data-spy="scroll" data-offset="70" data-target=#navbar-main>

     <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main>
    <div class=container>
        <!-- Main name -->
        <div class="d-none d-lg-inline-flex">
            <a class=navbar-brand href="/">Songtao Gui</a>
        </div>
        <!-- Button for narrow mode -->
        <button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar
            aria-expanded=false aria-label="Toggle navigation">
            <span><i class="fas fa-bars"></i></span>
        </button>
        <!-- Main name for mobile mode -->
        <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
            <a class=navbar-brand href="/">Songtao Gui</a>
        </div>
        <!-- Menu items -->
        <div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content>
            <ul class="navbar-nav d-md-inline-flex">
                <li class=nav-item><a class=nav-link href="/posts/"><span>Posts</span></a></li>
                <li class=nav-item><a class=nav-link href="/courses/"><span>Courses</span></a></li>
                <li class=nav-item><a class=nav-link href="/notebooks/"><span>Notebooks</span></a></li>
                <li class=nav-item><a class=nav-link href="/cv/"><span>CurriculumVitae</span></a></li>
                <li class=nav-item><a class=nav-link href="/tag/"><span>Tags</span></a></li>
            </ul>
        </div>
        <div class="nav-linksmall d-none d-lg-inline-flex inputBox">
            <form action="https://bing.com/search" id="searchForm">
                <input type="text" name="q" value="" placeholder="Input then press ENTER" value="" required>
                <div class="search"></div>
            </form>
            <script>
                var searchForm = document.getElementById('searchForm');
                searchForm.onsubmit = function () {
                    var url = this.action;
                    var q = this.children['q'].value;
                    var q = 'site:songtaogui.github.io+' + q
                    // var site = this.children['site'].value;
                    var url = url + '?q=' + q;
                    window.open(url,'__blank');
                    return false;
                };
            </script>
        </div>
        <div class="nav-icon d-none d-lg-inline-flex">
            <a class=nav-linksmall href="/giants" target="_blank"><span><img class="nav-img"
                src="/assets/img/giant.svg"></span></a>
            <a class=nav-linksmall href="/achievements/" target="_blank"><span><img class="nav-img"
                        src="/assets/img/achievement.svg"></span></a>
            <a class=nav-linksmall href="/feed.xml" target="_blank"><span><img class="nav-img"
                        src="/assets/img/rss.svg"></span></a>
        </div>
        <div class="nav-icon ">
            <a class=nav-linksmall href="/musics" target="_blank"><span><img class="nav-img"
                        src="/assets/img/music.svg"></span></a>
        </div>

    </div>
</nav> 

    <span class="js-widget-page d-none"></span>

    
    <article class=article>
        <div class="article-container pt-3">
             <h1>Automa.jl basic usage</h1> 
        </div>
        
        <div class="article-container">
            <!-- ÂÖ≥Èó≠article-style, ‰∏çÁÑ∂Ë∑ünutshell‰∏çÂÖºÂÆπ -->
            <!-- <div class="gst-style"> -->
            <div class="layout-main">
                <!-- <div class="article-style"> -->
                
                
                <div class="franklin-content">
<div class="tags"><a href="/tag/" id="tag-icon"><svg width="20" height="20" viewBox="0 0 512 512"><defs><style>.cls-1{fill:#141f38}</style></defs><path class="cls-1" d="M215.8 512a76.1 76.1 0 0 1-54.17-22.44L22.44 350.37a76.59 76.59 0 0 1 0-108.32L242 22.44A76.11 76.11 0 0 1 296.2 0h139.2A76.69 76.69 0 0 1 512 76.6v139.19A76.08 76.08 0 0 1 489.56 270L270 489.56A76.09 76.09 0 0 1 215.8 512zm80.4-486.4a50.69 50.69 0 0 0-36.06 14.94l-219.6 219.6a51 51 0 0 0 0 72.13l139.19 139.19a51 51 0 0 0 72.13 0l219.6-219.61a50.67 50.67 0 0 0 14.94-36.06V76.6a51.06 51.06 0 0 0-51-51zm126.44 102.08A38.32 38.32 0 1 1 461 89.36a38.37 38.37 0 0 1-38.36 38.32zm0-51a12.72 12.72 0 1 0 12.72 12.72 12.73 12.73 0 0 0-12.72-12.76z"/><path class="cls-1" d="M217.56 422.4a44.61 44.61 0 0 1-31.76-13.16l-83-83a45 45 0 0 1 0-63.52L211.49 154a44.91 44.91 0 0 1 63.51 0l83 83a45 45 0 0 1 0 63.52L249.31 409.24a44.59 44.59 0 0 1-31.75 13.16zm-96.7-141.61a19.34 19.34 0 0 0 0 27.32l83 83a19.77 19.77 0 0 0 27.31 0l108.77-108.7a19.34 19.34 0 0 0 0-27.32l-83-83a19.77 19.77 0 0 0-27.31 0l-108.77 108.7z"/><path class="cls-1" d="M294.4 281.6a12.75 12.75 0 0 1-9-3.75l-51.2-51.2a12.8 12.8 0 0 1 18.1-18.1l51.2 51.2a12.8 12.8 0 0 1-9.05 21.85zM256 320a12.75 12.75 0 0 1-9.05-3.75l-51.2-51.2a12.8 12.8 0 0 1 18.1-18.1l51.2 51.2A12.8 12.8 0 0 1 256 320zM217.6 358.4a12.75 12.75 0 0 1-9-3.75l-51.2-51.2a12.8 12.8 0 1 1 18.1-18.1l51.2 51.2a12.8 12.8 0 0 1-9.05 21.85z"/></svg></a><a href="/tag/automa/">automa</a>, <a href="/tag/bioinformatics/">bioinformatics</a>, <a href="/tag/julia/">julia</a>&nbsp;&nbsp;&nbsp;&nbsp;<a id="tag-icon"><svg width="20" height="20" class="icon" viewBox="0 0 1024 1024" version="1.1" p-id="3825" width="64" height="64"><path d="M512 416a96 96 0 1 0 0 192 96 96 0 0 0 0-192z m511.952 102.064c-0.016-0.448-0.064-0.864-0.096-1.296a8.16 8.16 0 0 0-0.08-0.656c0-0.32-0.064-0.624-0.128-0.928-0.032-0.368-0.064-0.736-0.128-1.088-0.032-0.048-0.032-0.096-0.032-0.144a39.488 39.488 0 0 0-10.704-21.536c-32.672-39.616-71.536-74.88-111.04-107.072-85.088-69.392-182.432-127.424-289.856-150.8-62.112-13.504-124.576-14.064-187.008-2.64-56.784 10.384-111.504 32-162.72 58.784-80.176 41.92-153.392 99.696-217.184 164.48-11.808 11.984-23.552 24.224-34.288 37.248-14.288 17.328-14.288 37.872 0 55.216 32.672 39.616 71.52 74.848 111.04 107.056 85.12 69.392 182.448 127.408 289.888 150.784 62.096 13.504 124.608 14.096 187.008 2.656 56.768-10.4 111.488-32 162.736-58.768 80.176-41.936 153.376-99.696 217.184-164.48 11.792-12 23.536-24.224 34.288-37.248 5.712-5.872 9.456-13.44 10.704-21.568l0.032-0.128a12.592 12.592 0 0 0 0.128-1.088c0.064-0.304 0.096-0.624 0.128-0.928l0.08-0.656 0.096-1.28c0.032-0.656 0.048-1.296 0.048-1.952l-0.096-1.968zM512 704c-106.032 0-192-85.952-192-192s85.952-192 192-192 192 85.968 192 192c0 106.048-85.968 192-192 192z" p-id="3826"></path></svg></a><span id="busuanzi_value_page_pv"></span></div>
<div class="franklin-toc"><ol><li><a href="#automa_as_a_efficient_tool_for_building_text_parser">Automa as a efficient tool for building text parser</a><ol><li><a href="#structure_of_automa">Structure of Automa</a><ol><li><a href="#regular_expressions">Regular expressions</a></li><li><a href="#compilers">Compilers</a></li><li><a href="#code_generators">Code generators</a></li><li><a href="#expand_knowledge">Expand knowledge</a></li></ol></li></ol></li></ol></div>

<fieldset class="hadmon admon-warn"><legend class="hadmon-legend admon-legend-warn"> BioJulia is awesome, but the tutorials are generally outdated</legend>
  When I first read the blogs in <a href="https://biojulia.net/post">BioJulia</a>, I feel like to make Julia as my main language for bioinformatics related works. However, the BioJulia community suddenly stopped being active several years ago, maybe the core members were busy &#40;re&#41;building useful BioJulia packages.</p>
<p>The package Automa.jl is widely used to generate file parsers in BioJulia, but the <a href="https://biojulia.net/Automa.jl/latest/index.html">official tutorial</a> for Automa was not so intuitive for newbies like me, and the blog that introduced Automa in BioJulia was stucked in <a href="https://biojulia.net/post/automa1/">Part1</a>.</p>
<p>Here I would record my learning progress of Automa.jl, as a drive to force me finally learn how to write my own parser with Automa.jl 
</fieldset>

<h2 id="automa_as_a_efficient_tool_for_building_text_parser"><a href="#automa_as_a_efficient_tool_for_building_text_parser" class="header-anchor">Automa as a efficient tool for building text parser</a></h2>
<p>Automa.jl is a package for generating <a href="https://en.wikipedia.org/wiki/Finite-state_machine">finite-state machines &#40;FSMs&#41;</a> and tokenizers in Julia.</p>
<h3 id="structure_of_automa"><a href="#structure_of_automa" class="header-anchor">Structure of Automa</a></h3>
<fieldset class="code code-julia"><legend class="code-legend code-legend-julia">julia</legend></p>
<pre><code class="language-julia">Automa
    regular expressions
    compilers
    code generators</code></pre>
<p><div class="code-lag">julia</div></fieldset>
<h4 id="regular_expressions"><a href="#regular_expressions" class="header-anchor">Regular expressions</a></h4>
<p>Regular expressions in Automa can be built using <code>Automa.RegExp</code> module. <code>RE</code> in Automa could have actions, which could be used to create FSM. There are currently four actions:</p>
<ul>
<li><p><code>:enter</code>: exec when enter the re</p>
</li>
<li><p><code>:exit</code>: exec when exit the re</p>
</li>
<li><p><code>:all</code>: exec in all transitions</p>
</li>
<li><p><code>:final</code>: exec when reach the final state</p>
</li>
</ul>
<p>assign actions:</p>
<fieldset class="code code-julia"><legend class="code-legend code-legend-julia">julia</legend></p>
<pre><code class="language-julia">using Automa
using Automa.RegExp: @re_str
const re &#61; Automa.RegExp

ab &#61; re&quot;ab*&quot;
# assign by symbols
ab.actions&#91;:enter&#93; &#61; &#91;:enter_ab&#93;

# assign to when field to bind the action to all transition within the RE:
ab.when &#61; :cond</code></pre>
<p><div class="code-lag">julia</div></fieldset>
<h4 id="compilers"><a href="#compilers" class="header-anchor">Compilers</a></h4>
<p>compile RE into a FSM: <code>Automa.Machine</code> type</p>
<fieldset class="code code-plain"><legend class="code-legend code-legend-plain">plain</legend></p>
<pre><code class="language-plaintext">‚îÇ              start::Automa.Node‚îÇ Automa.Node&#40;&lt;state&#61;1,#edges&#61;1&gt;&#41;           ‚îÇ
‚îÇ               states::UnitRange‚îÇ 1:5                                       ‚îÇ
‚îÇ              start_state::Int64‚îÇ 1                                         ‚îÇ
‚îÇ  final_states::Automa.StableSet‚îÇ Automa.StableSet&#40;Automa.StableDict&#40;5 &#61;&gt;   ‚îÇ
‚îÇ  eof_actions::Automa.StableDict‚îÇ Automa.StableDict&#40;5 &#61;&gt;                    ‚îÇ</code></pre>
<p><div class="code-lag">plain</div></fieldset>
<p><code>execute</code> function for debugging:</p>
<p><code>execute&#40;m::Machine, s::String&#41;</code>: return a tuple of <code>&#40;Last_state::Int, action_logs::Vector&#123;Symbol&#125;&#41;</code></p>
<fieldset class="code code-julia"><legend class="code-legend code-legend-julia">julia</legend></p>
<pre><code class="language-julia">machine &#61; Automa.compile&#40;ab&#41;
Automa.execute&#40;machine, &quot;ab&quot;&#41;</code></pre>
<p><div class="code-lag">julia</div></fieldset>
<p><code>Tokenizer</code> type:</p>
<fieldset class="code code-julia"><legend class="code-legend code-legend-julia">julia</legend></p>
<pre><code class="language-julia">‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   machine      :: Automa.Machine                       
   actions_code :: Vector&#123;Tuple&#123;Symbol, Expr&#125;&#125;           
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<p><div class="code-lag">julia</div></fieldset>
<fieldset class="code code-julia"><legend class="code-legend code-legend-julia">julia</legend></p>
<pre><code class="language-julia">tokenizer &#61; Automa.compile&#40;
    re&quot;if|else|while|end&quot;      &#61;&gt; :&#40;emit&#40;:keyword&#41;&#41;,
    re&quot;&#91;A-Za-z_&#93;&#91;0-9A-Za-z_&#93;*&quot; &#61;&gt; :&#40;emit&#40;:identifier&#41;&#41;,
    re&quot;&#91;0-9&#93;&#43;&quot;                 &#61;&gt; :&#40;emit&#40;:decimal&#41;&#41;,
    re&quot;&#61;&quot;                      &#61;&gt; :&#40;emit&#40;:assign&#41;&#41;,
    re&quot;&#40;&quot;                      &#61;&gt; :&#40;emit&#40;:lparen&#41;&#41;,
    re&quot;&#41;&quot;                      &#61;&gt; :&#40;emit&#40;:rparen&#41;&#41;,
    re&quot;&#91;-&#43;*/&#93;&quot;                 &#61;&gt; :&#40;emit&#40;:operator&#41;&#41;,
    re&quot;&#91;\n\t &#93;&#43;&quot;               &#61;&gt; :&#40;&#41;,
&#41;</code></pre>
<p><div class="code-lag">julia</div></fieldset>
 
<fieldset class="admon admon-tip">
<legend class="admon-legend admon-legend-tip"> üçè tokenizer</legend>
</p>
<ul>
<li><p>compile tokenizer by take <strong>a list of pattern</strong> as argument;</p>
</li>
<li><p>use <code>emit&#40;&#41;</code> to assign action symbol;</p>
</li>
<li><p>the <strong>order</strong> matters in pattern list: former position has higher priority;</p>
</li>
<li><p>the start and end position of the token can be accessed through <code>ts</code> and <code>te</code> variables in the action code, as well as <code>p, p_end, p_eof</code> vars;</p>
</li>
</ul>
<p>
</fieldset>

<h4 id="code_generators"><a href="#code_generators" class="header-anchor">Code generators</a></h4>
<p>Generate Julia code using metaprogramming techniques.</p>
<h5 id="ways_suggested_in_the_offical_tutorial"><a href="#ways_suggested_in_the_offical_tutorial" class="header-anchor">Ways suggested in the offical tutorial:</a></h5>
<ol>
<li><p>define <code>Dict&#123;Symbol, Expr&#125;</code> action map;</p>
</li>
<li><p>initialize result variables;</p>
</li>
<li><p>generate code to initialize variables with <code>generate_init_code</code>;</p>
</li>
<li><p>set end and EOF positions of data buffer</p>
</li>
<li><p>generate code to execute FSM with <code>generate_exec_code</code>;</p>
</li>
<li><p>check if FSM properly finished;</p>
</li>
<li><p>return result</p>
</li>
<li><p>generated code was saved in <code>Automa.CodeGenContext</code> type:</p>
</li>
</ol>
<fieldset class="code code-plain"><legend class="code-legend code-legend-plain">plain</legend></p>
<pre><code class="language-plaintext">‚îÇ  vars::Automa.Variables‚îÇ Automa.Variables&#40;:p, :p_end, :p_eof, :ts,   ‚îÇ
‚îÇ     generator::Function‚îÇ generate_table_code                         ‚îÇ
‚îÇ       checkbounds::Bool‚îÇ true                                        ‚îÇ
‚îÇ       loopunroll::Int64‚îÇ 0                                           ‚îÇ
‚îÇ       getbyte::Function‚îÇ getindex                                    ‚îÇ
‚îÇ             clean::Bool‚îÇ false                                       ‚îÇ</code></pre>
<p><div class="code-lag">plain</div></fieldset>
<p>Example:</p>
<fieldset class="code code-julia"><legend class="code-legend code-legend-julia">julia</legend></p>
<pre><code class="language-julia">import Automa
import Automa.RegExp: @re_str
const re &#61; Automa.RegExp

word &#61; re&quot;&#91;A-Za-z&#93;&#43;&quot;
words &#61; re.cat&#40;re.opt&#40;word&#41;, re.rep&#40;re&quot; &#43;&quot; * word&#41;, re&quot; *&quot;&#41;
word.actions&#91;:exit&#93; &#61; &#91;:word&#93;
machine &#61; Automa.compile&#40;words&#41;

actions &#61; Dict&#40;:word &#61;&gt; :&#40;count &#43;&#61; 1&#41;&#41; # step1

context &#61; Automa.CodeGenContext&#40;&#41;

@eval function count_words&#40;data&#41;
    count &#61; 0 # step2
    &#36;&#40;Automa.generate_init_code&#40;context, machine&#41;&#41; # step3
    p_end &#61; p_eof &#61; lastindex&#40;data&#41; # step4
    &#36;&#40;Automa.generate_exec_code&#40;context, machine, actions&#41;&#41; # step5
    if cs &#33;&#61; 0
        error&#40;&quot;failed to count words&quot;&#41; # step6
    end
    return count # step7
end</code></pre>
<p><div class="code-lag">julia</div></fieldset>

<fieldset class="admon admon-note">
<legend class="admon-legend admon-legend-note"> üìò Some notes:</legend>
</p>
<ol>
<li><p>the generate function takes input byte sequences &#40; in the <code>data</code> var &#41;, the data object MUST support <code>Automa.pointerstart</code> and <code>Automa.pointerend</code> methods. <span class="sadmon sadmon-warn"><code>pointerstart</code> and <code>pointerend</code></span> point to the start and end memory positions. The two methods depend on <code>Base.pointer</code> and <code>Base.sizeof</code>.</p>
</li>
<li><p><span class="sadmon sadmon-warn">p</span> points at <strong>the next byte position</strong> in <code>data</code>;</p>
</li>
<li><p><span class="sadmon sadmon-warn">p_end</span> -&gt; end position of <code>data</code>; </p>
</li>
<li><p><span class="sadmon sadmon-warn">p_eof</span> -&gt; <em>actual</em> end of the input sequences; when data is too long to store in memory, <code>p_eof</code> would be undefined and set to a negative integer at the beginning, and later set to a suitable position once meet EOF;</p>
</li>
<li><p><span class="sadmon sadmon-warn">cs</span> -&gt; <strong>current state</strong> of a machine; when finished, <code>cs</code> stores the state of the execution: <code>cs &#61;&#61; 0</code> means <strong>successfully</strong>, <code>cs &lt; 0</code> means failed, <code>cs &gt; 0</code> means still running</p>
</li>
<li><p>there are three kind of code generators, set by <code>code&#61;</code> option in <code>generate_exec_code</code>: </p>
</li>
<li><p><code>:table</code>: use twoo look up tables to pick up next state and actions; <span class="sadmon sadmon-todo">smallest but slowest</span></p>
</li>
<li><p><code>:inline</code>: expand look up tables into if-else branches;</p>
</li>
<li><p><code>:goto</code>: based on <code>@goto</code> jumps; <span class="sadmon sadmon-todo">largest but fastest</span></p>
</li>
</ol>
<p>
</fieldset>

<h5 id="ways_used_in_the_biojulia_pkgs_automastream"><a href="#ways_used_in_the_biojulia_pkgs_automastream" class="header-anchor">Ways used in the BioJulia pkgs: Automa.Stream</a></h5>

<fieldset class="admon admon-warn">
<legend class="admon-legend admon-legend-warn"> üçá No offical references avaliable</legend>
  The whole stream sub-module was <strong>NOT included</strong> in neither the offical Automa tutorial nor its API ref. So in this section, I would record what I found, based on what I have learned from the source code of the parsers in the state-of-art BioJulia PKGs. 
</fieldset>

<p>The Automa.jl provides a submodule <a href="https://github.com/BioJulia/Automa.jl/blob/master/src/Stream.jl">Automa.Stream</a>, there are several macros and a generater function in this module that could help building the parser. Below I will list the usage of these things based on my &#40;superficial&#41; understanding.</p>

<fieldset class="admon admon-info">
<legend class="admon-legend admon-legend-info"> ü•ë new macros: `@mark`, `@markpos`, `@relpos`, `@abspos`</legend>
</p>
<ul>
<li><p><code>@mark&#40;&#41;</code>: mark the current position, return nothing, just pass the <code>p</code> var to <code>buffer.markpos</code> var;</p>
</li>
<li><p><code>@markpos&#40;&#41;</code>: retrieve the position marked by <code>@mark&#40;&#41;</code>;</p>
</li>
<li><p><code>@relpos&#40;abspos&#41;</code>: get the <strong>relative</strong> position of real/absolute position <code>abspos</code> &#40;relative to markpos&#41;: relpos &#61; abspos - markpos &#43; 1;</p>
</li>
<li><p><code>@abspos&#40;relpos&#41;</code>: get the absolute postion of relative posion <code>relpos</code>: abspos &#61; relpos &#43; markpos - 1;</p>
</li>
</ul>
<p>
</fieldset>


<fieldset class="admon admon-tip">
<legend class="admon-legend admon-legend-tip"> üçè generate_reader function</legend>
 <fieldset class="code code-julia"><legend class="code-legend code-legend-julia">julia</legend></p>
<pre><code class="language-julia">generate_reader&#40;funcname::Symbol, machine::Automa.Machine; kwargs...&#41;</code></pre>
<p><div class="code-lag">julia</div></fieldset></p>
<p>Generate a streaming reader function of the name <code>funcname</code> from <code>machine</code>. The generated function consumes data from a stream passed as the first argument and executes the machine with filling the data buffer. This function returns an expression object of the generated function.  The user need to evaluate it in a module in which the generated function is needed.</p>
<p><em>Keyword Arguments</em></p>
<ul>
<li><p><code>arguments</code>: Additional arguments <code>funcname</code> will take &#40;default: <code>&#40;&#41;</code>&#41;.   The default signature of the generated function is <code>&#40;stream::TranscodingStream,&#41;</code>,   but it is possible to supply more arguments to the signature with this keyword argument.</p>
</li>
<li><p><code>context</code>: Automa&#39;s codegenerator &#40;default: <code>Automa.CodeGenContext&#40;&#41;</code>&#41;.</p>
</li>
<li><p><code>actions</code>: A dictionary of action code &#40;default: <code>Dict&#123;Symbol,Expr&#125;&#40;&#41;</code>&#41;.</p>
</li>
<li><p><code>initcode</code>: Initialization code &#40;default: <code>:&#40;&#41;</code>&#41;.</p>
</li>
<li><p><code>loopcode</code>: Loop code &#40;default: <code>:&#40;&#41;</code>&#41;.</p>
</li>
<li><p><code>returncode</code>: Return code &#40;default: <code>:&#40;return cs&#41;</code>&#41;.</p>
</li>
</ul>
<p>The generated code looks like this:</p>
<p><fieldset class="code code-julia"><legend class="code-legend code-legend-julia">julia</legend></p>
<pre><code class="language-julia">function &#123;funcname&#125;&#40;stream::TranscodingStream, &#123;arguments&#125;...&#41;
    buffer &#61; stream.state.buffer1
    data &#61; buffer.data
    &#123;declare variables used by the machine&#125;
    &#123;initcode&#125;
    @label __exec__
    &#123;set up the variables and the data buffer&#125;
    &#123;execute the machine&#125;
    &#123;loopcode&#125;
    if cs ‚â§ 0 || p &gt; p_eof ‚â• 0
        @label __return__
        &#123;returncode&#125;
    end
    @goto __exec__
end</code></pre>
<p><div class="code-lag">julia</div></fieldset> 
</fieldset>

<p>Learn with a case: BED parser in <a href="https://github.com/BioJulia/BED.jl">BED.jl</a></p>
<fieldset class="code code-julia"><legend class="code-legend code-legend-julia">julia</legend></p>
<pre><code class="language-julia"># the following code was copied from https://github.com/BioJulia/BED.jl/blob/develop/src/reader.jl
# only the Automa related part was copied, go to the original repository to see the whole code.

const record_machine, file_machine &#61; &#40;function &#40;&#41;
    alt &#61; Automa.RegExp.alt
    cat &#61; Automa.RegExp.cat
    rep &#61; Automa.RegExp.rep
    opt &#61; Automa.RegExp.opt

    record &#61; let
        chrom &#61; re&quot;&#91; -~&#93;*&quot;
        chrom.actions&#91;:enter&#93; &#61; &#91;:pos&#93;
        chrom.actions&#91;:exit&#93; &#61; &#91;:record_chrom&#93;

        chromstart &#61; re&quot;&#91;0-9&#93;&#43;&quot;
        chromstart.actions&#91;:enter&#93; &#61; &#91;:pos&#93;
        chromstart.actions&#91;:exit&#93; &#61; &#91;:record_chromstart&#93;

        chromend &#61; re&quot;&#91;0-9&#93;&#43;&quot;
        chromend.actions&#91;:enter&#93; &#61; &#91;:pos&#93;
        chromend.actions&#91;:exit&#93; &#61; &#91;:record_chromend&#93;

        name &#61; re&quot;&#91; -~&#93;*&quot;
        name.actions&#91;:enter&#93; &#61; &#91;:pos&#93;
        name.actions&#91;:exit&#93; &#61; &#91;:record_name&#93;

        score &#61; re&quot;&#91;0-9&#93;&#43;&quot;
        score.actions&#91;:enter&#93; &#61; &#91;:pos&#93;
        score.actions&#91;:exit&#93; &#61; &#91;:record_score&#93;

        strand &#61; re&quot;&#91;&#43;\-.?&#93;&quot;
        strand.actions&#91;:enter&#93; &#61; &#91;:record_strand&#93; #Note: single byte.

        thickstart &#61; re&quot;&#91;0-9&#93;&#43;&quot;
        thickstart.actions&#91;:enter&#93; &#61; &#91;:pos&#93;
        thickstart.actions&#91;:exit&#93; &#61; &#91;:record_thickstart&#93;

        thickend &#61; re&quot;&#91;0-9&#93;&#43;&quot;
        thickend.actions&#91;:enter&#93; &#61; &#91;:pos&#93;
        thickend.actions&#91;:exit&#93; &#61; &#91;:record_thickend&#93;

        itemrgb &#61; cat&#40;re&quot;&#91;0-9&#93;&#43;&quot;, opt&#40;cat&#40;&#39;,&#39;, re&quot;&#91;0-9&#93;&#43;&quot;, &#39;,&#39;, re&quot;&#91;0-9&#93;&#43;&quot;&#41;&#41;&#41;
        itemrgb.actions&#91;:enter&#93; &#61; &#91;:pos&#93;
        itemrgb.actions&#91;:exit&#93; &#61; &#91;:record_itemrgb&#93;

        blockcount &#61; re&quot;&#91;0-9&#93;&#43;&quot;
        blockcount.actions&#91;:enter&#93; &#61; &#91;:pos&#93;
        blockcount.actions&#91;:exit&#93; &#61; &#91;:record_blockcount&#93;

        # comma-separated values
        csv&#40;x&#41; &#61; cat&#40;rep&#40;cat&#40;x, &#39;,&#39;&#41;&#41;, opt&#40;x&#41;&#41;

        blocksizes &#61; let
            blocksize &#61; re&quot;&#91;0-9&#93;&#43;&quot;
            blocksize.actions&#91;:enter&#93; &#61; &#91;:pos&#93;
            blocksize.actions&#91;:exit&#93; &#61; &#91;:record_blocksizes_blocksize&#93;

            csv&#40;blocksize&#41;
        end
        blocksizes.actions&#91;:exit&#93; &#61; &#91;:record_blocksizes&#93;

        blockstarts &#61; let
            blockstart &#61; re&quot;&#91;0-9&#93;&#43;&quot;
            blockstart.actions&#91;:enter&#93; &#61; &#91;:pos&#93;
            blockstart.actions&#91;:exit&#93; &#61; &#91;:record_blockstarts_blockstart&#93;

            csv&#40;blockstart&#41;
        end
        blockstarts.actions&#91;:exit&#93; &#61; &#91;:record_blockstarts&#93;

        cat&#40;
            chrom, &#39;\t&#39;,
            chromstart, &#39;\t&#39;,
            chromend,
            opt&#40;cat&#40;&#39;\t&#39;, name,
            opt&#40;cat&#40;&#39;\t&#39;, score,
            opt&#40;cat&#40;&#39;\t&#39;, strand,
            opt&#40;cat&#40;&#39;\t&#39;, thickstart,
            opt&#40;cat&#40;&#39;\t&#39;, thickend,
            opt&#40;cat&#40;&#39;\t&#39;, itemrgb,
            opt&#40;cat&#40;&#39;\t&#39;, blockcount,
            opt&#40;cat&#40;&#39;\t&#39;, blocksizes,
            opt&#40;cat&#40;&#39;\t&#39;, blockstarts&#41;&#41;&#41;&#41;&#41;&#41;&#41;&#41;&#41;&#41;&#41;&#41;&#41;&#41;&#41;&#41;&#41;&#41;&#41;
    end
    record.actions&#91;:enter&#93; &#61; &#91;:mark&#93;
    record.actions&#91;:exit&#93; &#61; &#91;:record&#93;

    hspace &#61; re&quot;&#91; \t\v&#93;&quot;

    blankline &#61; rep&#40;hspace&#41;

    comment &#61; re&quot;#.*&quot;

    newline &#61; let
        lf &#61; re&quot;\n&quot;
        lf.actions&#91;:enter&#93; &#61; &#91;:countline&#93;

        cat&#40;opt&#40;&#39;\r&#39;&#41;, lf&#41;
    end

    file &#61; rep&#40;alt&#40;
        cat&#40;record, newline&#41;,
        cat&#40;blankline, newline&#41;,
        cat&#40;comment, newline&#41;,
    &#41;&#41;

    return map&#40;Automa.compile, &#40;record, file&#41;&#41;
end&#41;&#40;&#41;

#&#61;
write&#40;&quot;bed.dot&quot;, Automa.machine2dot&#40;file_machine&#41;&#41;
run&#40;&#96;dot -Tsvg -o bed.svg bed.dot&#96;&#41;
&#61;#

const record_actions &#61; Dict&#40;
    :mark &#61;&gt; :&#40;@mark&#41;,
    :pos &#61;&gt; :&#40;pos &#61; @relpos&#40;p&#41;&#41;,
    :countline &#61;&gt; :&#40;&#41;,
    :record_chrom &#61;&gt; :&#40;record.chrom &#61; &#40;pos:@relpos&#40;p-1&#41;&#41;; record.ncols &#43;&#61; 1&#41;,
    :record_chromstart &#61;&gt; :&#40;record.chromstart &#61; &#40;pos:@relpos&#40;p-1&#41;&#41;; record.ncols &#43;&#61; 1&#41;,
    :record_chromend &#61;&gt; :&#40;record.chromend &#61; &#40;pos:@relpos&#40;p-1&#41;&#41;; record.ncols &#43;&#61; 1&#41;,
    :record_name &#61;&gt; :&#40;record.name &#61; &#40;pos:@relpos&#40;p-1&#41;&#41;; record.ncols &#43;&#61; 1&#41;,
    :record_score &#61;&gt; :&#40;record.score &#61; &#40;pos:@relpos&#40;p-1&#41;&#41;; record.ncols &#43;&#61; 1&#41;,
    :record_strand &#61;&gt; :&#40;record.strand &#61; @relpos&#40;p&#41;; record.ncols &#43;&#61; 1&#41;,
    :record_thickstart &#61;&gt; :&#40;record.thickstart &#61; &#40;pos:@relpos&#40;p-1&#41;&#41;; record.ncols &#43;&#61; 1&#41;,
    :record_thickend &#61;&gt; :&#40;record.thickend &#61; &#40;pos:@relpos&#40;p-1&#41;&#41;; record.ncols &#43;&#61; 1&#41;,
    :record_itemrgb &#61;&gt; :&#40;record.itemrgb &#61; &#40;pos:@relpos&#40;p-1&#41;&#41;; record.ncols &#43;&#61; 1&#41;,
    :record_blockcount &#61;&gt; :&#40;record.blockcount &#61; &#40;pos:@relpos&#40;p-1&#41;&#41;; record.ncols &#43;&#61; 1&#41;,
    :record_blocksizes_blocksize &#61;&gt; :&#40;push&#33;&#40;record.blocksizes, &#40;pos:@relpos&#40;p-1&#41;&#41;&#41;&#41;,
    :record_blocksizes &#61;&gt; :&#40;record.ncols &#43;&#61; 1&#41;,
    :record_blockstarts_blockstart &#61;&gt; :&#40;push&#33;&#40;record.blockstarts, &#40;pos:@relpos&#40;p-1&#41;&#41;&#41;&#41;,
    :record_blockstarts &#61;&gt; :&#40;record.ncols &#43;&#61; 1&#41;,
    :record &#61;&gt; :&#40;record.filled &#61; 1:@relpos&#40;p-1&#41;&#41;
&#41;

Automa.Stream.generate_reader&#40;
    :index&#33;,
    record_machine,
    arguments &#61; &#40;:&#40;record::Record&#41;,&#41;,
    actions &#61; record_actions,
    # context &#61; :&#40;&#41;,
    initcode &#61; :&#40;pos &#61; 0&#41;,
    # loopcode &#61; :&#40;&#41;
    # returncode &#61; :&#40;&#41;
&#41; |&gt; eval</code></pre>
<p><div class="code-lag">julia</div></fieldset>
<p>In the case above, the parsers did not directly parse the content of the data into variables, instead, they created a Type <code>Record</code> &#40;source code <a href="https://github.com/BioJulia/BED.jl/blob/2e082b1a9f8c6c543e5544a90a7f970110ca7e6b/src/record.jl#L4">here</a>&#41; that stores the whore data related to the record and the indexes for each track.</p>
<p>So, the <code>record_machine</code> FSM records the enter and exit action for both the whole record &#40;per line in a bed format file&#41; and for each track &#40;per cell for each line&#41;. The <code>:enter</code> action for the whole record was marked <code>@mark</code>, in each track&#39;s <code>:enter</code> action, the <code>pos</code> var was assigned to <code>@relpos</code>, which means positon relative to the start postion of each record. The output variables were assigned by <code>var &#61; &#40;pos:@relpos&#40;p-1&#41;&#41;</code> rather than the traditional way <code>var &#61; String&#40;data&#91;pos:p-1&#93;&#41;</code>, to store the relative positions in the data.</p>
<p>Then, the <code>file_machine</code> was used to generate a <code>readrecord&#33;</code> function</p>
<h4 id="expand_knowledge"><a href="#expand_knowledge" class="header-anchor">Expand knowledge</a></h4>
<ul>
<li><p>Dealing with streams: <a href="https://juliaio.github.io/TranscodingStreams.jl/stable/">TranscodingStreams</a></p>
</li>
</ul>

<fieldset class="admon admon-todo">
<legend class="admon-legend admon-legend-todo"> üçä TODO</legend>
  how to write my own parser and reader? 
</fieldset>



</div>
<!-- article style -->


 <hr>

<script src="https://utteranc.es/client.js"
    repo="songtaogui/blog_comments"
    issue-term="pathname"
    theme="github-light"
    crossorigin="anonymous"
    async>
</script>


<hr> 

<div class="container">
    
    <footer class="site-footer">
        <p class="powered-by">
            Total visits: <span id="busuanzi_value_site_pv"></span>.<br>
            Built with <a href="https://franklinjl.org" target="_blank" rel="noopener">Franklin.jl</a> and <a
                href="https://julialang.org" target="_blank" rel="noopener">Julia</a>.<br>
            The text is licensed under <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>.<br>
            The code is licensed under the <a href="https://mit-license.org/">MIT License</a>.<br>
            <strong>&copy; Songtao Gui</strong>. Last modified: October 06, 2022.

            <!-- <span class="float-right" aria-hidden="true">
        <a href="#" class="back-to-top">
          <span class="button_icon">
            <i class="fas fa-chevron-up fa-2x"></i>
          </span>
        </a>
      </span> -->

        </p>
    </footer>
    
</div>
</div>


</div>
<!--article container -->
</article>


<!-- CONTENT ENDS HERE -->

 <script src="/libs/highlight/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();hljs.configure({tabReplace: '    '});</script>
 

<script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js
    integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js
    integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js
    integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script>
<script src="/libs/academic/academic.min.js"></script>
<script src="/libs/pure/ui.js"></script>

</body>


 <a class="js-back-to-top back-to-top-button" href="#">
    <img src="/assets/img/up.svg" style="width: 100px;">
</a>
<!-- <button class="js-back-to-top back-to-top-button" title="BackToTop">Ô∏Ω</button> -->
<script src="https://cdn.staticfile.org/jquery/2.2.4/jquery.min.js"></script>
<script>
    $(function () {
        var $win = $(window);
        var $backToTop = $('.js-back-to-top');
        // ÂΩìÁî®Êà∑ÊªöÂä®Âà∞Á¶ªÈ°∂ÈÉ®100ÂÉèÁ¥†Êó∂ÔºåÂ±ïÁ§∫ÂõûÂà∞È°∂ÈÉ®ÊåâÈíÆ
        $win.scroll(function () {
            if ($win.scrollTop() > 100) {
                $backToTop.show();
            } else {
                $backToTop.hide();
            }
        });
        // ÂΩìÁî®Êà∑ÁÇπÂáªÊåâÈíÆÊó∂ÔºåÈÄöËøáÂä®ÁîªÊïàÊûúËøîÂõûÂ§¥ÈÉ®
        $backToTop.click(function () {
            $('html, body').animate({
                scrollTop: 0
            }, 200);
        });
    });
</script>
<style>
    /* back to top button */
    .back-to-top-button {
        display: none;
        position: fixed;
        width: 50px;
        bottom: 3%;
        right: 3%;
        z-index: 99;
        font-size: 15px;
        border: 0px solid #696969;
        background-color: #fff;
        color: #222222;
        outline: none;
        cursor: pointer;
        padding: 7px;
        border-radius: 40px;
    }

    .back-to-top-button:hover {
        background-color: #c0dbf5;
        color: #fff;
    }
</style> 


<!-- PJAXÈÖçÁΩÆ: ÂÖà‰∏çÊêû‰∫Ü! -->
<!--   
  <script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script>
  
  <script>
    var pjax = new Pjax({
      elements: "a",
      selectors: [
        "title",
        "meta[name=description]",
        ".the-header",
        ".the-content",
        ".the-sidebar",
      ]
    })
  </script> -->

</html>


