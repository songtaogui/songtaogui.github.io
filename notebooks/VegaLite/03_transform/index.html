
<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="google-site-verification" content="sKCEBeALSs13uui0cWMviq9hlm0rPByKQKNHnOdq-d0" />
    <meta name="baidu-site-verification" content="code-MBwKQgVpns" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Songtao Gui">

    
    <meta name="description" content="Vega-Lite系列: 03_transform
">
    

    
    
    <meta name="keywords" content="Vega-Lite文档: 03_transform">
    <title>Vega-Lite文档: 03_transform</title>
    

    <link rel="icon" href="/assets/favicon.svg">

    
<link rel=preconnect href="https://fonts.gstatic.com" crossorigin=anonymous>
<link rel=stylesheet href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
    crossorigin=anonymous>
<link rel=stylesheet href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css"
    crossorigin=anonymous>
<link rel=stylesheet href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css" crossorigin=anonymous>
<link rel=stylesheet
    href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap"
    crossorigin=anonymous>
<!-- locally served -->
<link rel="stylesheet" href="/css/pure.css">
<link rel=stylesheet href="/libs/academic/academic.min.css">
<link rel="stylesheet" href="/css/layout.css">
<link rel="stylesheet" href="/css/extra.css">
<link rel=stylesheet href="/css/codeset.css">
<link rel=stylesheet href="/css/admonition.css">
<link rel=stylesheet href="/css/cv.css">
<link rel=stylesheet href="/css/search-box.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.css">
<link rel=stylesheet href="/css/vega.css">
<!-- <link rel=stylesheet href="/css/font-awesome.css"> -->

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!-- nutshell + highlight + katex + plotly -->

<link rel=stylesheet href="/libs/highlight/styles/atom-one-light.min.css">
 <link rel="stylesheet" href="/libs/katex/katex.min.css">
 





    <!-- Vega -->
    <script src="https://cdn.jsdelivr.net/npm/vega@5.22.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.5.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.21.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.0/dist/svg.min.js"></script>
    <style media="screen">
        /* Add space between Vega-Embed links  */
        .vega-actions a {
          margin-right: 5px;
        }
    </style>
    <!-- end Vega -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js"
        integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin=anonymous async></script>
</head>

<body id=top data-spy="scroll" data-offset="70" data-target=#navbar-main>
    <!-- Swiftype -->
    <script type="text/javascript">
        (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
        (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
        e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
        })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
        
        _st('install','J57vdqtTa8oYL-ikpKNG','2.0.0');
    </script>
    
     <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main>
    <div class=container>
        <!-- Main name -->
        <div class="d-none d-lg-inline-flex">
            <a class=navbar-brand href="/">Songtao Gui</a>
        </div>
        <!-- Button for narrow mode -->
        <button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar
            aria-expanded=false aria-label="Toggle navigation">
            <span><i class="fas fa-bars"></i></span>
        </button>
        <!-- Main name for mobile mode -->
        <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
            <a class=navbar-brand href="/">Songtao Gui</a>
        </div>
        <!-- Menu items -->
        <div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content>
            <ul class="navbar-nav d-md-inline-flex">
                <li class=nav-item><a class=nav-link href="/posts/"><span>Posts</span></a></li>
                <li class=nav-item><a class=nav-link href="/courses/"><span>Courses</span></a></li>
                <li class=nav-item><a class=nav-link href="/notebooks/"><span>Notebooks</span></a></li>
                <li class=nav-item><a class=nav-link href="/cv/"><span>CurriculumVitae</span></a></li>
                <li class=nav-item><a class=nav-link href="/tag/"><span>Tags</span></a></li>
            </ul>
        </div>
        <!-- <div class="nav-linksmall d-none d-lg-inline-flex inputBox">
                <input type="text" class="st-default-search-input" placeholder="Input then press ENTER" value="" required>
                <div class="search"></div>
            <script>
                var searchForm = document.getElementById('searchForm');
                searchForm.onsubmit = function () {
                    var url = this.action;
                    var q = this.children['q'].value;
                    var q = 'site:songtaogui.github.io+' + q
                    // var site = this.children['site'].value;
                    var url = url + '?q=' + q;
                    window.open(url,'__blank');
                    return false;
                };
            </script>
        </div> -->
        <!-- 基于bing site搜索: -->
        <div class="nav-linksmall d-none d-lg-inline-flex inputBox">
            <form action="https://bing.com/search" id="searchForm">
                <input type="text" name="q" value="" placeholder="Input then press ENTER" value="" required>
                <div class="search"></div>
            </form>
            <script>
                var searchForm = document.getElementById('searchForm');
                searchForm.onsubmit = function () {
                    var url = this.action;
                    var q = this.children['q'].value;
                    var q = 'site:songtaogui.github.io+' + q
                    // var site = this.children['site'].value;
                    var url = url + '?q=' + q;
                    window.open(url,'__blank');
                    return false;
                };
            </script>
        </div>
        <!-- <div class="nav-icon d-none d-lg-inline-flex"> -->
        <div class="nav-icon">
            <a class=nav-linksmall href="/giants" target="_blank"><span><img class="nav-img"
                src="/assets/img/giant.svg"></span></a>
            <a class=nav-linksmall href="/achievements/" target="_blank"><span><img class="nav-img"
                        src="/assets/img/achievement.svg"></span></a>
            <a class=nav-linksmall href="/feed.xml" target="_blank"><span><img class="nav-img"
                        src="/assets/img/rss.svg"></span></a>
            <a class=nav-linksmall href="/musics" target="_blank"><span><img class="nav-img"
                        src="/assets/img/music.svg"></span></a>
        </div>

    </div>
</nav> 

    <span class="js-widget-page d-none"></span>

    
    <article class=article>
        <div class="article-container pt-3">
             <h1>Vega-Lite文档: 03_transform</h1> 
        </div>
        
        <div class="article-container">
            <!-- 关闭article-style, 不然跟nutshell不兼容 -->
            <!-- <div class="gst-style"> -->
            <div class="layout-main">
                <!-- <div class="article-style"> -->
                
                
                <div class="franklin-content">
<div class="tags"><a href="/tag/" id="tag-icon"><svg width="20" height="20" viewBox="0 0 512 512"><defs><style>.cls-1{fill:#141f38}</style></defs><path class="cls-1" d="M215.8 512a76.1 76.1 0 0 1-54.17-22.44L22.44 350.37a76.59 76.59 0 0 1 0-108.32L242 22.44A76.11 76.11 0 0 1 296.2 0h139.2A76.69 76.69 0 0 1 512 76.6v139.19A76.08 76.08 0 0 1 489.56 270L270 489.56A76.09 76.09 0 0 1 215.8 512zm80.4-486.4a50.69 50.69 0 0 0-36.06 14.94l-219.6 219.6a51 51 0 0 0 0 72.13l139.19 139.19a51 51 0 0 0 72.13 0l219.6-219.61a50.67 50.67 0 0 0 14.94-36.06V76.6a51.06 51.06 0 0 0-51-51zm126.44 102.08A38.32 38.32 0 1 1 461 89.36a38.37 38.37 0 0 1-38.36 38.32zm0-51a12.72 12.72 0 1 0 12.72 12.72 12.73 12.73 0 0 0-12.72-12.76z"/><path class="cls-1" d="M217.56 422.4a44.61 44.61 0 0 1-31.76-13.16l-83-83a45 45 0 0 1 0-63.52L211.49 154a44.91 44.91 0 0 1 63.51 0l83 83a45 45 0 0 1 0 63.52L249.31 409.24a44.59 44.59 0 0 1-31.75 13.16zm-96.7-141.61a19.34 19.34 0 0 0 0 27.32l83 83a19.77 19.77 0 0 0 27.31 0l108.77-108.7a19.34 19.34 0 0 0 0-27.32l-83-83a19.77 19.77 0 0 0-27.31 0l-108.77 108.7z"/><path class="cls-1" d="M294.4 281.6a12.75 12.75 0 0 1-9-3.75l-51.2-51.2a12.8 12.8 0 0 1 18.1-18.1l51.2 51.2a12.8 12.8 0 0 1-9.05 21.85zM256 320a12.75 12.75 0 0 1-9.05-3.75l-51.2-51.2a12.8 12.8 0 0 1 18.1-18.1l51.2 51.2A12.8 12.8 0 0 1 256 320zM217.6 358.4a12.75 12.75 0 0 1-9-3.75l-51.2-51.2a12.8 12.8 0 1 1 18.1-18.1l51.2 51.2a12.8 12.8 0 0 1-9.05 21.85z"/></svg></a><a href="/tag/hacks/">hacks</a>, <a href="/tag/vega/">vega</a>, <a href="/tag/visualization/">visualization</a>&nbsp;&nbsp;&nbsp;&nbsp;<a id="tag-icon"><svg width="20" height="20" class="icon" viewBox="0 0 1024 1024" version="1.1" p-id="3825" width="64" height="64"><path d="M512 416a96 96 0 1 0 0 192 96 96 0 0 0 0-192z m511.952 102.064c-0.016-0.448-0.064-0.864-0.096-1.296a8.16 8.16 0 0 0-0.08-0.656c0-0.32-0.064-0.624-0.128-0.928-0.032-0.368-0.064-0.736-0.128-1.088-0.032-0.048-0.032-0.096-0.032-0.144a39.488 39.488 0 0 0-10.704-21.536c-32.672-39.616-71.536-74.88-111.04-107.072-85.088-69.392-182.432-127.424-289.856-150.8-62.112-13.504-124.576-14.064-187.008-2.64-56.784 10.384-111.504 32-162.72 58.784-80.176 41.92-153.392 99.696-217.184 164.48-11.808 11.984-23.552 24.224-34.288 37.248-14.288 17.328-14.288 37.872 0 55.216 32.672 39.616 71.52 74.848 111.04 107.056 85.12 69.392 182.448 127.408 289.888 150.784 62.096 13.504 124.608 14.096 187.008 2.656 56.768-10.4 111.488-32 162.736-58.768 80.176-41.936 153.376-99.696 217.184-164.48 11.792-12 23.536-24.224 34.288-37.248 5.712-5.872 9.456-13.44 10.704-21.568l0.032-0.128a12.592 12.592 0 0 0 0.128-1.088c0.064-0.304 0.096-0.624 0.128-0.928l0.08-0.656 0.096-1.28c0.032-0.656 0.048-1.296 0.048-1.952l-0.096-1.968zM512 704c-106.032 0-192-85.952-192-192s85.952-192 192-192 192 85.968 192 192c0 106.048-85.968 192-192 192z" p-id="3826"></path></svg></a><span id="busuanzi_value_page_pv"></span></div>
<div class="franklin-toc"><ol><li><a href="#数据转换">数据转换</a><ol><li><a href="#aggregate汇总">Aggregate汇总</a><ol><li><a href="#argminargmax">argmin/argmax</a></li></ol></li><li><a href="#bin分箱">Bin分箱</a><ol><li><a href="#encoding中使用bin">encoding中使用bin</a></li><li><a href="#transform中使用bin">transform中使用bin</a></li><li><a href="#bin的可选参数">Bin的可选参数</a></li><li><a href="#分箱排序">分箱排序</a></li></ol></li><li><a href="#calculate">Calculate</a></li><li><a href="#density">Density</a><ol><li><a href="#density参数">density参数</a></li></ol></li><li><a href="#filter">Filter</a></li><li><a href="#flatten">Flatten</a></li><li><a href="#fold">Fold</a></li><li><a href="#impute">Impute</a></li><li><a href="#join_aggregate">Join Aggregate</a></li><li><a href="#loess">Loess</a></li><li><a href="#lookup">Lookup</a></li><li><a href="#pivot">Pivot</a></li><li><a href="#quantile">Quantile</a></li><li><a href="#regression">Regression</a></li><li><a href="#sample">Sample</a></li><li><a href="#stack">Stack</a></li><li><a href="#time_unit">Time Unit</a></li><li><a href="#window">Window</a><ol><li><a href="#transform_parameters">Transform Parameters</a></li><li><a href="#window_operation_reference">Window operation reference</a></li><li><a href="#example">Example</a></li></ol></li><li><a href="#wordcloud">Wordcloud</a><ol><li><a href="#example__2">Example</a></li><li><a href="#变换参数">变换参数</a></li></ol></li></ol></li></ol></div>
<blockquote>
<p><a href="https://vega.github.io/vega/docs/">Offical documentation</a></p>
</blockquote>
<h2 id="数据转换"><a href="#数据转换" class="header-anchor">数据转换</a></h2>
<p>数据变换有两种途径:</p>
<ol>
<li><p><code>transform</code>: view-level transforms, 在整个view中指定转换逻辑</p>
</li>
<li><p><code>encoding</code>: field transforms inside, 在数据列中指定转换逻辑</p>
</li>
</ol>
<ul>
<li><p>如果两种转换方式都提供, 会先执行<code>transform</code>,然后再执行内联的转换, 且转换顺序为: <code>bin -&gt; timeUnit -&gt; aggregate -&gt; sort -&gt; stack</code></p>
</li>
<li><p><code>transform</code>中的转换顺序是按照出现的顺序进行的, 支持如下转换:</p>
</li>
</ul>
<h3 id="aggregate汇总"><a href="#aggregate汇总" class="header-anchor">Aggregate汇总</a></h3>
<ul>
<li><p>汇总操作由<code>aggregate</code>和<code>groupby</code>完成</p>
</li>
<li><p><code>aggregate</code>支持三个属性: <code>op</code>指定汇总操作&#40;函数&#41;, <code>field</code>指定处理哪列, <code>as</code>指定输出列名</p>
</li>
<li><p><code>groupby</code>指定分组处理的规则, 传入的是列名向量</p>
</li>
</ul>
<p>aggregate支持的操作:</p>
<table><tr><th align="left">Operation</th><th align="left">Description</th></tr><tr><td align="left">count</td><td align="left">The total count of data objects in the group.Note: <code>count</code> operates directly on the input objects and return the same value regardless of the provided field.</td></tr><tr><td align="left">valid</td><td align="left">The count of field values that are not null, undefined or NaN.</td></tr><tr><td align="left">values</td><td align="left">A list of data objects in the group.</td></tr><tr><td align="left">missing</td><td align="left">The count of null or undefined field values.</td></tr><tr><td align="left">distinct</td><td align="left">The count of distinct field values.</td></tr><tr><td align="left">sum</td><td align="left">The sum of field values.</td></tr><tr><td align="left">product</td><td align="left">The product of field values.</td></tr><tr><td align="left">mean</td><td align="left">The mean &#40;average&#41; field value.</td></tr><tr><td align="left">average</td><td align="left">The mean &#40;average&#41; field value. Identical to mean.</td></tr><tr><td align="left">variance</td><td align="left">The sample variance of field values.</td></tr><tr><td align="left">variancep</td><td align="left">The population variance of field values.</td></tr><tr><td align="left">stdev</td><td align="left">The sample standard deviation of field values.</td></tr><tr><td align="left">stdevp</td><td align="left">The population standard deviation of field values.</td></tr><tr><td align="left">stderr</td><td align="left">The standard error of field values.</td></tr><tr><td align="left">median</td><td align="left">The median field value.</td></tr><tr><td align="left">q1</td><td align="left">The lower quartile boundary of field values.</td></tr><tr><td align="left">q3</td><td align="left">The upper quartile boundary of field values.</td></tr><tr><td align="left">ci0</td><td align="left">The lower boundary of the bootstrapped 95&#37; confidence interval of the mean field value.</td></tr><tr><td align="left">ci1</td><td align="left">The upper boundary of the bootstrapped 95&#37; confidence interval of the mean field value.</td></tr><tr><td align="left">min</td><td align="left">The minimum field value.</td></tr><tr><td align="left">max</td><td align="left">The maximum field value.</td></tr><tr><td align="left">argmin</td><td align="left">An input data object containing the minimum field value.Note: When used inside encoding, argmin must be specified as an object. &#40;See below for an example.&#41;</td></tr><tr><td align="left">argmax</td><td align="left">An input data object containing the maximum field value.Note: When used inside encoding, argmax must be specified as an object. &#40;See below for an example.&#41;</td></tr><tr><td align="left"></td><td align="left"></td></tr></table>
<h4 id="argminargmax"><a href="#argminargmax" class="header-anchor">argmin/argmax</a></h4>
<p>用于查找与另一字段中的极值相对应的当前字段的值:</p>

<table id="lov"><tr>
<td id="lov" height=90% style="width:50%">
</p>
<pre><code class="language-json">&#123;
    &quot;data&quot;: &#123;&quot;url&quot;: &quot;/assets/data/movies.json&quot;&#125;,
    &quot;mark&quot;: &quot;bar&quot;,
    &quot;encoding&quot;: &#123;
        &quot;x&quot;: &#123;
        //查找US Gross最大值对应的Production Budget
        &quot;aggregate&quot;: &#123;&quot;argmax&quot;: &quot;US Gross&quot;&#125;, 
        &quot;field&quot;: &quot;Production Budget&quot;,
        &quot;type&quot;: &quot;quantitative&quot;
        &#125;,
        &quot;y&quot;: &#123;&quot;field&quot;: &quot;Major Genre&quot;, &quot;type&quot;: &quot;nominal&quot;&#125;
    &#125;
&#125;</code></pre>
<p>
</td>
<td id="lov" width="50%" height=90% align="left">
 
<div id="vis785"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "data": {"url": "/assets/data/movies.json"},
    "mark": "bar",
    "encoding": {
        "x": {
        //查找US Gross最大值对应的Production Budget
        "aggregate": {"argmax": "US Gross"}, 
        "field": "Production Budget",
        "type": "quantitative"
        },
        "y": {"field": "Major Genre", "type": "nominal"}
    }
    };
    vegaEmbed('#vis785', vlSpec, opt);
</script>
 
</td>
</tr></table>

<p>以上是用的<code>encoding</code>方式, 也可以用<code>transform</code>的形式:</p>

<table id="lov"><tr>
<td id="lov" height=90% style="width:60%">
</p>
<pre><code class="language-json">&#123;
    &quot;data&quot;: &#123;&quot;url&quot;: &quot;/assets/data/movies.json&quot;&#125;,
    &quot;transform&quot;: &#91;&#123;
        &quot;aggregate&quot;: &#91;&#123;
            &quot;op&quot;: &quot;argmax&quot;,
            &quot;field&quot;: &quot;US Gross&quot;,
            &quot;as&quot;: &quot;argmax_US_Gross&quot;
        &#125;&#93;,
        &quot;groupby&quot;: &#91;&quot;Major Genre&quot;&#93;
    &#125;&#93;,
    &quot;mark&quot;: &quot;bar&quot;,
    &quot;encoding&quot;: &#123;
        &quot;x&quot;: &#123;
            &quot;field&quot;: &quot;argmax_US_Gross&#91;&#39;Production Budget&#39;&#93;&quot;,
            &quot;type&quot;: &quot;quantitative&quot;
        &#125;,
        &quot;y&quot;: &#123;&quot;field&quot;: &quot;Major Genre&quot;, &quot;type&quot;: &quot;nominal&quot;&#125;
    &#125;
&#125;</code></pre>
<p>
</td>
<td id="lov" width="40%" height=90% align="left">
 
<div id="vis823"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "data": {"url": "/assets/data/movies.json"},
    "transform": [{
        "aggregate": [{
            "op": "argmax",
            "field": "US Gross",
            "as": "argmax_US_Gross"
        }],
        "groupby": ["Major Genre"]
    }],
    "mark": "bar",
    "encoding": {
        "x": {
            "field": "argmax_US_Gross['Production Budget']",
            "type": "quantitative"
        },
        "y": {"field": "Major Genre", "type": "nominal"}
    }
    };
    vegaEmbed('#vis823', vlSpec, opt);
</script>
 
</td>
</tr></table>


<fieldset class="admon admon-info">
<legend class="admon-legend admon-legend-info"> Info</legend>
  好像用<code>encoding</code>的方式更直观, 而且代码量更少啊, 有什么只能用<code>transform</code>的场景么? 
</fieldset>

<span class="sadmon sadmon-note">argmax的一个应用场景: 通过获取X轴最后一个值, 给折线图加标签:</span>

<table id="lov"><tr>
<td id="lov" height=90% style="width:60%">
</p>
<pre><code class="language-json">&#123;
    &quot;data&quot;: &#123;&quot;url&quot;: &quot;/assets/data/stocks.csv&quot;&#125;,
    &quot;transform&quot;: &#91;&#123;&quot;filter&quot;: &quot;datum.symbol &#33;&#61;&#61; &#39;IBM&quot;&#125;&#93;,
    &quot;encoding&quot;: &#123;
        &quot;color&quot;: &#123;
            &quot;field&quot;:&quot;symbol&quot;,
            &quot;type&quot;:&quot;nominal&quot;,
            &quot;legend&quot;: null
        &#125;
    &#125;,
    &quot;layer&quot;: &#91;&#123;
    &quot;mark&quot;: &quot;line&quot;,
    &quot;encoding&quot;: &#123;
        &quot;x&quot;: &#123;&quot;field&quot;: &quot;date&quot;, &quot;type&quot;: &quot;temporal&quot;, &quot;title&quot;: &quot;date&quot;&#125;,
        &quot;y&quot;: &#123;&quot;field&quot;: &quot;price&quot;, &quot;type&quot;: &quot;quantitative&quot;, &quot;title&quot;: &quot;price&quot;&#125;
    &#125;
    &#125;,&#123;
    &quot;encoding&quot;: &#123;
        &quot;x&quot;: &#123;&quot;aggregate&quot;: &quot;max&quot;, &quot;field&quot;: &quot;date&quot;, &quot;type&quot;: &quot;temporal&quot;&#125;,
        &quot;y&quot;: &#123;&quot;aggregate&quot;: &#123;&quot;argmax&quot;: &quot;date&quot;&#125;, &quot;field&quot;: &quot;price&quot;, &quot;type&quot;: &quot;quantitative&quot;&#125;
    &#125;,
    &quot;layer&quot;: &#91;&#123;
        &quot;mark&quot;: &#123;&quot;type&quot;: &quot;circle&quot;&#125;
    &#125;, &#123;
        &quot;mark&quot;: &#123;&quot;type&quot;: &quot;text&quot;, &quot;align&quot;: &quot;left&quot;, &quot;dx&quot;: 4&#125;,
        &quot;encoding&quot;: &#123;&quot;text&quot;: &#123;&quot;field&quot;:&quot;symbol&quot;, &quot;type&quot;: &quot;nominal&quot;&#125;&#125;
    &#125;&#93;
    &#125;&#93;,
    &quot;config&quot;: &#123;&quot;view&quot;: &#123;&quot;stroke&quot;: null&#125;&#125;
&#125;</code></pre>
<p>
</td>
<td id="lov" width="40%" height=90% align="left">
 
<div id="vis885"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "data": {"url": "/assets/data/stocks.csv"},
    "transform": [{"filter": "datum.symbol != 'IBM'"}],
    "encoding": {
        "color": {
            "field":"symbol",
            "type":"nominal",
            "legend": null
        }
    },
    "layer": [{
    "mark": "line",
    "encoding": {
        "x": {"field": "date", "type": "temporal", "title": "date"},
        "y": {"field": "price", "type": "quantitative", "title": "price"}
    }
    },{
    "encoding": {
        "x": {"aggregate": "max", "field": "date", "type": "temporal"},
        "y": {"aggregate": {"argmax": "date"}, "field": "price", "type": "quantitative"}
    },
    "layer": [{
        "mark": {"type": "circle"}
    }, {
        "mark": {"type": "text", "align": "left", "dx": 4},
        "encoding": {"text": {"field":"symbol", "type": "nominal"}}
    }]
    }],
    "config": {"view": {"stroke": null}}
    };
    vegaEmbed('#vis885', vlSpec, opt);
</script>
 
</td>
</tr></table>

<h3 id="bin分箱"><a href="#bin分箱" class="header-anchor">Bin分箱</a></h3>
<ul>
<li><p>可以用来做histogram</p>
</li>
<li><p><code>encoding</code>和<code>transform</code></p>
</li>
</ul>
<h4 id="encoding中使用bin"><a href="#encoding中使用bin" class="header-anchor">encoding中使用bin</a></h4>
<pre><code class="language-json">// A Single View or a Layer Specification
&#123;
    ...,
    &quot;mark/layer&quot;: ...,
    &quot;encoding&quot;: &#123;
        &quot;x&quot;: &#123;
        &quot;bin&quot;: ..., // bin
        &quot;field&quot;: ...,
        &quot;type&quot;: &quot;quantitative&quot;,
        ...
        &#125;,
        &quot;y&quot;: ...,
        ...
    &#125;,
    ...
&#125;</code></pre>
<p>在<code>encoding</code>中, 直接用<code>bin</code>属性操作, <code>bin</code>属性支持传入的类型有:</p>
<ul>
<li><p><code>true</code>: 使用默认的分箱参数, 默认是<code>false</code></p>
</li>
<li><p><code>binned</code>: 表明数据已经分箱过了, 可以把bin-start和bin-end映射到x/y和x2/y2</p>
</li>
</ul>

<table id="lov"><tr>
<td id="lov" height=90% style="width:50%">
</p>
<pre><code class="language-json">&#123;
    &quot;data&quot;: &#123;&quot;url&quot;: &quot;/assets/data/movies.json&quot;&#125;,
    &quot;mark&quot;: &quot;bar&quot;,
    &quot;encoding&quot;: &#123;
        &quot;x&quot;: &#123;
            &quot;bin&quot;: true,
            &quot;field&quot;: &quot;IMDB Rating&quot;
        &#125;,
        &quot;y&quot;: &#123;&quot;aggregate&quot;: &quot;count&quot;&#125;
    &#125;
&#125;</code></pre>
<p>
</td>
<td id="lov" width="50%" height=90% align="left">
 
<div id="vis944"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "data": {"url": "/assets/data/movies.json"},
    "mark": "bar",
    "encoding": {
        "x": {
            "bin": true,
            "field": "IMDB Rating"
        },
        "y": {"aggregate": "count"}
    }
    };
    vegaEmbed('#vis944', vlSpec, opt);
</script>
 
</td>
</tr></table>

<p>设置分箱的维度的<code>type</code>为<code>ordinal</code>, 会把分箱的范围当作刻度标签:</p>

<table id="lov"><tr>
<td id="lov" height=90% style="width:50%">
</p>
<pre><code class="language-json">&#123;
    &quot;data&quot;: &#123;&quot;url&quot;: &quot;/assets/data/movies.json&quot;&#125;,
    &quot;mark&quot;: &quot;bar&quot;,
    &quot;encoding&quot;: &#123;
        &quot;x&quot;: &#123;
            &quot;bin&quot;: true,
            &quot;field&quot;: &quot;IMDB Rating&quot;,
            &quot;type&quot;: &quot;ordinal&quot;
        &#125;,
        &quot;y&quot;: &#123;&quot;aggregate&quot;: &quot;count&quot;&#125;
    &#125;
&#125;</code></pre>
<p>
</td>
<td id="lov" width="50%" height=90% align="left">
 
<div id="vis945"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "data": {"url": "/assets/data/movies.json"},
    "mark": "bar",
    "encoding": {
        "x": {
            "bin": true,
            "field": "IMDB Rating",
            "type": "ordinal"
        },
        "y": {"aggregate": "count"}
    }
    };
    vegaEmbed('#vis945', vlSpec, opt);
</script>
 
</td>
</tr></table>

<p>可以用<code>bin</code>来分配热图颜色, 会自动创建图注:</p>

<table id="lov"><tr>
<td id="lov" height=90% style="width:50%">
</p>
<pre><code class="language-json">&#123;
    &quot;data&quot;: &#123;&quot;url&quot;: &quot;/assets/data/cars.json&quot;&#125;,
    &quot;mark&quot;: &quot;point&quot;,
    &quot;encoding&quot;: &#123;
        &quot;x&quot;: &#123;&quot;field&quot;: &quot;Horsepower&quot;, &quot;type&quot;: &quot;quantitative&quot;&#125;,
        &quot;y&quot;: &#123;&quot;field&quot;: &quot;Miles_per_Gallon&quot;, &quot;type&quot;: &quot;quantitative&quot;&#125;,
        &quot;color&quot;: &#123;&quot;bin&quot;: true, &quot;field&quot;: &quot;Acceleration&quot;&#125;
    &#125;
&#125;</code></pre>
<p>
</td>
<td id="lov" width="50%" height=90% align="left">
 
<div id="vis325"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "data": {"url": "/assets/data/cars.json"},
    "mark": "point",
    "encoding": {
        "x": {"field": "Horsepower", "type": "quantitative"},
        "y": {"field": "Miles_per_Gallon", "type": "quantitative"},
        "color": {"bin": true, "field": "Acceleration"}
    }
    };
    vegaEmbed('#vis325', vlSpec, opt);
</script>
 
</td>
</tr></table>

<p>直接导入已经分箱好的数据:</p>

<table id="lov"><tr>
<td id="lov" height=90% style="width:50%">
</p>
<pre><code class="language-json">&#123;
    &quot;data&quot;: &#123;
        &quot;values&quot;: &#91;
        &#123;&quot;bin_start&quot;: 8, &quot;bin_end&quot;: 10, &quot;count&quot;: 7&#125;,
        &#123;&quot;bin_start&quot;: 10, &quot;bin_end&quot;: 12, &quot;count&quot;: 29&#125;,
        &#123;&quot;bin_start&quot;: 12, &quot;bin_end&quot;: 14, &quot;count&quot;: 71&#125;,
        &#123;&quot;bin_start&quot;: 14, &quot;bin_end&quot;: 16, &quot;count&quot;: 127&#125;,
        &#123;&quot;bin_start&quot;: 16, &quot;bin_end&quot;: 18, &quot;count&quot;: 94&#125;,
        &#123;&quot;bin_start&quot;: 18, &quot;bin_end&quot;: 20, &quot;count&quot;: 54&#125;,
        &#123;&quot;bin_start&quot;: 20, &quot;bin_end&quot;: 22, &quot;count&quot;: 17&#125;,
        &#123;&quot;bin_start&quot;: 22, &quot;bin_end&quot;: 24, &quot;count&quot;: 5&#125;
        &#93;
    &#125;,
    &quot;mark&quot;: &quot;bar&quot;,
    &quot;encoding&quot;: &#123;
        // 注意这里的用法, binned, x2
        &quot;x&quot;: &#123;
        &quot;field&quot;: &quot;bin_start&quot;,
        &quot;bin&quot;: &#123;&quot;binned&quot;: true, &quot;step&quot;: 2&#125;
        &#125;,
        &quot;x2&quot;: &#123;&quot;field&quot;: &quot;bin_end&quot;&#125;,
        &quot;y&quot;: &#123;
        &quot;field&quot;: &quot;count&quot;,
        &quot;type&quot;: &quot;quantitative&quot;
        &#125;
    &#125;
&#125;</code></pre>
<p>
</td>
<td id="lov" width="50%" height=90% align="left">
 
<div id="vis368"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "data": {
        "values": [
        {"bin_start": 8, "bin_end": 10, "count": 7},
        {"bin_start": 10, "bin_end": 12, "count": 29},
        {"bin_start": 12, "bin_end": 14, "count": 71},
        {"bin_start": 14, "bin_end": 16, "count": 127},
        {"bin_start": 16, "bin_end": 18, "count": 94},
        {"bin_start": 18, "bin_end": 20, "count": 54},
        {"bin_start": 20, "bin_end": 22, "count": 17},
        {"bin_start": 22, "bin_end": 24, "count": 5}
        ]
    },
    "mark": "bar",
    "encoding": {
        "x": {
        "field": "bin_start",
        "bin": {"binned": true, "step": 2}
        },
        "x2": {"field": "bin_end"},
        "y": {
        "field": "count",
        "type": "quantitative"
        }
    }
    };
    vegaEmbed('#vis368', vlSpec, opt);
</script>
 
</td>
</tr></table>

<h4 id="transform中使用bin"><a href="#transform中使用bin" class="header-anchor">transform中使用bin</a></h4>
<pre><code class="language-json">// Any View Specification
&#123;
    ...
    &quot;transform&quot;: &#91;
        &#123;&quot;bin&quot;: ..., &quot;field&quot;: ..., &quot;as&quot; ...&#125; // Bin Transform
        ...
    &#93;,
    ...
&#125;</code></pre>
<p><code>transform</code>中使用bin, 有<code>bin, field, as</code>三个可选属性参数.</p>
<p>例子: 用bin生成新的列</p>

<table id="lov"><tr>
<td id="lov" height=90% style="width:50%">
</p>
<pre><code class="language-json">&#123;
  &quot;data&quot;: &#123;&quot;url&quot;: &quot;/assets/data/movies.json&quot;&#125;,
  &quot;transform&quot;: &#91;
    &#123;
      &quot;bin&quot;: true,
      &quot;field&quot;: &quot;IMDB Rating&quot;,
      &quot;as&quot;: &quot;binned rating&quot;
    &#125;
  &#93;,
  &quot;mark&quot;: &quot;bar&quot;,
  &quot;encoding&quot;: &#123;
    &quot;x&quot;: &#123;
      &quot;field&quot;: &quot;binned rating&quot;,
      &quot;title&quot;: &quot;IMDB Rating &#40;binned&#41;&quot;,
      &quot;bin&quot;: &#123;
        &quot;binned&quot;: true,
        &quot;step&quot;: 1
      &#125;
    &#125;,
    &quot;x2&quot;: &#123;&quot;field&quot;: &quot;binned rating_end&quot;&#125;,
    &quot;y&quot;: &#123;&quot;aggregate&quot;: &quot;count&quot;&#125;
  &#125;
&#125;</code></pre>
<p>
</td>
<td id="lov" width="50%" height=90% align="left">
 
<div id="vis464"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "data": {"url": "/assets/data/movies.json"},
  "transform": [
    {
      "bin": true,
      "field": "IMDB Rating",
      "as": "binned rating"
    }
  ],
  "mark": "bar",
  "encoding": {
    "x": {
      "field": "binned rating",
      "title": "IMDB Rating (binned)",
      "bin": {
        "binned": true,
        "step": 1
      }
    },
    "x2": {"field": "binned rating_end"},
    "y": {"aggregate": "count"}
  }
    };
    vegaEmbed('#vis464', vlSpec, opt);
</script>
 
</td>
</tr></table>

<h4 id="bin的可选参数"><a href="#bin的可选参数" class="header-anchor">Bin的可选参数</a></h4>
<table><tr><th align="left">Property</th><th align="left">Type</th><th align="left">Description</th></tr><tr><td align="left">anchor</td><td align="left">Number</td><td align="left">A value in the binned domain at which to anchor the bins, shifting the bin boundaries if necessary to ensure that a boundary aligns with the anchor value. <strong>Default value:</strong> the minimum bin extent value</td></tr><tr><td align="left">base</td><td align="left">Number</td><td align="left">The number base to use for automatic bin determination &#40;default is base 10&#41;. <strong>Default value:</strong> 10</td></tr><tr><td align="left">divide</td><td align="left">Number&#91;&#93;</td><td align="left">Scale factors indicating allowable subdivisions. The default value is &#91;5, 2&#93;, which indicates that for base 10 numbers &#40;the default base&#41;, the method may consider dividing bin sizes by 5 and/or 2. For example, for an initial step size of 10, the method can check if bin sizes of 2 &#40;&#61; 10/5&#41;, 5 &#40;&#61; 10/2&#41;, or 1 &#40;&#61; 10/&#40;5*2&#41;&#41; might also satisfy the given constraints. <strong>Default value:</strong> &#91;5, 2&#93;</td></tr><tr><td align="left">extent</td><td align="left">Array</td><td align="left">A two-element &#40;&#91;min, max&#93;&#41; array indicating the range of desired bin values.</td></tr><tr><td align="left">maxbins</td><td align="left">Number</td><td align="left">Maximum number of bins. <strong>Default value:</strong> 6 for row, column and shape channels; 10 for other channels</td></tr><tr><td align="left">minstep</td><td align="left">Number</td><td align="left">A minimum allowable step size &#40;particularly useful for integer values&#41;.</td></tr><tr><td align="left">nice</td><td align="left">Boolean</td><td align="left">If true, attempts to make the bin boundaries use human-friendly boundaries, such as multiples of ten. <strong>Default value:</strong> true</td></tr><tr><td align="left">step</td><td align="left">Number</td><td align="left">An exact step size to use between bins. Note: If provided, options such as maxbins will be ignored.</td></tr><tr><td align="left">steps</td><td align="left">Number&#91;&#93;</td><td align="left">An array of allowable step sizes to choose from.</td></tr><tr><td align="left"></td><td align="left"></td><td align="left"></td></tr></table>
<p>示例: 更改最大分箱数目<code>maxbins</code>:</p>

<table id="lov"><tr>
<td id="lov" height=90% style="width:50%">
</p>
<pre><code class="language-json">&#123;
  &quot;data&quot;: &#123;&quot;url&quot;: &quot;/assets/data/movies.json&quot;&#125;,
  &quot;mark&quot;: &quot;bar&quot;,
  &quot;encoding&quot;: &#123;
    &quot;x&quot;: &#123;
      &quot;bin&quot;: &#123;&quot;maxbins&quot;: 30&#125;,
      &quot;field&quot;: &quot;IMDB Rating&quot;
    &#125;,
    &quot;y&quot;: &#123;&quot;aggregate&quot;: &quot;count&quot;&#125;
  &#125;
&#125;</code></pre>
<p>
</td>
<td id="lov" width="50%" height=90% align="left">
 
<div id="vis521"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "data": {"url": "/assets/data/movies.json"},
  "mark": "bar",
  "encoding": {
    "x": {
      "bin": {"maxbins": 30},
      "field": "IMDB Rating"
    },
    "y": {"aggregate": "count"}
  }
    };
    vegaEmbed('#vis521', vlSpec, opt);
</script>
 
</td>
</tr></table>

<h4 id="分箱排序"><a href="#分箱排序" class="header-anchor">分箱排序</a></h4>
<p>如果需要对分箱结果进行排序, 可以设置<code>&quot;type&quot;:&quot;ordinal&quot;</code>:</p>

<table id="lov"><tr>
<td id="lov" height=90% style="width:50%">
</p>
<pre><code class="language-json">&#123;
  &quot;data&quot;: &#123;&quot;url&quot;: &quot;/assets/data/movies.json&quot;&#125;,
  &quot;mark&quot;: &quot;bar&quot;,
  &quot;encoding&quot;: &#123;
    &quot;x&quot;: &#123;
      &quot;bin&quot;: true,
      &quot;field&quot;: &quot;IMDB Rating&quot;,
      &quot;type&quot;: &quot;ordinal&quot;,
      &quot;sort&quot;: &#123;
        &quot;op&quot;: &quot;count&quot;,
        &quot;order&quot;: &quot;descending&quot;
      &#125;
    &#125;,
    &quot;y&quot;: &#123;&quot;aggregate&quot;: &quot;count&quot;&#125;
  &#125;
&#125;</code></pre>
<p>
</td>
<td id="lov" width="50%" height=90% align="left">
 
<div id="vis558"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "data": {"url": "/assets/data/movies.json"},
  "mark": "bar",
  "encoding": {
    "x": {
      "bin": true,
      "field": "IMDB Rating",
      "type": "ordinal",
      "sort": {
        "op": "count",
        "order": "descending"
      }
    },
    "y": {"aggregate": "count"}
  }
    };
    vegaEmbed('#vis558', vlSpec, opt);
</script>
 
</td>
</tr></table>

<h3 id="calculate"><a href="#calculate" class="header-anchor">Calculate</a></h3>
<pre><code class="language-json">// Any View Specification
&#123;
  ...
  &quot;transform&quot;: &#91;
    &#123;&quot;calculate&quot;: ..., &quot;as&quot; ...&#125; // Calculate Transform
     ...
  &#93;,
  ...
&#125;</code></pre>
<p>两个属性: <code>calculate, as</code></p>
<p><code>calculate</code>支持传入数据的列组成的表达式, 需要用<code>datum</code>代表传入数据, 比如<code>2*datum.col1&#43;datum.col2</code>. 支持的表达式很多, 这里不展开了, 请参考<a href="https://vega.github.io/vega/docs/expressions/">Vega表达式</a>.</p>

<table id="lov"><tr>
<td id="lov" height=90% style="width:50%">
</p>
<pre><code class="language-json">&#123;
  &quot;data&quot;: &#123;
    &quot;values&quot;: &#91;
      &#123;&quot;a&quot;: &quot;A&quot;, &quot;b&quot;: 28&#125;,
      &#123;&quot;a&quot;: &quot;B&quot;, &quot;b&quot;: 55&#125;,
      &#123;&quot;a&quot;: &quot;C&quot;, &quot;b&quot;: 43&#125;,
      &#123;&quot;a&quot;: &quot;G&quot;, &quot;b&quot;: 19&#125;,
      &#123;&quot;a&quot;: &quot;H&quot;, &quot;b&quot;: 87&#125;,
      &#123;&quot;a&quot;: &quot;I&quot;, &quot;b&quot;: 52&#125;,
      &#123;&quot;a&quot;: &quot;D&quot;, &quot;b&quot;: 91&#125;,
      &#123;&quot;a&quot;: &quot;E&quot;, &quot;b&quot;: 81&#125;,
      &#123;&quot;a&quot;: &quot;F&quot;, &quot;b&quot;: 53&#125;
    &#93;
  &#125;,
  &quot;transform&quot;: &#91;
    &#123;&quot;calculate&quot;: &quot;2*datum.b&quot;, &quot;as&quot;: &quot;b2&quot;&#125;,
    &#123;&quot;filter&quot;: &quot;datum.b2 &gt; 60&quot;&#125;
  &#93;,
  &quot;mark&quot;: &quot;bar&quot;,
  &quot;encoding&quot;: &#123;
    &quot;y&quot;: &#123;&quot;field&quot;: &quot;b2&quot;, &quot;type&quot;: &quot;quantitative&quot;&#125;,
    &quot;x&quot;: &#123;&quot;field&quot;: &quot;a&quot;, &quot;type&quot;: &quot;ordinal&quot;&#125;
  &#125;
&#125;</code></pre>
<p>
</td>
<td id="lov" width="50%" height=90% align="left">
 
<div id="vis624"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "data": {
    "values": [
      {"a": "A", "b": 28},
      {"a": "B", "b": 55},
      {"a": "C", "b": 43},
      {"a": "G", "b": 19},
      {"a": "H", "b": 87},
      {"a": "I", "b": 52},
      {"a": "D", "b": 91},
      {"a": "E", "b": 81},
      {"a": "F", "b": 53}
    ]
  },
  "transform": [
    {"calculate": "2*datum.b", "as": "b2"},
    {"filter": "datum.b2 > 60"}
  ],
  "mark": "bar",
  "encoding": {
    "y": {"field": "b2", "type": "quantitative"},
    "x": {"field": "a", "type": "ordinal"}
  }
    };
    vegaEmbed('#vis624', vlSpec, opt);
</script>
 
</td>
</tr></table>

<h3 id="density"><a href="#density" class="header-anchor">Density</a></h3>
<p>指定维度计算<a href="https://en.wikipedia.org/wiki/Kernel_density_estimation">核密度估计</a>, 生成密度分布曲线.</p>
<pre><code class="language-json">/ Any View Specification
&#123;
  ...
  &quot;transform&quot;: &#91;
    &#123;&quot;density&quot;: ...&#125; // Density Transform
     ...
  &#93;,
  ...
&#125;</code></pre>
<h4 id="density参数"><a href="#density参数" class="header-anchor">density参数</a></h4>
<table><tr><th align="left">Property</th><th align="left">Type</th><th align="left">Description</th></tr><tr><td align="left">density</td><td align="left">String</td><td align="left">Required. The data field for which to perform density estimation.</td></tr><tr><td align="left">groupby</td><td align="left">String&#91;&#93;</td><td align="left">The data fields to group by. If not specified, a single group containing all data objects will be used.</td></tr><tr><td align="left">cumulative</td><td align="left">Boolean</td><td align="left">A boolean flag indicating whether to produce density estimates &#40;false&#41; or cumulative density estimates &#40;true&#41;. <strong>Default value:</strong> false</td></tr><tr><td align="left">counts</td><td align="left">Boolean</td><td align="left">A boolean flag indicating if the output values should be probability estimates &#40;false&#41; or smoothed counts &#40;true&#41;. <strong>Default value:</strong> false</td></tr><tr><td align="left">bandwidth</td><td align="left">Number</td><td align="left">The bandwidth &#40;standard deviation&#41; of the Gaussian kernel. If unspecified or set to zero, the bandwidth value is automatically estimated from the input data using Scott’s rule.</td></tr><tr><td align="left">extent</td><td align="left">Number&#91;&#93;</td><td align="left">A &#91;min, max&#93; domain from which to sample the distribution. If unspecified, the extent will be determined by the observed minimum and maximum values of the density value field.</td></tr><tr><td align="left">minsteps</td><td align="left">Number</td><td align="left">The minimum number of samples to take along the extent domain for plotting the density. <strong>Default value:</strong> 25</td></tr><tr><td align="left">maxsteps</td><td align="left">Number</td><td align="left">The maximum number of samples to take along the extent domain for plotting the density. <strong>Default value:</strong> 200</td></tr><tr><td align="left">steps</td><td align="left">Number</td><td align="left">The exact number of samples to take along the extent domain for plotting the density. If specified, overrides both minsteps and maxsteps to set an exact number of uniform samples. Potentially useful in conjunction with a fixed extent to ensure consistent sample points for stacked densities.</td></tr><tr><td align="left">as</td><td align="left">String&#91;&#93;</td><td align="left">The output fields for the sample value and corresponding density estimate. <strong>Default value:</strong> &#91;&quot;value&quot;, &quot;density&quot;&#93;</td></tr></table>
<p>示例1: 简单的密度图</p>

<table id="lov"><tr>
<td id="lov" height=90% style="width:50%">
</p>
<pre><code class="language-json">&#123;
  &quot;data&quot;: &#123;
    &quot;url&quot;: &quot;/assets/data/movies.json&quot;
  &#125;,
  &quot;width&quot;: 400,
  &quot;height&quot;: 400,
  &quot;transform&quot;:&#91;&#123;
    &quot;density&quot;: &quot;IMDB Rating&quot;,
    &quot;bandwidth&quot;: 0.3
  &#125;&#93;,
  &quot;mark&quot;: &quot;area&quot;,
  &quot;encoding&quot;: &#123;
    &quot;x&quot;: &#123;
      &quot;field&quot;: &quot;value&quot;,
      &quot;title&quot;: &quot;IMDB Rating&quot;,
      &quot;type&quot;: &quot;quantitative&quot;
    &#125;,
    &quot;y&quot;: &#123;
      &quot;field&quot;: &quot;density&quot;,
      &quot;type&quot;: &quot;quantitative&quot;
    &#125;
  &#125;
&#125;</code></pre>
<p>
</td>
<td id="lov" width="50%" height=90% align="left">
 
<div id="vis710"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "data": {
    "url": "/assets/data/movies.json"
  },
  "width": 400,
  "height": 400,
  "transform":[{
    "density": "IMDB Rating",
    "bandwidth": 0.3
  }],
  "mark": "area",
  "encoding": {
    "x": {
      "field": "value",
      "title": "IMDB Rating",
      "type": "quantitative"
    },
    "y": {
      "field": "density",
      "type": "quantitative"
    }
  }
    };
    vegaEmbed('#vis710', vlSpec, opt);
</script>
 
</td>
</tr></table>

<p>示例2: 分组堆叠密度图: <code>group</code>分组, <code>extent</code>限定范围, 在<code>encoding</code>中设置按照分组列上色</p>

<table id="lov"><tr>
<td id="lov" height=90% style="width:50%">
</p>
<pre><code class="language-json">&#123;
  &quot;title&quot;: &quot;Distribution of Body Mass of Penguins&quot;,
  &quot;width&quot;: 400,
  &quot;height&quot;: 300,
  &quot;data&quot;: &#123;
    &quot;url&quot;: &quot;/assets/data/penguins.json&quot;
  &#125;,
  &quot;mark&quot;: &quot;area&quot;,
  &quot;transform&quot;: &#91;
    &#123;
      &quot;density&quot;: &quot;Body Mass &#40;g&#41;&quot;,
      &quot;groupby&quot;: &#91;&quot;Species&quot;&#93;,
      &quot;extent&quot;: &#91;2500, 6500&#93;
    &#125;
  &#93;,
  &quot;encoding&quot;: &#123;
    &quot;x&quot;: &#123;&quot;field&quot;: &quot;value&quot;, &quot;type&quot;: &quot;quantitative&quot;, &quot;title&quot;: &quot;Body Mass &#40;g&#41;&quot;&#125;,
    &quot;y&quot;: &#123;&quot;field&quot;: &quot;density&quot;, &quot;type&quot;: &quot;quantitative&quot;, &quot;stack&quot;: &quot;zero&quot;&#125;,
    &quot;color&quot;: &#123;&quot;field&quot;: &quot;Species&quot;, &quot;type&quot;: &quot;nominal&quot;&#125;
  &#125;
&#125;</code></pre>
<p>
</td>
<td id="lov" width="50%" height=90% align="left">
 
<div id="vis763"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "title": "Distribution of Body Mass of Penguins",
  "width": 400,
  "height": 300,
  "data": {
    "url": "/assets/data/penguins.json"
  },
  "mark": "area",
  "transform": [
    {
      "density": "Body Mass (g)",
      "groupby": ["Species"],
      "extent": [2500, 6500]
    }
  ],
  "encoding": {
    "x": {"field": "value", "type": "quantitative", "title": "Body Mass (g)"},
    "y": {"field": "density", "type": "quantitative", "stack": "zero"},
    "color": {"field": "Species", "type": "nominal"}
  }
    };
    vegaEmbed('#vis763', vlSpec, opt);
</script>
 
</td>
</tr></table>

<p>示例3: 分面 在<code>encoding</code>中设置按照分组列画Y轴</p>

<table id="lov"><tr>
<td id="lov" height=90% style="width:50%">
</p>
<pre><code class="language-json">&#123;
  &quot;title&quot;: &quot;Distribution of Body Mass of Penguins&quot;,
  &quot;width&quot;: 400,
  &quot;height&quot;: 80,
  &quot;data&quot;: &#123;
    &quot;url&quot;: &quot;/assets/data/penguins.json&quot;
  &#125;,
  &quot;mark&quot;: &quot;area&quot;,
  &quot;transform&quot;: &#91;
    &#123;
      &quot;density&quot;: &quot;Body Mass &#40;g&#41;&quot;,
      &quot;groupby&quot;: &#91;&quot;Species&quot;&#93;,
      &quot;extent&quot;: &#91;2500, 6500&#93;
    &#125;
  &#93;,
  &quot;encoding&quot;: &#123;
    &quot;x&quot;: &#123;&quot;field&quot;: &quot;value&quot;, &quot;type&quot;: &quot;quantitative&quot;, &quot;title&quot;: &quot;Body Mass &#40;g&#41;&quot;&#125;,
    &quot;y&quot;: &#123;&quot;field&quot;: &quot;density&quot;, &quot;type&quot;: &quot;quantitative&quot;, &quot;stack&quot;: &quot;zero&quot;&#125;,
    &quot;row&quot;: &#123;&quot;field&quot;: &quot;Species&quot;&#125;
  &#125;
&#125;</code></pre>
<p>
</td>
<td id="lov" width="50%" height=90% align="left">
 
<div id="vis815"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "title": "Distribution of Body Mass of Penguins",
  "width": 400,
  "height": 80,
  "data": {
    "url": "/assets/data/penguins.json"
  },
  "mark": "area",
  "transform": [
    {
      "density": "Body Mass (g)",
      "groupby": ["Species"],
      "extent": [2500, 6500]
    }
  ],
  "encoding": {
    "x": {"field": "value", "type": "quantitative", "title": "Body Mass (g)"},
    "y": {"field": "density", "type": "quantitative", "stack": "zero"},
    "row": {"field": "Species"}
  }
    };
    vegaEmbed('#vis815', vlSpec, opt);
</script>
 
</td>
</tr></table>

<h3 id="filter"><a href="#filter" class="header-anchor">Filter</a></h3>
<p>根据指定规则过滤数据:</p>
<pre><code class="language-json">// Any View Specification
&#123;
  ...
  &quot;transform&quot;: &#91;
    &#123;&quot;filter&quot;: ...&#125; // Filter Transform
     ...
  &#93;,
  ...
&#125;</code></pre>
<p><code>filter</code>接收<a href="https://vega.github.io/vega-lite/docs/predicate.html">Predicate</a>格式的传入, 可以是:</p>
<ul>
<li><p>expression: 例如<code>&#123;filter: &quot;datum.b2 &gt; 60&quot;&#125;</code></p>
</li>
<li><p>field predicates: <code>equal, lt, lte, gt, gte, range, oneOf, valid</code>, 具体参考<a href="https://vega.github.io/vega-lite/docs/predicate.html#field-predicate">field predicates</a></p>
</li>
<li><p>selection predicate: 选择条件的名字, 或者逻辑组合, 参考<a href="https://vega.github.io/vega-lite/docs/predicate.html#selection-predicate">selection predicate</a></p>
</li>
<li><p>上述条件的逻辑组合, <code>and, or, not</code>, 参考<a href="https://vega.github.io/vega-lite/docs/predicate.html#composition">logical composition</a></p>
</li>
</ul>
<h3 id="flatten"><a href="#flatten" class="header-anchor">Flatten</a></h3>
<p>把向量转换成列表形式: 转换逻辑是一一对应, 如果不等长, 短的那个用<code>null</code>补齐</p>
<pre><code class="language-json">//对于如下表:
&#91;
  &#123;&quot;key&quot;: &quot;alpha&quot;, &quot;foo&quot;: &#91;1, 2&#93;, &quot;bar&quot;: &#91;&quot;A&quot;, &quot;B&quot;&#93;&#125;,
  &#123;&quot;key&quot;: &quot;beta&quot;, &quot;foo&quot;: &#91;3, 4, 5&#93;, &quot;bar&quot;: &#91;&quot;C&quot;, &quot;D&quot;&#93;&#125;
&#93;

//应用flatten:
&#123;&quot;flatten&quot;: &#91;&quot;foo&quot;, &quot;bar&quot;&#93;&#125;

//变成如下表:
&#91;
  &#123;&quot;key&quot;: &quot;alpha&quot;, &quot;foo&quot;: 1, &quot;bar&quot;: &quot;A&quot;&#125;,
  &#123;&quot;key&quot;: &quot;alpha&quot;, &quot;foo&quot;: 2, &quot;bar&quot;: &quot;B&quot;&#125;,
  &#123;&quot;key&quot;: &quot;beta&quot;, &quot;foo&quot;: 3, &quot;bar&quot;: &quot;C&quot;&#125;,
  &#123;&quot;key&quot;: &quot;beta&quot;, &quot;foo&quot;: 4, &quot;bar&quot;: &quot;D&quot;&#125;,
  &#123;&quot;key&quot;: &quot;beta&quot;, &quot;foo&quot;: 5, &quot;bar&quot;: null&#125;
&#93;</code></pre>
<p>一个进阶用法的例子 &#40;mark, 有点复杂 我还没看&#41;: 
<table id="lov"><tr>
<td id="lov" height=90% style="width:50%">
</p>
<pre><code class="language-json">&#123;
  &quot;data&quot;: &#123;
    &quot;values&quot;: &#91;
      &#123; &quot;id&quot;: &quot;001&quot;,
        &quot;ra&quot;: 243.35,
        &quot;dec&quot;: &quot;&#43;54.6&quot;,
        &quot;lc&quot;: &#91;&#123;&quot;time&quot;: 1, &quot;mag&quot;: 18.5&#125;, &#123;&quot;time&quot;: 2, &quot;mag&quot;: 19&#125;&#93;
      &#125;,
      &#123; &quot;id&quot;: &quot;002&quot;,
        &quot;ra&quot;: 210.35,
        &quot;dec&quot;: &quot;&#43;14.6&quot;,
        &quot;lc&quot;: &#91;&#123;&quot;time&quot;: 1, &quot;mag&quot;: 19.5&#125;, &#123;&quot;time&quot;: 2, &quot;mag&quot;: 20&#125;&#93;
      &#125;,
      &#123; &quot;id&quot;: &quot;003&quot;,
        &quot;ra&quot;: 143.35,
        &quot;dec&quot;: &quot;&#43;33.6&quot;,
        &quot;lc&quot;: &#91;&#123;&quot;time&quot;: 1, &quot;mag&quot;: 19&#125;, &#123;&quot;time&quot;: 2, &quot;mag&quot;: 18&#125;&#93;
      &#125;
    &#93;
  &#125;,
  &quot;transform&quot;: &#91;
    &#123;&quot;flatten&quot;: &#91;&quot;lc&quot;&#93;&#125;
  &#93;,
  &quot;vconcat&quot;: &#91;
    &#123;
      &quot;width&quot;: 300,
      &quot;height&quot;: 200,
      &quot;title&quot;: &quot;Sky position&quot;,
      &quot;transform&quot;: &#91;&#123;&quot;aggregate&quot;: &#91;&#93;, &quot;groupby&quot;: &#91;&quot;ra&quot;, &quot;dec&quot;, &quot;id&quot;&#93;&#125;&#93;,
      &quot;mark&quot;: &quot;circle&quot;,
      &quot;params&quot;: &#91;&#123;
        &quot;name&quot;: &quot;pts&quot;,
        &quot;select&quot;: &#123;&quot;type&quot;: &quot;point&quot;, &quot;fields&quot;: &#91;&quot;id&quot;&#93;&#125;
      &#125;&#93;,
      &quot;encoding&quot;: &#123;
        &quot;x&quot;: &#123;&quot;field&quot;: &quot;ra&quot;, &quot;type&quot;: &quot;quantitative&quot;, &quot;scale&quot;: &#123;&quot;zero&quot;: false&#125;&#125;,
        &quot;y&quot;: &#123;&quot;field&quot;: &quot;dec&quot;, &quot;type&quot;: &quot;quantitative&quot;&#125;,
        &quot;color&quot;: &#123;
          &quot;condition&quot;: &#123;&quot;param&quot;: &quot;pts&quot;, &quot;value&quot;: &quot;steelblue&quot;&#125;,
          &quot;value&quot;: &quot;grey&quot;
        &#125;,
        &quot;size&quot;: &#123;&quot;value&quot;: 100&#125;
      &#125;
    &#125;,
    &#123;
      &quot;width&quot;: 300,
      &quot;height&quot;: 200,
      &quot;title&quot;: &quot;Light curve&quot;,
      &quot;transform&quot;: &#91;&#123;&quot;filter&quot;: &#123;&quot;param&quot;: &quot;pts&quot;&#125;&#125;&#93;,
      &quot;mark&quot;: &quot;line&quot;,
      &quot;encoding&quot;: &#123;
        &quot;x&quot;: &#123;
          &quot;field&quot;: &quot;lc.time&quot;,
          &quot;type&quot;: &quot;quantitative&quot;,
          &quot;scale&quot;: &#123;&quot;zero&quot;: false&#125;
        &#125;,
        &quot;y&quot;: &#123;&quot;field&quot;: &quot;lc.mag&quot;, &quot;type&quot;: &quot;quantitative&quot;&#125;,
        &quot;color&quot;: &#123;&quot;value&quot;: &quot;steelblue&quot;&#125;,
        &quot;detail&quot;: &#123;&quot;field&quot;: &quot;id&quot;, &quot;type&quot;: &quot;nominal&quot;&#125;
      &#125;
    &#125;
  &#93;
&#125;</code></pre>
<p>
</td>
<td id="lov" width="50%" height=90% align="left">
 
<div id="vis957"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "data": {
    "values": [
      { "id": "001",
        "ra": 243.35,
        "dec": "+54.6",
        "lc": [{"time": 1, "mag": 18.5}, {"time": 2, "mag": 19}]
      },
      { "id": "002",
        "ra": 210.35,
        "dec": "+14.6",
        "lc": [{"time": 1, "mag": 19.5}, {"time": 2, "mag": 20}]
      },
      { "id": "003",
        "ra": 143.35,
        "dec": "+33.6",
        "lc": [{"time": 1, "mag": 19}, {"time": 2, "mag": 18}]
      }
    ]
  },
  "transform": [
    {"flatten": ["lc"]}
  ],
  "vconcat": [
    {
      "width": 300,
      "height": 200,
      "title": "Sky position",
      "transform": [{"aggregate": [], "groupby": ["ra", "dec", "id"]}],
      "mark": "circle",
      "params": [{
        "name": "pts",
        "select": {"type": "point", "fields": ["id"]}
      }],
      "encoding": {
        "x": {"field": "ra", "type": "quantitative", "scale": {"zero": false}},
        "y": {"field": "dec", "type": "quantitative"},
        "color": {
          "condition": {"param": "pts", "value": "steelblue"},
          "value": "grey"
        },
        "size": {"value": 100}
      }
    },
    {
      "width": 300,
      "height": 200,
      "title": "Light curve",
      "transform": [{"filter": {"param": "pts"}}],
      "mark": "line",
      "encoding": {
        "x": {
          "field": "lc.time",
          "type": "quantitative",
          "scale": {"zero": false}
        },
        "y": {"field": "lc.mag", "type": "quantitative"},
        "color": {"value": "steelblue"},
        "detail": {"field": "id", "type": "nominal"}
      }
    }
  ]
    };
    vegaEmbed('#vis957', vlSpec, opt);
</script>
 
</td>
</tr></table>
</p>
<h3 id="fold"><a href="#fold" class="header-anchor">Fold</a></h3>
<p><code>fold</code>: 把指定列&#40;可以是多列&#41;转换成&quot;key-value&quot;对, 类似于宽表变长表</p>
<pre><code class="language-json">//原表
&#91;
  &#123;&quot;country&quot;: &quot;USA&quot;, &quot;gold&quot;: 10, &quot;silver&quot;: 20&#125;,
  &#123;&quot;country&quot;: &quot;Canada&quot;, &quot;gold&quot;: 7, &quot;silver&quot;: 26&#125;
&#93;

// 折叠这两列
&#123;&quot;fold&quot;: &#91;&quot;gold&quot;, &quot;silver&quot;&#93;&#125;


//新表: 这两列都变成key-value了
&#91;
  &#123;&quot;key&quot;: &quot;gold&quot;, &quot;value&quot;: 10, &quot;country&quot;: &quot;USA&quot;, &quot;gold&quot;: 10, &quot;silver&quot;: 20&#125;,
  &#123;&quot;key&quot;: &quot;silver&quot;, &quot;value&quot;: 20, &quot;country&quot;: &quot;USA&quot;, &quot;gold&quot;: 10, &quot;silver&quot;: 20&#125;,
  &#123;&quot;key&quot;: &quot;gold&quot;, &quot;value&quot;: 7, &quot;country&quot;: &quot;Canada&quot;, &quot;gold&quot;: 7, &quot;silver&quot;: 26&#125;,
  &#123;&quot;key&quot;: &quot;silver&quot;, &quot;value&quot;: 26, &quot;country&quot;: &quot;Canada&quot;, &quot;gold&quot;: 7, &quot;silver&quot;: 26&#125;
&#93;</code></pre>
<h3 id="impute"><a href="#impute" class="header-anchor">Impute</a></h3>
<p>这个是对数据进行补齐处理的, 我的应用场景, 不太需要用<code>Vega-Lite</code>进行数据处理, 所以先不学习这块。</p>

<fieldset class="admon admon-todo">
<legend class="admon-legend admon-legend-todo"> Todo</legend>
  补充<code>impute</code>的用法: <a href="https://vega.github.io/vega-lite/docs/impute.html">官方文档</a> 
</fieldset>

<h3 id="join_aggregate"><a href="#join_aggregate" class="header-anchor">Join Aggregate</a></h3>
<p>把<code>agggregate</code>操作生成的新列与原列进行<code>join</code>。</p>
<p>操作跟<code>aggregate</code>类似:</p>
<ul>
<li><p><code>joinaggregate</code>: 支持<code>op, field, as</code>属性</p>
</li>
<li><p><code>groupby</code></p>
</li>
</ul>
<p>一个例子: 偏离均值的程度 选取评分高于平均评分2.5分的电影:</p>

<table id="lov"><tr>
<td id="lov" height=90% style="width:50%">
</p>
<pre><code class="language-json">&#123;
  &quot;data&quot;: &#123;&quot;url&quot;: &quot;/assets/data/movies.json&quot;&#125;,
  &quot;transform&quot;: &#91;
    &#123;&quot;filter&quot;: &quot;datum&#91;&#39;IMDB Rating&#39;&#93; &#33;&#61; null&quot;&#125;,
    &#123;
      &quot;joinaggregate&quot;: &#91;&#123;
        &quot;op&quot;: &quot;mean&quot;,
        &quot;field&quot;: &quot;IMDB Rating&quot;,
        &quot;as&quot;: &quot;AverageRating&quot;
      &#125;&#93;
    &#125;,
    &#123;&quot;filter&quot;: &quot;&#40;datum&#91;&#39;IMDB Rating&#39;&#93; - datum.AverageRating&#41; &gt; 2.5&quot;&#125;
  &#93;,
  &quot;layer&quot;: &#91;
    &#123;
      &quot;mark&quot;: &quot;bar&quot;,
      &quot;encoding&quot;: &#123;
        &quot;x&quot;: &#123;
          &quot;field&quot;: &quot;IMDB Rating&quot;, &quot;type&quot;: &quot;quantitative&quot;,
          &quot;title&quot;: &quot;IMDB Rating&quot;
        &#125;,
        &quot;y&quot;: &#123;&quot;field&quot;: &quot;Title&quot;, &quot;type&quot;: &quot;ordinal&quot;&#125;
      &#125;
    &#125;,
    &#123;
      &quot;mark&quot;: &#123;&quot;type&quot;: &quot;rule&quot;, &quot;color&quot;: &quot;red&quot;&#125;,
      &quot;encoding&quot;: &#123;
        &quot;x&quot;: &#123;
          &quot;aggregate&quot;: &quot;average&quot;,
          &quot;field&quot;: &quot;AverageRating&quot;,
          &quot;type&quot;: &quot;quantitative&quot;
        &#125;
      &#125;
    &#125;
  &#93;
&#125;</code></pre>
<p>
</td>
<td id="lov" width="50%" height=90% align="left">
 
<div id="vis1107"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "data": {"url": "/assets/data/movies.json"},
  "transform": [
    {"filter": "datum['IMDB Rating'] != null"},
    {
      "joinaggregate": [{
        "op": "mean",
        "field": "IMDB Rating",
        "as": "AverageRating"
      }]
    },
    {"filter": "(datum['IMDB Rating'] - datum.AverageRating) > 2.5"}
  ],
  "layer": [
    {
      "mark": "bar",
      "encoding": {
        "x": {
          "field": "IMDB Rating", "type": "quantitative",
          "title": "IMDB Rating"
        },
        "y": {"field": "Title", "type": "ordinal"}
      }
    },
    {
      "mark": {"type": "rule", "color": "red"},
      "encoding": {
        "x": {
          "aggregate": "average",
          "field": "AverageRating",
          "type": "quantitative"
        }
      }
    }
  ]
    };
    vegaEmbed('#vis1107', vlSpec, opt);
</script>
 
</td>
</tr></table>

<p>或者, 不过滤, 而是把高于/低于均值的电影高亮出来: </p>

<table id="lov"><tr>
<td id="lov" height=90% style="width:50%">
</p>
<pre><code class="language-json">&#123;
  &quot;data&quot;: &#123;
    &quot;url&quot;: &quot;/assets/data/movies.json&quot;
  &#125;,
  &quot;transform&quot;: &#91;
    &#123;&quot;filter&quot;: &quot;datum&#91;&#39;IMDB Rating&#39;&#93; &#33;&#61; null&quot;&#125;,
    &#123;&quot;filter&quot;: &#123;&quot;timeUnit&quot;: &quot;year&quot;, 
      &quot;field&quot;: &quot;Release Date&quot;, &quot;range&quot;: &#91;null, 2019&#93;&#125;&#125;,
    &#123;
      &quot;joinaggregate&quot;: &#91;&#123;
        &quot;op&quot;: &quot;mean&quot;,
        &quot;field&quot;: &quot;IMDB Rating&quot;,
        &quot;as&quot;: &quot;AverageRating&quot;
      &#125;&#93;
    &#125;,
    &#123;
      &quot;calculate&quot;: &quot;datum&#91;&#39;IMDB Rating&#39;&#93; - datum.AverageRating&quot;,
      &quot;as&quot;: &quot;RatingDelta&quot;
    &#125;
  &#93;,
  &quot;mark&quot;: &quot;point&quot;,
  &quot;encoding&quot;: &#123;
    &quot;x&quot;: &#123;
      &quot;field&quot;: &quot;Release Date&quot;,
      &quot;type&quot;: &quot;temporal&quot;
    &#125;,
    &quot;y&quot;: &#123;
      &quot;field&quot;: &quot;RatingDelta&quot;,
      &quot;type&quot;: &quot;quantitative&quot;,
      &quot;title&quot;: &quot;Rating Delta&quot;
    &#125;,
    &quot;color&quot;: &#123;
      &quot;field&quot;: &quot;RatingDelta&quot;,
      &quot;type&quot;: &quot;quantitative&quot;,
      &quot;scale&quot;: &#123;&quot;domainMid&quot;: 0&#125;,
      &quot;title&quot;: &quot;Rating Delta&quot;
    &#125;
  &#125;
&#125;</code></pre>
<p>
</td>
<td id="lov" width="50%" height=90% align="left">
 
<div id="vis1190"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "data": {
    "url": "/assets/data/movies.json"
  },
  "transform": [
    {"filter": "datum['IMDB Rating'] != null"},
    {"filter": {"timeUnit": "year", "field": "Release Date", "range": [null, 2019]}},
    {
      "joinaggregate": [{
        "op": "mean",
        "field": "IMDB Rating",
        "as": "AverageRating"
      }]
    },
    {
      "calculate": "datum['IMDB Rating'] - datum.AverageRating",
      "as": "RatingDelta"
    }
  ],
  "mark": "point",
  "encoding": {
    "x": {
      "field": "Release Date",
      "type": "temporal"
    },
    "y": {
      "field": "RatingDelta",
      "type": "quantitative",
      "title": "Rating Delta"
    },
    "color": {
      "field": "RatingDelta",
      "type": "quantitative",
      "scale": {"domainMid": 0},
      "title": "Rating Delta"
    }
  }
    };
    vegaEmbed('#vis1190', vlSpec, opt);
</script>
 
</td>
</tr></table>

<h3 id="loess"><a href="#loess" class="header-anchor">Loess</a></h3>
<p>局部加权回归Loess进行平滑操作:生成趋势线</p>
<table><tr><th align="left">P</th><th align="left">T</th><th align="left">D</th></tr><tr><td align="left">loess</td><td align="left">String</td><td align="left">需要loess的数据列</td></tr><tr><td align="left">on</td><td align="left">String</td><td align="left">自变量列</td></tr><tr><td align="left">groupby</td><td align="left">String&#91;&#93;</td><td align="left">分组列们</td></tr><tr><td align="left">bandwidth</td><td align="left">Number</td><td align="left">&#91;0,1&#93;范围的频宽取值, 控制平滑程度</td></tr><tr><td align="left">as</td><td align="left">String&#91;&#93;</td><td align="left">输出列名</td></tr></table>

<table id="lov"><tr>
<td id="lov" height=90% style="width:50%">
</p>
<pre><code class="language-json">&#123;
  &quot;data&quot;: &#123;
    &quot;url&quot;: &quot;/assets/data/movies.json&quot;
  &#125;,
  &quot;layer&quot;: &#91;
    &#123;
      &quot;mark&quot;: &#123;
        &quot;type&quot;: &quot;point&quot;,
        &quot;filled&quot;: true
      &#125;,
      &quot;encoding&quot;: &#123;
        &quot;x&quot;: &#123;
          &quot;field&quot;: &quot;Rotten Tomatoes Rating&quot;,
          &quot;type&quot;: &quot;quantitative&quot;
        &#125;,
        &quot;y&quot;: &#123;
          &quot;field&quot;: &quot;IMDB Rating&quot;,
          &quot;type&quot;: &quot;quantitative&quot;
        &#125;
      &#125;
    &#125;,
    &#123;
      &quot;mark&quot;: &#123;
        &quot;type&quot;: &quot;line&quot;,
        &quot;color&quot;: &quot;firebrick&quot;
      &#125;,
      &quot;transform&quot;: &#91;
        &#123;
          &quot;loess&quot;: &quot;IMDB Rating&quot;,
          &quot;on&quot;: &quot;Rotten Tomatoes Rating&quot;
        &#125;
      &#93;,
      &quot;encoding&quot;: &#123;
        &quot;x&quot;: &#123;
          &quot;field&quot;: &quot;Rotten Tomatoes Rating&quot;,
          &quot;type&quot;: &quot;quantitative&quot;
        &#125;,
        &quot;y&quot;: &#123;
          &quot;field&quot;: &quot;IMDB Rating&quot;,
          &quot;type&quot;: &quot;quantitative&quot;
        &#125;
      &#125;
    &#125;
  &#93;
&#125;</code></pre>
<p>
</td>
<td id="lov" width="50%" height=90% align="left">
 
<div id="纸294"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "data": {
    "url": "/assets/data/movies.json"
  },
  "layer": [
    {
      "mark": {
        "type": "point",
        "filled": true
      },
      "encoding": {
        "x": {
          "field": "Rotten Tomatoes Rating",
          "type": "quantitative"
        },
        "y": {
          "field": "IMDB Rating",
          "type": "quantitative"
        }
      }
    },
    {
      "mark": {
        "type": "line",
        "color": "firebrick"
      },
      "transform": [
        {
          "loess": "IMDB Rating",
          "on": "Rotten Tomatoes Rating"
        }
      ],
      "encoding": {
        "x": {
          "field": "Rotten Tomatoes Rating",
          "type": "quantitative"
        },
        "y": {
          "field": "IMDB Rating",
          "type": "quantitative"
        }
      }
    }
  ]
    };
    vegaEmbed('#纸294', vlSpec, opt);
</script>
 
</td>
</tr></table>

<h3 id="lookup"><a href="#lookup" class="header-anchor">Lookup</a></h3>
<p>查找与主数据源中指定字段相匹配的副数据中对应的对象。</p>

<fieldset class="admon admon-note">
<legend class="admon-legend admon-legend-note"> Note</legend>
  就是我们日常分析中的<code>join</code>操作啊 
</fieldset>

<table><tr><th align="left">P</th><th align="left">T</th><th align="left">D</th></tr><tr><td align="left">lookup</td><td align="left">String</td><td align="left">主数据中的Key</td></tr><tr><td align="left">from</td><td align="left">LookupDate/LookupSelection</td><td align="left">副数据源</td></tr><tr><td align="left">as</td><td align="left">String&#91;&#93;</td><td align="left">略</td></tr><tr><td align="left">default</td><td align="left">Any</td><td align="left">匹配失败时分配的默认值, 默认是<code>null</code></td></tr></table>
<p>副数据属性:</p>
<table><tr><th align="left">P</th><th align="left">T</th><th align="left">D</th></tr><tr><td align="left">data</td><td align="left">Data</td><td align="left">数据源</td></tr><tr><td align="left">key</td><td align="left">String</td><td align="left">副数据的key</td></tr><tr><td align="left">fields</td><td align="left">String&#91;&#93;</td><td align="left">指定要匹配的字段, 默认匹配全部对象</td></tr></table>
<p>一个例子: </p>
<p>输入数据表格如下:</p>
<p><code>lookup_groups.csv</code>:</p>
<table><tr><th align="right">group</th><th align="right">person</th></tr><tr><td align="right">1</td><td align="right">Alan</td></tr><tr><td align="right">1</td><td align="right">George</td></tr><tr><td align="right">1</td><td align="right">Fred</td></tr><tr><td align="right">2</td><td align="right">Steve</td></tr><tr><td align="right">2</td><td align="right">Nick</td></tr><tr><td align="right">2</td><td align="right">Will</td></tr><tr><td align="right">3</td><td align="right">Cole</td></tr><tr><td align="right">3</td><td align="right">Rick</td></tr><tr><td align="right">3</td><td align="right">Tom</td></tr></table>

<p><code>lookup_people.csv</code>:</p>
<table><tr><th align="right">name</th><th align="right">age</th><th align="right">height</th></tr><tr><td align="right">Alan</td><td align="right">25</td><td align="right">180</td></tr><tr><td align="right">George</td><td align="right">32</td><td align="right">174</td></tr><tr><td align="right">Fred</td><td align="right">39</td><td align="right">182</td></tr><tr><td align="right">Steve</td><td align="right">42</td><td align="right">161</td></tr><tr><td align="right">Nick</td><td align="right">23</td><td align="right">180</td></tr><tr><td align="right">Will</td><td align="right">21</td><td align="right">168</td></tr><tr><td align="right">Cole</td><td align="right">51</td><td align="right">160</td></tr><tr><td align="right">Rick</td><td align="right">63</td><td align="right">181</td></tr><tr><td align="right">Tom</td><td align="right">54</td><td align="right">179</td></tr></table>

<p>按照人名合并两个表格:</p>

<table id="lov"><tr>
<td id="lov" height=90% style="width:50%">
</p>
<pre><code class="language-json">&#123;
  &quot;data&quot;: &#123;&quot;url&quot;: &quot;/assets/data/lookup_groups.csv&quot;&#125;,
  &quot;transform&quot;: &#91;&#123;
    &quot;lookup&quot;: &quot;person&quot;,
    &quot;from&quot;: &#123;
      &quot;data&quot;: &#123;&quot;url&quot;: &quot;/assets/data/lookup_people.csv&quot;&#125;,
      &quot;key&quot;: &quot;name&quot;,
      &quot;fields&quot;: &#91;&quot;age&quot;, &quot;height&quot;&#93;
    &#125;
  &#125;&#93;,
  &quot;mark&quot;: &quot;bar&quot;,
  &quot;encoding&quot;: &#123;
    &quot;x&quot;: &#123;&quot;field&quot;: &quot;group&quot;&#125;,
    &quot;y&quot;: &#123;&quot;field&quot;: &quot;age&quot;, &quot;aggregate&quot;: &quot;mean&quot;&#125;
  &#125;
&#125;</code></pre>
<p>
</td>
<td id="lov" width="50%" height=90% align="left">
 
<div id="vis1386"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "data": {"url": "/assets/data/lookup_groups.csv"},
  "transform": [{
    "lookup": "person",
    "from": {
      "data": {"url": "/assets/data/lookup_people.csv"},
      "key": "name",
      "fields": ["age", "height"]
    }
  }],
  "mark": "bar",
  "encoding": {
    "x": {"field": "group"},
    "y": {"field": "age", "aggregate": "mean"}
  }
    };
    vegaEmbed('#vis1386', vlSpec, opt);
</script>
 
</td>
</tr></table>

<p>进阶用法:</p>
<p>lookup还支持把<code>select</code>交互动作的名字<code>param</code>当作数据源. 以下例子用lookup做炫酷的交互:</p>

<div id="vis1490"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "data": {
    "url": "/assets/data/stocks.csv",
    "format": {"parse": {"date": "date"}}
  },
  "width": 650,
  "height": 300,
  "layer": [
    {
      "params": [{
        "name": "index",
        "value": [{"x": {"year": 2005, "month": 1, "date": 1}}],
        "select": {
          "type": "point",
          "encodings": ["x"],
          "on": "mouseover",
          "nearest": true
        }
      }],
      "mark": "point",
      "encoding": {
        "x": {"field": "date", "type": "temporal", "axis": null},
        "opacity": {"value": 0}
      }
    },
    {
      "transform": [
        {
          "lookup": "symbol",
          "from": {"param": "index", "key": "symbol"}
        },
        {
          "calculate": "datum.index && datum.index.price > 0 ? (datum.price - datum.index.price)/datum.index.price : 0",
          "as": "indexed_price"
        }
      ],
      "mark": "line",
      "encoding": {
        "x": {"field": "date", "type": "temporal", "axis": null},
        "y": {
          "field": "indexed_price", "type": "quantitative",
          "axis": {"format": "%"}
        },
        "color": {"field": "symbol", "type": "nominal"}
      }
    },
    {
      "transform": [{"filter": {"param": "index"}}],
      "encoding": {
        "x": {"field": "date", "type": "temporal", "axis": null},
        "color": {"value": "firebrick"}
      },
      "layer": [
        {"mark": {"type": "rule", "strokeWidth": 0.5}},
        {
          "mark": {"type": "text", "align": "center", "fontWeight": 100},
          "encoding": {
            "text": {"field": "date", "timeUnit": "yearmonth"},
            "y": {"value": 310}
          }
        }
      ]
    }
  ]
    };
    vegaEmbed('#vis1490', vlSpec, opt);
</script>

<pre><code class="language-json">&#123;
  &quot;data&quot;: &#123;
    &quot;url&quot;: &quot;/assets/data/stocks.csv&quot;,
    &quot;format&quot;: &#123;&quot;parse&quot;: &#123;&quot;date&quot;: &quot;date&quot;&#125;&#125;
  &#125;,
  &quot;width&quot;: 650,
  &quot;height&quot;: 300,
  &quot;layer&quot;: &#91;
    &#123;
      //在这里定义交互规则
      &quot;params&quot;: &#91;&#123;
        &quot;name&quot;: &quot;index&quot;,
        &quot;value&quot;: &#91;&#123;&quot;x&quot;: &#123;&quot;year&quot;: 2005, &quot;month&quot;: 1, &quot;date&quot;: 1&#125;&#125;&#93;,
        &quot;select&quot;: &#123;
          &quot;type&quot;: &quot;point&quot;,
          &quot;encodings&quot;: &#91;&quot;x&quot;&#93;,
          &quot;on&quot;: &quot;mouseover&quot;,
          &quot;nearest&quot;: true
        &#125;
      &#125;&#93;,
      &quot;mark&quot;: &quot;point&quot;,
      &quot;encoding&quot;: &#123;
        &quot;x&quot;: &#123;&quot;field&quot;: &quot;date&quot;, &quot;type&quot;: &quot;temporal&quot;, &quot;axis&quot;: null&#125;,
        &quot;opacity&quot;: &#123;&quot;value&quot;: 0&#125;
      &#125;
    &#125;,
    &#123;
      &quot;transform&quot;: &#91;
        &#123;
          &quot;lookup&quot;: &quot;symbol&quot;,
          //这里的from设置成交互规则的param
          &quot;from&quot;: &#123;&quot;param&quot;: &quot;index&quot;, &quot;key&quot;: &quot;symbol&quot;&#125;
        &#125;,
        &#123;
          //形成的新表就是把index添加到原始stock表中, 所以可以把index对应的值跟原始表的值一起做数值计算
          &quot;calculate&quot;: &quot;datum.index &amp;&amp; datum.index.price &gt; 0 ? &#40;datum.price - datum.index.price&#41;/datum.index.price : 0&quot;,
          &quot;as&quot;: &quot;indexed_price&quot;
        &#125;
      &#93;,
      &quot;mark&quot;: &quot;line&quot;,
      &quot;encoding&quot;: &#123;
        &quot;x&quot;: &#123;&quot;field&quot;: &quot;date&quot;, &quot;type&quot;: &quot;temporal&quot;, &quot;axis&quot;: null&#125;,
        &quot;y&quot;: &#123;
          &quot;field&quot;: &quot;indexed_price&quot;, &quot;type&quot;: &quot;quantitative&quot;,
          &quot;axis&quot;: &#123;&quot;format&quot;: &quot;&#37;&quot;&#125;
        &#125;,
        &quot;color&quot;: &#123;&quot;field&quot;: &quot;symbol&quot;, &quot;type&quot;: &quot;nominal&quot;&#125;
      &#125;
    &#125;,
    &#123;
      &quot;transform&quot;: &#91;&#123;&quot;filter&quot;: &#123;&quot;param&quot;: &quot;index&quot;&#125;&#125;&#93;,
      &quot;encoding&quot;: &#123;
        &quot;x&quot;: &#123;&quot;field&quot;: &quot;date&quot;, &quot;type&quot;: &quot;temporal&quot;, &quot;axis&quot;: null&#125;,
        &quot;color&quot;: &#123;&quot;value&quot;: &quot;firebrick&quot;&#125;
      &#125;,
      &quot;layer&quot;: &#91;
        &#123;&quot;mark&quot;: &#123;&quot;type&quot;: &quot;rule&quot;, &quot;strokeWidth&quot;: 0.5&#125;&#125;,
        &#123;
          &quot;mark&quot;: &#123;&quot;type&quot;: &quot;text&quot;, &quot;align&quot;: &quot;center&quot;, &quot;fontWeight&quot;: 100&#125;,
          &quot;encoding&quot;: &#123;
            &quot;text&quot;: &#123;&quot;field&quot;: &quot;date&quot;, &quot;timeUnit&quot;: &quot;yearmonth&quot;&#125;,
            &quot;y&quot;: &#123;&quot;value&quot;: 310&#125;
          &#125;
        &#125;
      &#93;
    &#125;
  &#93;
&#125;</code></pre>
<h3 id="pivot"><a href="#pivot" class="header-anchor">Pivot</a></h3>

<a> <img src="https://raw.githubusercontent.com/songtaogui/imgbed/master/msedge_2022-10-30_21-29-56.png" style="zoom:100%;" width=90 /> </a>

<p>长表转宽表, 是<a href="#fold">fold</a>的逆操作</p>
<table><tr><th align="left">P</th><th align="left">T</th><th align="left">D</th></tr><tr><td align="left">pivot</td><td align="left">String</td><td align="left">数据源</td></tr><tr><td align="left">value</td><td align="left">String</td><td align="left">需要转换的列, 其值最终会变成新表的列名</td></tr><tr><td align="left">groupby</td><td align="left">String&#91;&#93;</td><td align="left">分组列</td></tr><tr><td align="left">limit</td><td align="left">Number</td><td align="left">最大可以生成的列数, 默认是<code>0</code>, 就是不限制</td></tr><tr><td align="left">op</td><td align="left">String</td><td align="left">对分组的<code>value</code>进行什么操作, 默认是<code>sum</code></td></tr></table>
<p>示例:</p>
<pre><code class="language-json">&#91;
  &#123;&quot;country&quot;: &quot;Norway&quot;, &quot;type&quot;: &quot;gold&quot;, &quot;count&quot;: 14&#125;,
  &#123;&quot;country&quot;: &quot;Norway&quot;, &quot;type&quot;: &quot;silver&quot;, &quot;count&quot;: 14&#125;,
  &#123;&quot;country&quot;: &quot;Norway&quot;, &quot;type&quot;: &quot;bronze&quot;, &quot;count&quot;: 11&#125;,
  &#123;&quot;country&quot;: &quot;Germany&quot;, &quot;type&quot;: &quot;gold&quot;, &quot;count&quot;: 14&#125;,
  &#123;&quot;country&quot;: &quot;Germany&quot;, &quot;type&quot;: &quot;silver&quot;, &quot;count&quot;: 10&#125;,
  &#123;&quot;country&quot;: &quot;Germany&quot;, &quot;type&quot;: &quot;bronze&quot;, &quot;count&quot;: 7&#125;,
  &#123;&quot;country&quot;: &quot;Canada&quot;, &quot;type&quot;: &quot;gold&quot;, &quot;count&quot;: 11&#125;,
  &#123;&quot;country&quot;: &quot;Canada&quot;, &quot;type&quot;: &quot;silver&quot;, &quot;count&quot;: 8&#125;,
  &#123;&quot;country&quot;: &quot;Canada&quot;, &quot;type&quot;: &quot;bronze&quot;, &quot;count&quot;: 10&#125;
&#93;

\\进行如下pivot操作:
&#123;
  &quot;pivot&quot;: &quot;type&quot;,
  &quot;groupby&quot;: &#91;&quot;country&quot;&#93;,
  &quot;value&quot;: &quot;count&quot;
&#125;

\\得到结果:
&#91;
  &#123;&quot;country&quot;: &quot;Norway&quot;, &quot;gold&quot;: 14, &quot;silver&quot;: 14, &quot;bronze&quot;: 11&#125;,
  &#123;&quot;country&quot;: &quot;Germany&quot;, &quot;gold&quot;: 14, &quot;silver&quot;: 10, &quot;bronze&quot;: 7&#125;,
  &#123;&quot;country&quot;: &quot;Canada&quot;, &quot;gold&quot;: 11, &quot;silver&quot;: 8, &quot;bronze&quot;: 10&#125;
&#93;</code></pre>
<h3 id="quantile"><a href="#quantile" class="header-anchor">Quantile</a></h3>
<p>计算分位数。</p>
<table><tr><th align="left">P</th><th align="left">T</th><th align="left">D</th></tr><tr><td align="left">quantile</td><td align="left">String</td><td align="left">要处理的列名</td></tr><tr><td align="left">groupby</td><td align="left"></td><td align="left"></td></tr><tr><td align="left">probs</td><td align="left">Number&#91;&#93;</td><td align="left">分位数比值&#40;0,1&#41;列表, 如果不提供, 则使用step值</td></tr><tr><td align="left">step</td><td align="left">Number</td><td align="left">分位数步长&#40;默认0.01&#41;, 只有probs为空时才有用</td></tr><tr><td align="left">as</td><td align="left">String&#91;&#93;</td><td align="left">输出列名, 默认是<code>&#91;&quot;prob&quot;, &quot;value&quot;&#93;</code></td></tr></table>
<pre><code class="language-json">&#123;&quot;quantile&quot;: &quot;measure&quot;, &quot;probs&quot;: &#91;0.25, 0.5, 0.75&#93;&#125;
\\输出
&#91;
  &#123;prob: 0.25, value: 1.34&#125;,
  &#123;prob: 0.5, value: 5.82&#125;,
  &#123;prob: 0.75, value: 9.31&#125;
&#93;;</code></pre>
<p>示例: 用来生成QQ图</p>

<div id="vis1684"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "data": {
    "url": "/assets/data/normal-2d.json"
  },
  "transform": [
    {
      "quantile": "u",
      "step": 0.01,
      "as": [
        "p",
        "v"
      ]
    },
    {
      "calculate": "quantileUniform(datum.p)",
      "as": "unif"
    },
    {
      "calculate": "quantileNormal(datum.p)",
      "as": "norm"
    }
  ],
  "hconcat": [
    {
      "mark": "point",
      "encoding": {
        "x": {
          "field": "unif",
          "type": "quantitative"
        },
        "y": {
          "field": "v",
          "type": "quantitative"
        }
      }
    },
    {
      "mark": "point",
      "encoding": {
        "x": {
          "field": "norm",
          "type": "quantitative"
        },
        "y": {
          "field": "v",
          "type": "quantitative"
        }
      }
    }
  ]
    };
    vegaEmbed('#vis1684', vlSpec, opt);
</script>

<pre><code class="language-json">&#123;
  &quot;data&quot;: &#123;
    &quot;url&quot;: &quot;/assets/data/normal-2d.json&quot;
  &#125;,
  &quot;transform&quot;: &#91;
    &#123;
      &quot;quantile&quot;: &quot;u&quot;,
      &quot;step&quot;: 0.01,
      &quot;as&quot;: &#91;
        &quot;p&quot;,
        &quot;v&quot;
      &#93;
    &#125;,
    &#123;
      &quot;calculate&quot;: &quot;quantileUniform&#40;datum.p&#41;&quot;,
      &quot;as&quot;: &quot;unif&quot;
    &#125;,
    &#123;
      &quot;calculate&quot;: &quot;quantileNormal&#40;datum.p&#41;&quot;,
      &quot;as&quot;: &quot;norm&quot;
    &#125;
  &#93;,
  &quot;hconcat&quot;: &#91;
    &#123;
      &quot;mark&quot;: &quot;point&quot;,
      &quot;encoding&quot;: &#123;
        &quot;x&quot;: &#123;
          &quot;field&quot;: &quot;unif&quot;,
          &quot;type&quot;: &quot;quantitative&quot;
        &#125;,
        &quot;y&quot;: &#123;
          &quot;field&quot;: &quot;v&quot;,
          &quot;type&quot;: &quot;quantitative&quot;
        &#125;
      &#125;
    &#125;,
    &#123;
      &quot;mark&quot;: &quot;point&quot;,
      &quot;encoding&quot;: &#123;
        &quot;x&quot;: &#123;
          &quot;field&quot;: &quot;norm&quot;,
          &quot;type&quot;: &quot;quantitative&quot;
        &#125;,
        &quot;y&quot;: &#123;
          &quot;field&quot;: &quot;v&quot;,
          &quot;type&quot;: &quot;quantitative&quot;
        &#125;
      &#125;
    &#125;
  &#93;
&#125;</code></pre>
<h3 id="regression"><a href="#regression" class="header-anchor">Regression</a></h3>
<p>支持的回归模型:</p>
<ul>
<li><p><code>linear</code>: linear&#40;线性&#41;, \( y = a + bx \)</p>
</li>
<li><p><code>log</code>: logarithmics&#40;对数&#41;, \( y = a + b*log(x) \)</p>
</li>
<li><p><code>exp</code>: exponential&#40;指数&#41;, \( y = a * e^(bx) \)</p>
</li>
<li><p><code>pow</code>: power&#40;幂&#41;, \( y = a * x^b \)</p>
</li>
<li><p><code>quad</code>: quadratic&#40;二项&#41;, \( y = a + b * x + c * x^2 \)</p>
</li>
<li><p><code>poly</code>: polynomial&#40;多项&#41;, \( y = a + b * x +  ... + k * x^(order) \)</p>
</li>
</ul>
<table><tr><th align="left">P</th><th align="left">T</th><th align="left">D</th></tr><tr><td align="left">regression</td><td align="left">String</td><td align="left">因变量</td></tr><tr><td align="left">on</td><td align="left">String</td><td align="left">自变量</td></tr><tr><td align="left">groupby</td><td align="left">String&#91;&#93;</td><td align="left"></td></tr><tr><td align="left">method</td><td align="left">String</td><td align="left">上述回归模型, 默认是<code>linear</code></td></tr><tr><td align="left">order</td><td align="left">Number</td><td align="left"><code>poly</code>模型下, 多项式的项数, 默认是3</td></tr><tr><td align="left">extent</td><td align="left">Number&#91;&#93;</td><td align="left">趋势线的上下界</td></tr><tr><td align="left">params</td><td align="left">Boolean</td><td align="left">是否返回回归模型的参数,而不是返回画趋势线的点, 如果是<code>true</code>, 会返回<code>coef</code>向量和<code>rSquared</code>值</td></tr><tr><td align="left">as</td><td align="left">String&#91;&#93;</td><td align="left">默认就是x和y的列名</td></tr></table>
<p>一个例子:</p>

<div id="vis1760"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "data": {
    "url": "/assets/data/movies.json"
  },
  "layer": [
    {
      "mark": {
        "type": "point",
        "filled": true
      },
      "encoding": {
        "x": {
          "field": "Rotten Tomatoes Rating",
          "type": "quantitative"
        },
        "y": {
          "field": "IMDB Rating",
          "type": "quantitative"
        }
      }
    },
    {
      "mark": {
        "type": "line",
        "color": "firebrick"
      },
      "transform": [
        {
          "regression": "IMDB Rating",
          "on": "Rotten Tomatoes Rating"
        }
      ],
      "encoding": {
        "x": {
          "field": "Rotten Tomatoes Rating",
          "type": "quantitative"
        },
        "y": {
          "field": "IMDB Rating",
          "type": "quantitative"
        }
      }
    },
    {
      "transform": [
        {
          "regression": "IMDB Rating",
          "on": "Rotten Tomatoes Rating",
          "params": true
        },
        {"calculate": "'R²: '+format(datum.rSquared, '.2f')", "as": "R2"}
      ],
      "mark": {
        "type": "text",
        "color": "firebrick",
        "x": "width",
        "align": "right",
        "y": -5
      },
      "encoding": {
        "text": {"type": "nominal", "field": "R2"}
      }
    }
  ]
    };
    vegaEmbed('#vis1760', vlSpec, opt);
</script>

<pre><code class="language-json">&#123;
  &quot;data&quot;: &#123;
    &quot;url&quot;: &quot;/assets/data/movies.json&quot;
  &#125;,
  &quot;layer&quot;: &#91;
    &#123;
      &quot;mark&quot;: &#123;
        &quot;type&quot;: &quot;point&quot;,
        &quot;filled&quot;: true
      &#125;,
      &quot;encoding&quot;: &#123;
        &quot;x&quot;: &#123;
          &quot;field&quot;: &quot;Rotten Tomatoes Rating&quot;,
          &quot;type&quot;: &quot;quantitative&quot;
        &#125;,
        &quot;y&quot;: &#123;
          &quot;field&quot;: &quot;IMDB Rating&quot;,
          &quot;type&quot;: &quot;quantitative&quot;
        &#125;
      &#125;
    &#125;,
    &#123;
      &quot;mark&quot;: &#123;
        &quot;type&quot;: &quot;line&quot;,
        &quot;color&quot;: &quot;firebrick&quot;
      &#125;,
      &quot;transform&quot;: &#91;
        &#123;
          &quot;regression&quot;: &quot;IMDB Rating&quot;,
          &quot;on&quot;: &quot;Rotten Tomatoes Rating&quot;
        &#125;
      &#93;,
      &quot;encoding&quot;: &#123;
        &quot;x&quot;: &#123;
          &quot;field&quot;: &quot;Rotten Tomatoes Rating&quot;,
          &quot;type&quot;: &quot;quantitative&quot;
        &#125;,
        &quot;y&quot;: &#123;
          &quot;field&quot;: &quot;IMDB Rating&quot;,
          &quot;type&quot;: &quot;quantitative&quot;
        &#125;
      &#125;
    &#125;,
    &#123;
      &quot;transform&quot;: &#91;
        &#123;
          &quot;regression&quot;: &quot;IMDB Rating&quot;,
          &quot;on&quot;: &quot;Rotten Tomatoes Rating&quot;,
          &quot;params&quot;: true
        &#125;,
        &#123;&quot;calculate&quot;: &quot;&#39;R²: &#39;&#43;format&#40;datum.rSquared, &#39;.2f&#39;&#41;&quot;, &quot;as&quot;: &quot;R2&quot;&#125;
      &#93;,
      &quot;mark&quot;: &#123;
        &quot;type&quot;: &quot;text&quot;,
        &quot;color&quot;: &quot;firebrick&quot;,
        &quot;x&quot;: &quot;width&quot;,
        &quot;align&quot;: &quot;right&quot;,
        &quot;y&quot;: -5
      &#125;,
      &quot;encoding&quot;: &#123;
        &quot;text&quot;: &#123;&quot;type&quot;: &quot;nominal&quot;, &quot;field&quot;: &quot;R2&quot;&#125;
      &#125;
    &#125;
  &#93;
&#125;</code></pre>
<h3 id="sample"><a href="#sample" class="header-anchor">Sample</a></h3>
<p>随机抽样, 就一个参数: <code>sample</code>, 指定抽样大小: <code>&#123;&quot;sample&quot;: 500&#125;</code></p>
<pre><code class="language-json">// Any View Specification
&#123;
  ...
  &quot;transform&quot;: &#91;
    &#123;&quot;sample&quot;: 500&#125; // Sample Transform
     ...
  &#93;,
  ...
&#125;</code></pre>
<h3 id="stack"><a href="#stack" class="header-anchor">Stack</a></h3>
<p><code>stack</code>堆叠柱状图, 可以用在<code>encoding</code>中, 也可用在<code>transform</code>中.</p>
<ul>
<li><p>只适用于连续变量的<code>x, y, theta, radius</code></p>
</li>
<li><p><code>zero</code>或<code>true</code>: 没有基准偏移的堆叠&#40;类似于ggplot中的<code>position&#61;&quot;identity&quot;</code>&#41;, 基本的堆叠柱状图</p>
</li>
<li><p><code>normalize</code>: 标准化的&#40;类似于ggplot中的<code>position&#61;&quot;fill&quot;</code>&#41;堆叠图, 也用于画饼图</p>
</li>
<li><p><code>center</code>: 向中心偏移的堆叠柱状图, 用于生成流线图</p>
</li>
<li><p><code>null</code>或<code>false</code>: 各个分组互相重叠</p>
</li>
</ul>
<p>示例很多, 不放了, 参考<a href="https://vega.github.io/vega-lite/docs/stack.html#layered-bar-chart">这里</a></p>
<p>一个进阶用法例子: 不用stack, 通过计算更改数值, 实现双向堆叠:</p>
<pre><code class="language-json">&#123;
  &quot;data&quot;: &#123; &quot;url&quot;: &quot;/assets/data/population.json&quot;&#125;,
  &quot;transform&quot;: &#91;
    &#123;&quot;filter&quot;: &quot;datum.year &#61;&#61; 2000&quot;&#125;,
    &#123;&quot;calculate&quot;: &quot;datum.sex &#61;&#61; 2 ? &#39;Female&#39; : &#39;Male&#39;&quot;, &quot;as&quot;: &quot;gender&quot;&#125;,
    &#123;&quot;calculate&quot;: &quot;datum.sex &#61;&#61; 2 ? -datum.people : datum.people&quot;, &quot;as&quot;: &quot;signed_people&quot;&#125;
  &#93;,
  &quot;width&quot;: 500,
  &quot;height&quot;: 300,
  &quot;mark&quot;: &quot;bar&quot;,
  &quot;encoding&quot;: &#123;
    &quot;y&quot;: &#123;
      &quot;field&quot;: &quot;age&quot;,
      &quot;axis&quot;: null, &quot;sort&quot;: &quot;descending&quot;
    &#125;,
    &quot;x&quot;: &#123;
      &quot;aggregate&quot;: &quot;sum&quot;, &quot;field&quot;: &quot;signed_people&quot;,
      &quot;title&quot;: &quot;population&quot;,
      &quot;axis&quot;: &#123;&quot;format&quot;: &quot;s&quot;&#125;
    &#125;,
    &quot;color&quot;: &#123;
      &quot;field&quot;: &quot;gender&quot;,
      &quot;scale&quot;: &#123;&quot;range&quot;: &#91;&quot;#675193&quot;, &quot;#ca8861&quot;&#93;&#125;,
      &quot;legend&quot;: &#123;&quot;orient&quot;: &quot;top&quot;, &quot;title&quot;: null&#125;
    &#125;
  &#125;,
  &quot;config&quot;: &#123;
    &quot;view&quot;: &#123;&quot;stroke&quot;: null&#125;,
    &quot;axis&quot;: &#123;&quot;grid&quot;: false&#125;
  &#125;
&#125;</code></pre>

<div id="vis1958"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "data": { "url": "/assets/data/population.json"},
  "transform": [
    {"filter": "datum.year == 2000"},
    {"calculate": "datum.sex == 2 ? 'Female' : 'Male'", "as": "gender"},
    {"calculate": "datum.sex == 2 ? -datum.people : datum.people", "as": "signed_people"}
  ],
  "width": 500,
  "height": 300,
  "mark": "bar",
  "encoding": {
    "y": {
      "field": "age",
      "axis": null, "sort": "descending"
    },
    "x": {
      "aggregate": "sum", "field": "signed_people",
      "title": "population",
      "axis": {"format": "s"}
    },
    "color": {
      "field": "gender",
      "scale": {"range": ["#675193", "#ca8861"]},
      "legend": {"orient": "top", "title": null}
    }
  },
  "config": {
    "view": {"stroke": null},
    "axis": {"grid": false}
  }
    };
    vegaEmbed('#vis1958', vlSpec, opt);
</script>

<p>另一个进阶用法: 对折线堆叠时, 要显式声明偏移量:</p>

<div id="vis1992"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "data": {"url": "/assets/data/population.json"},
  "transform": [
    {"filter": "datum.year == 2000"},
    {"calculate": "datum.sex == 2 ? 'Female' : 'Male'", "as": "gender"}
  ],
  "layer": [
    {
      "mark": {"opacity": 0.7, "type": "area"},
      "encoding": {
        "y": {"aggregate": "sum", "field": "people", "type": "quantitative"},
        "x": {"field": "age", "type": "nominal"},
        "color": {
          "field": "gender",
          "scale": {"range": ["#675193", "#ca8861"]},
          "type": "nominal"
        },
        "opacity": {"value": 0.7}
      }
    },
    {
      "mark": {"type": "line"},
      "encoding": {
        "y": {
          "aggregate": "sum",
          "field": "people",
          "type": "quantitative",
          "stack": "zero"
        },
        "x": {"field": "age", "type": "nominal"},
        "color": {
          "field": "gender",
          "scale": {"range": ["#675193", "#ca8861"]},
          "type": "nominal"
        },
        "opacity": {"value": 0.7}
      }
    }
  ]
    };
    vegaEmbed('#vis1992', vlSpec, opt);
</script>

<pre><code class="language-json">&#123;
  &quot;data&quot;: &#123;&quot;url&quot;: &quot;/assets/data/population.json&quot;&#125;,
  &quot;transform&quot;: &#91;
    &#123;&quot;filter&quot;: &quot;datum.year &#61;&#61; 2000&quot;&#125;,
    &#123;&quot;calculate&quot;: &quot;datum.sex &#61;&#61; 2 ? &#39;Female&#39; : &#39;Male&#39;&quot;, &quot;as&quot;: &quot;gender&quot;&#125;
  &#93;,
  &quot;layer&quot;: &#91;
    &#123;
      &quot;mark&quot;: &#123;&quot;opacity&quot;: 0.7, &quot;type&quot;: &quot;area&quot;&#125;,
      &quot;encoding&quot;: &#123;
        &quot;y&quot;: &#123;&quot;aggregate&quot;: &quot;sum&quot;, &quot;field&quot;: &quot;people&quot;, &quot;type&quot;: &quot;quantitative&quot;&#125;,
        &quot;x&quot;: &#123;&quot;field&quot;: &quot;age&quot;, &quot;type&quot;: &quot;nominal&quot;&#125;,
        &quot;color&quot;: &#123;
          &quot;field&quot;: &quot;gender&quot;,
          &quot;scale&quot;: &#123;&quot;range&quot;: &#91;&quot;#675193&quot;, &quot;#ca8861&quot;&#93;&#125;,
          &quot;type&quot;: &quot;nominal&quot;
        &#125;,
        &quot;opacity&quot;: &#123;&quot;value&quot;: 0.7&#125;
      &#125;
    &#125;,
    &#123;
      &quot;mark&quot;: &#123;&quot;type&quot;: &quot;line&quot;&#125;,
      &quot;encoding&quot;: &#123;
        &quot;y&quot;: &#123;
          &quot;aggregate&quot;: &quot;sum&quot;,
          &quot;field&quot;: &quot;people&quot;,
          &quot;type&quot;: &quot;quantitative&quot;,
          &quot;stack&quot;: &quot;zero&quot;
        &#125;,
        &quot;x&quot;: &#123;&quot;field&quot;: &quot;age&quot;, &quot;type&quot;: &quot;nominal&quot;&#125;,
        &quot;color&quot;: &#123;
          &quot;field&quot;: &quot;gender&quot;,
          &quot;scale&quot;: &#123;&quot;range&quot;: &#91;&quot;#675193&quot;, &quot;#ca8861&quot;&#93;&#125;,
          &quot;type&quot;: &quot;nominal&quot;
        &#125;,
        &quot;opacity&quot;: &#123;&quot;value&quot;: 0.7&#125;
      &#125;
    &#125;
  &#93;
&#125;</code></pre>
<p><code>transform</code>中使用<code>stack</code>, 支持如下属性: <code>stack, groupby, offset, sort, as</code> 其中, sort可以用来对堆叠结果进行排序, 类似ggplot2中根据levels排序</p>
<p>另外还有两个进阶用法, 平时用不太上, 代码就不贴了, 需要的自己看:</p>
<p>自定义偏移: 
<div id="vis2083"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "data": {
    "values": [
      {"question": "Question 1", "type": "Strongly disagree", "value": 24, "percentage": 0.7},
      {"question": "Question 1", "type": "Disagree", "value": 294, "percentage": 9.1},
      {"question": "Question 1", "type": "Neither agree nor disagree", "value": 594, "percentage": 18.5},
      {"question": "Question 1", "type": "Agree", "value": 1927, "percentage": 59.9},
      {"question": "Question 1", "type": "Strongly agree", "value": 376, "percentage": 11.7},
      {"question": "Question 2", "type": "Strongly disagree", "value": 2, "percentage": 18.2},
      {"question": "Question 2", "type": "Disagree", "value": 2, "percentage": 18.2},
      {"question": "Question 2", "type": "Neither agree nor disagree", "value": 0, "percentage": 0},
      {"question": "Question 2", "type": "Agree", "value": 7, "percentage": 63.6},
      {"question": "Question 2", "type": "Strongly agree", "value": 11, "percentage": 0},
      {"question": "Question 3", "type": "Strongly disagree", "value": 2, "percentage": 20},
      {"question": "Question 3", "type": "Disagree", "value": 0, "percentage": 0},
      {"question": "Question 3", "type": "Neither agree nor disagree", "value": 2, "percentage": 20},
      {"question": "Question 3", "type": "Agree", "value": 4, "percentage": 40},
      {"question": "Question 3", "type": "Strongly agree", "value": 2, "percentage": 20},
      {"question": "Question 4", "type": "Strongly disagree", "value": 0, "percentage": 0},
      {"question": "Question 4", "type": "Disagree", "value": 2, "percentage": 12.5},
      {"question": "Question 4", "type": "Neither agree nor disagree", "value": 1, "percentage": 6.3},
      {"question": "Question 4", "type": "Agree", "value": 7, "percentage": 43.8},
      {"question": "Question 4", "type": "Strongly agree", "value": 6, "percentage": 37.5},
      {"question": "Question 5", "type": "Strongly disagree", "value": 0, "percentage": 0},
      {"question": "Question 5", "type": "Disagree", "value": 1, "percentage": 4.2},
      {"question": "Question 5", "type": "Neither agree nor disagree", "value": 3, "percentage": 12.5},
      {"question": "Question 5", "type": "Agree", "value": 16, "percentage": 66.7},
      {"question": "Question 5", "type": "Strongly agree", "value": 4, "percentage": 16.7},
      {"question": "Question 6", "type": "Strongly disagree", "value": 1, "percentage": 6.3},
      {"question": "Question 6", "type": "Disagree", "value": 1, "percentage": 6.3},
      {"question": "Question 6", "type": "Neither agree nor disagree", "value": 2, "percentage": 12.5},
      {"question": "Question 6", "type": "Agree", "value": 9, "percentage": 56.3},
      {"question": "Question 6", "type": "Strongly agree", "value": 3, "percentage": 18.8},
      {"question": "Question 7", "type": "Strongly disagree", "value": 0, "percentage": 0},
      {"question": "Question 7", "type": "Disagree", "value": 0, "percentage": 0},
      {"question": "Question 7", "type": "Neither agree nor disagree", "value": 1, "percentage": 20},
      {"question": "Question 7", "type": "Agree", "value": 4, "percentage": 80},
      {"question": "Question 7", "type": "Strongly agree", "value": 0, "percentage": 0},
      {"question": "Question 8", "type": "Strongly disagree", "value": 0, "percentage": 0},
      {"question": "Question 8", "type": "Disagree", "value": 0, "percentage": 0},
      {"question": "Question 8", "type": "Neither agree nor disagree", "value": 0, "percentage": 0},
      {"question": "Question 8", "type": "Agree", "value": 0, "percentage": 0},
      {"question": "Question 8", "type": "Strongly agree", "value": 2, "percentage": 100}
    ]
  },
  "transform": [
    {
      "calculate": "if(datum.type === 'Strongly disagree',-2,0) + if(datum.type==='Disagree',-1,0) + if(datum.type =='Neither agree nor disagree',0,0) + if(datum.type ==='Agree',1,0) + if(datum.type ==='Strongly agree',2,0)",
      "as": "q_order"
    },
    {
      "calculate": "if(datum.type === 'Disagree' || datum.type === 'Strongly disagree', datum.percentage,0) + if(datum.type === 'Neither agree nor disagree', datum.percentage / 2,0)",
      "as": "signed_percentage"
    },
    {"stack": "percentage", "as": ["v1", "v2"], "groupby": ["question"]},
    {
      "joinaggregate": [
        {
          "field": "signed_percentage",
          "op": "sum",
          "as": "offset"
        }
      ],
      "groupby": ["question"]
    },
    {"calculate": "datum.v1 - datum.offset", "as": "nx"},
    {"calculate": "datum.v2 - datum.offset", "as": "nx2"}
  ],
  "mark": "bar",
  "encoding": {
    "x": {
      "field": "nx",
      "type": "quantitative",
      "title": "Percentage"
    },
    "x2": {"field": "nx2"},
    "y": {
      "field": "question",
      "type": "nominal",
      "title": "Question",
      "axis": {
        "offset": 5,
        "ticks": false,
        "minExtent": 60,
        "domain": false
      }
    },
    "color": {
      "field": "type",
      "type": "nominal",
      "title": "Response",
      "scale": {
        "domain": ["Strongly disagree", "Disagree", "Neither agree nor disagree", "Agree", "Strongly agree"],
        "range": ["#c30d24", "#f3a583", "#cccccc", "#94c6da", "#1770ab"],
        "type": "ordinal"
      }
    }
  }
    };
    vegaEmbed('#vis2083', vlSpec, opt);
</script>
</p>
<p>马赛克图:</p>

<div id="vis2186"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "data": {
    "url": "/assets/data/cars.json"
  },
  "transform": [
    {
      "aggregate": [
        {
          "op": "count",
          "as": "count_*"
        }
      ],
      "groupby": [
        "Origin",
        "Cylinders"
      ]
    },
    {
      "stack": "count_*",
      "groupby": [],
      "as": [
        "stack_count_Origin1",
        "stack_count_Origin2"
      ],
      "offset": "normalize",
      "sort": [
        {
          "field": "Origin",
          "order": "ascending"
        }
      ]
    },
    {
      "joinaggregate": [
        {
          "op": "min",
          "field": "stack_count_Origin1",
          "as": "x"
        },
        {
          "op": "max",
          "field": "stack_count_Origin2",
          "as": "x2"
        }
      ],
      "groupby": [
        "Origin"
      ]
    },
    {
      "stack": "count_*",
      "groupby": [
        "Origin"
      ],
      "as": [
        "y",
        "y2"
      ],
      "offset": "normalize",
      "sort": [
        {
          "field": "Cylinders",
          "order": "ascending"
        }
      ]
    }
  ],
  "mark": {
    "type": "rect"
  },
  "encoding": {
    "x": {
      "field": "x",
      "type": "quantitative",
      "axis": null
    },
    "x2": {"field": "x2"},
    "y": {
      "field": "y",
      "type": "quantitative",
      "axis": null
    },
    "y2": {"field": "y2"},
    "color": {
      "field": "Origin",
      "type": "nominal"
    },
    "opacity": {
      "field": "Cylinders",
      "type": "quantitative",
      "legend": null
    },
    "tooltip": [
      {
        "field": "Origin",
        "type": "nominal"
      },
      {
        "field": "Cylinders",
        "type": "quantitative"
      }
    ]
  }
    };
    vegaEmbed('#vis2186', vlSpec, opt);
</script>

<h3 id="time_unit"><a href="#time_unit" class="header-anchor">Time Unit</a></h3>
<p>我平时不怎么处理时间序列相关的数据, 这个就先跳过了 原文档: <a href="https://vega.github.io/vega-lite/docs/timeunit.html">here</a></p>
<h3 id="window"><a href="#window" class="header-anchor">Window</a></h3>
<p>对已排序的数组对象执行计算&#40;如: ranking, lead/lag, aggregates&#41;, 结果返回输入数据流</p>
<h4 id="transform_parameters"><a href="#transform_parameters" class="header-anchor">Transform Parameters</a></h4>
<table><tr><th align="left">P</th><th align="left">T</th><th align="left">D</th></tr><tr><td align="left">sort</td><td align="left"><code>Compare</code></td><td align="left">定义数据比较顺序</td></tr><tr><td align="left">groupby</td><td align="left"><code>Field&#91;&#93;</code></td><td align="left">分组统计</td></tr><tr><td align="left">ops</td><td align="left"><code>String&#91;&#93;</code></td><td align="left">具体操作, 如<code>rank</code>,<code>lead</code>,<code>sum</code>等, 具体见表<a href="#window-operation-reference">window operation reference</a></td></tr><tr><td align="left">fields</td><td align="left"><code>Field&#91;&#93;</code></td><td align="left">要计算的字段, 该字段数组要与ops、as和params数组对齐</td></tr><tr><td align="left">params</td><td align="left"><code>Array</code></td><td align="left">windows函数的参数值, 与ops对齐</td></tr><tr><td align="left">as</td><td align="left"><code>String&#91;&#93;</code></td><td align="left">ops操作的输出字段名称, 如果不指定, 则根据操作自动生成</td></tr><tr><td align="left">frame</td><td align="left"><code>Number&#91;&#93;</code></td><td align="left">二元数组配置滑窗参数, <code>&#91;-5,5&#93;</code>表示窗口包含当前对象和前后各5个对象, 默认是<code>&#91;null,0&#93;</code>, 表示当前对象和所有之前对象&#40;null-&gt;无限对象&#41;</td></tr><tr><td align="left">ignorePeers</td><td align="left"><code>Boolean</code></td><td align="left">滑窗是否忽略<code>Peer values</code> &#40;Peer values是sort中排序相同的值&#41;, 默认是false</td></tr></table>
<h4 id="window_operation_reference"><a href="#window_operation_reference" class="header-anchor">Window operation reference</a></h4>
<p>window 中的有效操作, 包含所有 <a href="#aggregate汇总">aggregate操作</a>以及以下操作:</p>
<table><tr><th align="left">Operation</th><th align="left">Parameter</th><th align="left">Description</th></tr><tr><td align="left">row_number</td><td align="left">None</td><td align="left">分配1开始的行号</td></tr><tr><td align="left">rank</td><td align="left">None</td><td align="left">分配1开始的排名, 相同排名并列, 随后排名包含先前数量, 如: 1,1,3,3,5</td></tr><tr><td align="left">dense_rank</td><td align="left">None</td><td align="left">从1开始排名, 相同并列, 随后不包含先前数量, 如:1,1,2,2,3</td></tr><tr><td align="left">percent_rank</td><td align="left">None</td><td align="left">分配百分比排名, 计算方法: \((rank-1)/(group_size - 1)\)</td></tr><tr><td align="left">cume_dist</td><td align="left">None</td><td align="left">分配0-1之间的累积分布值</td></tr><tr><td align="left">ntile</td><td align="left">Number</td><td align="left">分位数, 参数为百分制整数&#40;eg: 百分位数100, 五分位数5&#41;</td></tr><tr><td align="left">lag</td><td align="left">Number</td><td align="left">当前对象之前指定偏移量的值, 如果不存在则输出<code>null</code>, 偏移量默认为1</td></tr><tr><td align="left">lead</td><td align="left">Number</td><td align="left">当前对象后指定偏移量的值</td></tr><tr><td align="left">first_value</td><td align="left">None</td><td align="left">当前滑窗的第一个值</td></tr><tr><td align="left">last_value</td><td align="left">None</td><td align="left">当前滑窗的最后一个值</td></tr><tr><td align="left">nth_value</td><td align="left">Number</td><td align="left">当前滑窗的第n个值</td></tr><tr><td align="left">prev_value</td><td align="left">None</td><td align="left">返回排序数组中&#40;含当前字段&#41;最近的前一个非缺失值</td></tr><tr><td align="left">next_value</td><td align="left">None</td><td align="left">返回排序数组中&#40;含当前字段&#41;最近的后一个非缺失值</td></tr></table>
<h4 id="example"><a href="#example" class="header-anchor">Example</a></h4>

<div id="vis2335"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "$schema": "https://vega.github.io/schema/vega/v5.json",
  "width": 500,
  "height": 150,
  "padding": 5,

  "signals": [
    {
      "name": "aggregate", "value": "sum",
      "bind": {
        "input": "select",
        "options": ["sum", "count", "average", "median", "stdev"]
      }
    },
    {
      "name": "frameStart", "value": null,
      "bind": {"input": "select", "options": [null, -5, -2, 0]}
    },
    {
      "name": "frameEnd", "value": 0,
      "bind": {"input": "select", "options": [0, 2, 5, null]}
    },
    {
      "name": "startLabel",
      "update": "if(frameStart == null, '-\u221e', frameStart)"
    },
    {
      "name": "endLabel",
      "update": "if(frameEnd == null, '+\u221e', frameEnd)"
    }
  ],

  "data": [
    {
      "name": "table",
      "values": [
        {"u": 1,  "v": 28}, {"u": 2,  "v": 55},
        {"u": 3,  "v": 43}, {"u": 4,  "v": 91},
        {"u": 5,  "v": 81}, {"u": 6,  "v": 53},
        {"u": 7,  "v": 19}, {"u": 8,  "v": 87},
        {"u": 9,  "v": 52}, {"u": 10, "v": 48},
        {"u": 11, "v": 24}, {"u": 12, "v": 49},
        {"u": 13, "v": 87}, {"u": 14, "v": 66},
        {"u": 15, "v": 17}, {"u": 16, "v": 27},
        {"u": 17, "v": 68}, {"u": 18, "v": 16},
        {"u": 19, "v": 49}, {"u": 20, "v": 15}
      ],
      "transform": [
        {
          "type": "window",
          "sort": {"field": "u"},
          "frame": [{"signal": "frameStart"}, {"signal": "frameEnd"}],
          "ops": [{"signal": "aggregate"}],
          "fields": ["v"],
          "as": ["value"]
        }
      ]
    }
  ],

  "scales": [
    {
      "name": "xscale",
      "type": "linear",
      "range": "width",
      "zero": false,
      "domain": {"data": "table", "field": "u"}
    },
    {
      "name": "yscale",
      "type": "linear",
      "range": "height",
      "nice": true,
      "zero": true,
      "domain": {"data": "table", "field": "value"}
    }
  ],

  "title": {
    "text": {"signal": "aggregate + '(value) over sliding window: [' + startLabel + ',' + endLabel + ']'"},
    "orient": "bottom"
  },

  "axes": [
    { "orient": "bottom", "scale": "xscale", "tickCount": 20, "zindex": 1 },
    { "orient": "left", "scale": "yscale", "tickCount": 5, "zindex": 1 }
  ],

  "marks": [
    {
      "type": "line",
      "from": {"data": "table"},
      "encode": {
        "enter": {
          "x": {"scale": "xscale", "field": "u"},
          "stroke": {"value": "steelblue"},
          "strokeWidth": {"value": 3}
        },
        "update": {
          "y": {"scale": "yscale", "field": "value"}
        }
      }
    }
  ]
    };
    vegaEmbed('#vis2335', vlSpec, opt);
</script>

<h3 id="wordcloud"><a href="#wordcloud" class="header-anchor">Wordcloud</a></h3>
<h4 id="example__2"><a href="#example__2" class="header-anchor">Example</a></h4>

<div id="vis2447"></div>
<script>
    var opt = {renderer: "svg"};
    var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        "$schema": "https://vega.github.io/schema/vega/v5.json",
  "name": "wordcloud",
  "width": 600,
  "height": 300,
  "padding": 0,
  "autosize": "none",

  "signals": [
    {
      "name": "wordPadding", "value": 1,
      "bind": {"input": "range", "min": 0, "max": 5, "step": 1}
    },
    {
      "name": "fontSizeRange0", "value": 8,
      "bind": {"input": "range", "min": 8, "max": 42, "step": 1}
    },
    {
      "name": "fontSizeRange1", "value": 24,
      "bind": {"input": "range", "min": 8, "max": 42, "step": 1}
    },
    {
      "name": "rotate", "value": 45,
      "bind": {"input": "select", "options": [0, 30, 45, 60, 90]}
    }
  ],

  "data": [
    {
      "name": "table",
      "values": [
        "Declarative visualization grammars can accelerate development, facilitate retargeting across platforms, and allow language-level optimizations. However, existing declarative visualization languages are primarily concerned with visual encoding, and rely on imperative event handlers for interactive behaviors. In response, we introduce a model of declarative interaction design for data visualizations. Adopting methods from reactive programming, we model low-level events as composable data streams from which we form higher-level semantic signals. Signals feed predicates and scale inversions, which allow us to generalize interactive selections at the level of item geometry (pixels) into interactive queries over the data domain. Production rules then use these queries to manipulate the visualization’s appearance. To facilitate reuse and sharing, these constructs can be encapsulated as named interactors: standalone, purely declarative specifications of interaction techniques. We assess our model’s feasibility and expressivity by instantiating it with extensions to the Vega visualization grammar. Through a diverse range of examples, we demonstrate coverage over an established taxonomy of visualization interaction techniques.",
        "We present Reactive Vega, a system architecture that provides the first robust and comprehensive treatment of declarative visual and interaction design for data visualization. Starting from a single declarative specification, Reactive Vega constructs a dataflow graph in which input data, scene graph elements, and interaction events are all treated as first-class streaming data sources. To support expressive interactive visualizations that may involve time-varying scalar, relational, or hierarchical data, Reactive Vega’s dataflow graph can dynamically re-write itself at runtime by extending or pruning branches in a data-driven fashion. We discuss both compile- and run-time optimizations applied within Reactive Vega, and share the results of benchmark studies that indicate superior interactive performance to both D3 and the original, non-reactive Vega system.",
        "We present Vega-Lite, a high-level grammar that enables rapid specification of interactive data visualizations. Vega-Lite combines a traditional grammar of graphics, providing visual encoding rules and a composition algebra for layered and multi-view displays, with a novel grammar of interaction. Users specify interactive semantics by composing selections. In Vega-Lite, a selection is an abstraction that defines input event processing, points of interest, and a predicate function for inclusion testing. Selections parameterize visual encodings by serving as input data, defining scale extents, or by driving conditional logic. The Vega-Lite compiler automatically synthesizes requisite data flow and event handling logic, which users can override for further customization. In contrast to existing reactive specifications, Vega-Lite selections decompose an interaction design into concise, enumerable semantic units. We evaluate Vega-Lite through a range of examples, demonstrating succinct specification of both customized interaction methods and common techniques such as panning, zooming, and linked selection."
      ],
      "transform": [
        {
          "type": "countpattern",
          "field": "data",
          "case": "upper",
          "pattern": "[\\w']{3,}",
          "stopwords": "(i|me|my|myself|we|us|our|ours|ourselves|you|your|yours|yourself|yourselves|he|him|his|himself|she|her|hers|herself|it|its|itself|they|them|their|theirs|themselves|what|which|who|whom|whose|this|that|these|those|am|is|are|was|were|be|been|being|have|has|had|having|do|does|did|doing|will|would|should|can|could|ought|i'm|you're|he's|she's|it's|we're|they're|i've|you've|we've|they've|i'd|you'd|he'd|she'd|we'd|they'd|i'll|you'll|he'll|she'll|we'll|they'll|isn't|aren't|wasn't|weren't|hasn't|haven't|hadn't|doesn't|don't|didn't|won't|wouldn't|shan't|shouldn't|can't|cannot|couldn't|mustn't|let's|that's|who's|what's|here's|there's|when's|where's|why's|how's|a|an|the|and|but|if|or|because|as|until|while|of|at|by|for|with|about|against|between|into|through|during|before|after|above|below|to|from|up|upon|down|in|out|on|off|over|under|again|further|then|once|here|there|when|where|why|how|all|any|both|each|few|more|most|other|some|such|no|nor|not|only|own|same|so|than|too|very|say|says|said|shall)"
        },
        {
          "type": "formula", "as": "weight",
          "expr": "if(datum.text=='VEGA', 600, 300)"
        },
        {
          "type": "formula", "as": "rotate",
          "expr": "[-rotate, 0, rotate][~~(random() * 3)]"
        },
        {
          "type": "wordcloud",
          "size": [{"signal": "width"}, {"signal": "height"}],
          "text": {"field": "text"},
          "font": "Helvetica Neue, Arial",
          "fontSize": {"field": "count"},
          "fontWeight": {"field": "weight"},
          "fontSizeRange": [{"signal": "fontSizeRange0"}, {"signal": "fontSizeRange1"}],
          "padding": {"signal": "wordPadding"},
          "rotate": {"field": "rotate"}
        }
      ]
    }
  ],

  "scales": [
    {
      "name": "color",
      "type": "ordinal",
      "range": ["#d5a928", "#652c90", "#939597"]
    }
  ],

  "marks": [
    {
      "type": "text",
      "from": {"data": "table"},
      "encode": {
        "enter": {
          "text": {"field": "text"},
          "align": {"value": "center"},
          "baseline": {"value": "alphabetic"},
          "fill": {"scale": "color", "field": "text"},
          "font": {"value": "Helvetica Neue, Arial"},
          "fontWeight": {"field": "weight"}
        },
        "update": {
          "x": {"field": "x"},
          "y": {"field": "y"},
          "angle": {"field": "angle"},
          "fontSize": {"field": "fontSize"},
          "fillOpacity": {"value": 1}
        },
        "hover": {
          "fillOpacity": {"value": 0.5}
        }
      }
    }
  ]
    };
    vegaEmbed('#vis2447', vlSpec, opt);
</script>

<h4 id="变换参数"><a href="#变换参数" class="header-anchor">变换参数</a></h4>
<table><tr><th align="left">P</th><th align="left">T</th><th align="left">D</th></tr><tr><td align="left">font</td><td align="left"><code>String|Expr</code></td><td align="left">字体</td></tr><tr><td align="left">fontStyle</td><td align="left"><code>String|Expr</code></td><td align="left">字体样式</td></tr><tr><td align="left">fontWeight</td><td align="left"><code>String|Expr</code></td><td align="left">字体粗细</td></tr><tr><td align="left">fontSize</td><td align="left"><code>Number|Expr</code></td><td align="left">字体大小</td></tr><tr><td align="left">fontSizeRange</td><td align="left"><code>Number&#91;&#93;</code></td><td align="left">大小范围, 如果指定了范围且没指定fontSize,则根据平方根比例在范围内自动缩放</td></tr><tr><td align="left">padding</td><td align="left"><code>Number|Expr</code></td><td align="left">单词的padding</td></tr><tr><td align="left">rotate</td><td align="left"><code>Number|Expr</code></td><td align="left">角度&#40;度为单位&#41;</td></tr><tr><td align="left">text</td><td align="left"><code>Field</code></td><td align="left">文本内容</td></tr><tr><td align="left">size</td><td align="left"><code>Number&#91;&#93;</code></td><td align="left">布局大小, <code>&#91;width, height&#93;</code></td></tr><tr><td align="left">spiral</td><td align="left"><code>String</code></td><td align="left">布局方法, <code>archimedean</code>&#40;默认&#41;或<code>rectangular</code></td></tr><tr><td align="left">as</td><td align="left"><code>String</code></td><td align="left">输出字段, 默认为<code>&#91;&quot;x&quot;, &quot;y&quot;, &quot;font&quot;, &quot;fontSize&quot;, &quot;fontStyle&quot;, &quot;fontWeight&quot;, &quot;angle&quot;&#93;</code></td></tr></table>

<fieldset class="admon admon-note">
<legend class="admon-legend admon-legend-note"> Note</legend>
  wordcloud 要求文本标记具有<code>align:center</code>和<code>baseline: alphabetic</code>属性, 否则文本定位会不准确。 
</fieldset>



</div>
<!-- article style -->


 <hr>

<script src="https://utteranc.es/client.js"
    repo="songtaogui/blog_comments"
    issue-term="pathname"
    theme="github-light"
    crossorigin="anonymous"
    async>
</script>


<hr> 

<div class="container">
    
    <footer class="site-footer">
        <p class="powered-by">
          <script type="text/javascript" src="//rf.revolvermaps.com/0/0/4.js?i=5jnkqismgmy&amp;m=5&amp;h=128&amp;c=baff00&amp;r=0" async="async"></script><br>
            Total visits: <span id="busuanzi_value_site_pv"></span>.<br>
            Built with <a href="https://franklinjl.org" target="_blank" rel="noopener">Franklin.jl</a> and <a
                href="https://julialang.org" target="_blank" rel="noopener">Julia</a>.<br>
            Texts are licensed under <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>.<br>
            Codes are licensed under the <a href="https://mit-license.org/">MIT License</a>.<br>
            <strong>&copy; Songtao Gui</strong>. Last modified: April 25, 2023.
          </p>
    </footer>
    
</div>
</div>


</div>
<!--article container -->
</article>


<!-- CONTENT ENDS HERE -->
 <script src="/libs/katex/katex.min.js"></script>
<script src="/libs/katex/auto-render.min.js"></script>
<script>renderMathInElement(document.body)</script>
<script>
    const options = {
        delimiters: [
            { left: "$$", right: "$$", display: true },
            { left: "$", right: "$", display: false },
            { left: "\\begin{equation}", right: "\\end{equation}", display: true },
            { left: "\\begin{align}", right: "\\end{align}", display: true },
            { left: "\\begin{alignat}", right: "\\end{alignat}", display: true },
            { left: "\\begin{gather}", right: "\\end{gather}", display: true },
            { left: "\\(", right: "\\)", display: false },
            { left: "\\[", right: "\\]", display: true }
        ]
    };
    renderMathInElement(document.body, options);
</script> 
 <script src="/libs/highlight/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();hljs.configure({tabReplace: '    '});</script>
 

<script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js
    integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js
    integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js
    integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script>
<script src="/libs/academic/academic.min.js"></script>
<script src="/libs/pure/ui.js"></script>

</body>


 <a class="js-back-to-top back-to-top-button" href="#">
    <img src="/assets/img/up.svg" style="width: 100px;">
</a>
<!-- <button class="js-back-to-top back-to-top-button" title="BackToTop">︽</button> -->
<script src="https://cdn.staticfile.org/jquery/2.2.4/jquery.min.js"></script>
<script>
    $(function () {
        var $win = $(window);
        var $backToTop = $('.js-back-to-top');
        // 当用户滚动到离顶部100像素时，展示回到顶部按钮
        $win.scroll(function () {
            if ($win.scrollTop() > 100) {
                $backToTop.show();
            } else {
                $backToTop.hide();
            }
        });
        // 当用户点击按钮时，通过动画效果返回头部
        $backToTop.click(function () {
            $('html, body').animate({
                scrollTop: 0
            }, 200);
        });
    });
</script>
<style>
    /* back to top button */
    .back-to-top-button {
        display: none;
        position: fixed;
        width: 50px;
        bottom: 3%;
        right: 3%;
        z-index: 99;
        font-size: 15px;
        border: 0px solid #696969;
        background-color: #fff;
        color: #222222;
        outline: none;
        cursor: pointer;
        padding: 7px;
        border-radius: 40px;
    }

    .back-to-top-button:hover {
        background-color: #c0dbf5;
        color: #fff;
    }
</style> 


<!-- PJAX配置: 先不搞了! -->
<!--   
  <script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script>
  
  <script>
    var pjax = new Pjax({
      elements: "a",
      selectors: [
        "title",
        "meta[name=description]",
        ".the-header",
        ".the-content",
        ".the-sidebar",
      ]
    })
  </script> -->

</html>



